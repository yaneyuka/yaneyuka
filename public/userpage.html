<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>yaneyuka - userpage</title>
  <link rel="icon" type="image/png" href="image/yaneyukaファビコン.png">
  <script src="https://cdn.tailwindcss.com/"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    // ページロード時に認証状態をチェック（Firebase対応版）
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // まずlocalStorageをチェック（Firebase環境対応）
        const currentUser = localStorage.getItem('currentUser');
        
        if (!currentUser) {
          // ログインしていない場合はログインページにリダイレクト
          window.location.href = '/login.html?redirect=userpage.html';
          return;
        }
        
        // サーバーが利用可能な場合のみセッションチェック（ローカル環境用）
        try {
          const response = await fetch('/api/auth-status');
          const data = await response.json();
          
          if (!data.isLoggedIn) {
            localStorage.removeItem('currentUser');
            window.location.href = '/login.html?redirect=userpage.html';
            return;
          }
          
          console.log('ローカル環境: サーバーセッション認証済み:', data.username);
        } catch (error) {
          // Firebase環境ではfetchが失敗するので、localStorageのみで判定
          console.log('Firebase環境: localStorageベース認証を使用:', currentUser);
        }
        
        // ログイン済みの場合は通常の処理を続行
        console.log('ユーザー認証済み:', currentUser);
        
      } catch (error) {
        console.error('認証状態の確認エラー:', error);
        window.location.href = '/login.html?redirect=userpage.html';
      }
    });
  </script>
  <style>
    @font-face {
      font-family: 'Hiragino Kaku Gothic ProN';
      src: url('fonts/LogotypeGothicCondensed.otf') format('opentype');
      font-weight: normal;
      font-style: normal;
    }
    /* Google Custom Searchのスタイル */
    .gsc-control-searchbox-only {
      width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
      display: flex !important;
      flex-direction: row !important;
      background-color: rgb(243 244 246) !important;
    }
    .gsc-search-box { /* 入力欄とボタンのコンテナ */
      width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
      background-color: #3b3b3b !important; /* Set container background to the desired blue */
    }
    .gsc-input-box { /* 入力欄コンテナ */
      width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
      background-color: #FFFFFF !important; /* Override input box background to white */
      border: none !important; /* Remove potential borders */
      box-shadow: none !important; /* Remove potential shadows */
    }
    .gsc-input-box .gsc-input { /* セレクタ変更、高さ調整 */
      width: 100% !important;
      margin: 0 !important;
      padding: 0 8px !important; /* padding追加 */
      background-color: #FFFFFF !important; /* Override input background to white */
      color: #000000 !important; /* Ensure text is visible on white */
      height: 28px !important; /* 高さを28pxに変更 */
      box-sizing: border-box !important; /* box-sizing追加 */
    }
    /* 検索ボタンのスタイル */
    button.gsc-search-button,
    button.gsc-search-button-v2 {
      display: block !important;
      background-color: #6B7280 !important; /* Changed background color to gray-500 */
      border: none !important;
      padding: 0 !important;
      height: 31px !important; /* Match index.html */
      width: 31px !important; /* Match index.html */
      min-width: 31px !important; /* Match index.html */
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      border-radius: 50% !important;
      margin-right: 8px !important;
      margin-left: 4px !important; /* Add left margin like index.html */
      box-shadow: none !important;
      position: relative !important;
      overflow: hidden !important;
    }

    /* 検索ボタン内の画像のスタイル */
    button.gsc-search-button-v2 svg {
      width: 13px !important;
      height: 13px !important;
      margin: 0 !important;
      position: absolute !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
    }

    .gsc-search-button-v2:hover {
      background-color: #4B5563 !important; /* Changed hover background color to gray-600 */
      border-color: #3B8AC4 !important; /* Changed hover border color to match index */
    }
    .gsc-results-wrapper {
      width: 100% !important;
    }
    .gsc-results-wrapper-overlay {
      width: 100% !important;
      left: 0 !important;
      right: 0 !important;
      padding: 30px !important;
      box-sizing: border-box !important;
      top: 180px !important;
      height: calc(100% - 180px) !important;
    }
    /* 追加のスタイル */
    .gsc-control-cse {
      padding: 0 !important;
      margin: 0 !important;
      border: none !important;
      background-color: transparent !important;
    }
    .gsc-control-cse-ja {
      padding: 0 !important;
      margin: 0 !important;
    }
    .gsc-control-wrapper {
      padding: 0 !important;
      margin: 0 !important;
    }
    .gsc-control-cse-ja .gsc-table-result {
      padding: 0 !important;
      margin: 0 !important;
    }
    .gsc-control-cse-ja .gsc-table-result th {
      padding: 0 !important;
      margin: 0 !important;
    }
    .gsc-control-cse-ja .gsc-table-result td {
      padding: 0 !important;
      margin: 0 !important;
    }
    .gsc-modal-background-image {
      background-color: rgba(0, 0, 0, 0.5) !important;
      top: 180px !important;
      height: calc(100% - 180px) !important;
    }
    .gsc-results-close-btn {
      top: 190px !important;
      right: 10px !important;
    }

    /* ナビゲーションバーのスタイル */
    .nav-bar {
      background-color: #00B8A9; /* デフォルトの背景色 */
    }
    .nav-bar a:hover {
      background-color: #7ab5fc; /* ホバー時の背景色 */
    }

    /* メニュー切り替え用のアニメーション */
    section {
      transition: opacity 500ms cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
      position: absolute;
      width: 100%;
      display: none;
    }

    section:not(.hidden) {
      opacity: 1;
      position: relative;
      display: block;
    }

    /* アニメーション用のスタイル */
    .fade-enter {
      opacity: 0;
    }

    .fade-enter-active {
      opacity: 1;
      transition: opacity 500ms ease-in-out;
    }

    .fade-exit {
      opacity: 1;
    }

    .fade-exit-active {
      opacity: 0;
      transition: opacity 500ms ease-in-out;
    }

    /* スクロールバーのスタイル */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* スクロールバーによるレイアウトシフトを防ぐ */
    html {
      overflow-y: scroll;
      scrollbar-gutter: stable;
    }

    /* メインコンテンツエリアのスクロール設定 */
    main {
      overflow-y: auto;
      scrollbar-gutter: stable;
      scrollbar-width: none; /* Firefox用 */
    }

    /* Webkitブラウザ用のスクロールバー非表示 */
    main::-webkit-scrollbar {
      display: none;
    }

    /* コンタクトリストのスクロール設定 */
    #contact-list {
      overflow-y: auto;
      scrollbar-gutter: stable;
    }

    /* 広告エリアのスクロール設定 */
    aside {
      overflow-y: auto;
      scrollbar-gutter: stable;
    }

    /* 既存のスタイル */
    .accordion-content {
      display: none;
      transition: all 0.3s ease;
    }
    
    .accordion-content.active {
      display: block;
    }

    /* スマートフォン用のスタイル */
    @media (max-width: 768px) {
      header {
        margin-bottom: 8px !important;
        padding-bottom: 8px !important;
      }
      nav.nav-bar {
        margin-top: 4px !important; /* ボタン下の余白を狭める */
        margin-bottom: 8px !important; /* 下のマージンも念のため指定 */
      }
      body {
        margin: 0;
        padding: 0;
        font-size: 12px;
      }

      /* サイドバーとメインコンテンツを囲むコンテナのスタイルを確実に適用 */
      /* userpage.html の構造に合わせてセレクタを特定する必要があるかもしれません */
      /* 例: body > div.flex.gap-4 や #main-container など */
      #main-layout-container { /* IDセレクタに変更 */
        display: flex !important; 
        flex-direction: row !important;
        gap: 4px;
        /* 高さを再計算 (ヘッダー約100px + nav約60px + ad約60px を仮定) */
        /* height: calc(100vh - 100px - 60px - 60px); */
        min-height: calc(100vh - 100px - 60px - 60px); /* min-height に変更して試す */
        overflow: hidden;
        position: relative;
        align-items: flex-start; /* 上揃えに */
      }

      #main-layout-container > aside.w-\[150px\] { /* 左サイドバー */
        width: 80px !important;
        min-width: 80px !important;
        flex-shrink: 0 !important;
        height: 100%; /* コンテナの高さに合わせる */
        overflow-y: auto;
        padding: 4px;
        background: #f8f9fa;
        border-right: 1px solid #e9ecef;
      }

      #main-layout-container > main.flex-grow { /* 中央メインコンテンツ */
        width: calc(100% - 80px - 4px) !important;
        margin-right: 0 !important;
        flex-grow: 1 !important;
        height: 100%; /* コンテナの高さに合わせる */
        overflow-y: auto;
        padding: 4px;
        margin-top: 0 !important; /* 上の空間を削除 */
      }

      aside.w-\[225px\] { /* 右広告サイドバーは非表示 */
        display: none;
      }

      /* 広告エリアの調整 (下部固定) */
      .ad-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        padding: 4px;
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
        z-index: 10;
        height: 60px; /* 広告エリアの高さを指定 */
      }

      /* 左サイドバーのボタン調整 */
      .accordion-toggle {
        font-size: 10px; /* フォントサイズを少し戻す */
        padding: 8px 4px; /* パディングを調整 */
        white-space: normal;
        text-align: center; /* 中央揃えに変更 */
        width: 100%;
      }

      /* メインコンテンツの調整 */
      section {
        padding: 8px 4px; /* 上下のパディングを少し増やす */
        width: 100%;
      }

      section h2, section h3 { /* 見出し要素 */
        font-size: 14px; /* 見出しフォントサイズ */
        margin-bottom: 8px !important; /* 見出し下のマージンを縮小 */
        margin-top: 0 !important; /* 見出し上のマージンを削除 */
      }

      /* "+法規追加" のようなボタン */
      #my-houki .bg-blue-500, 
      #my-tasks .bg-blue-500, 
      #team-tasks .bg-blue-500, 
      #contact-list-section .bg-blue-500 { /* 他のセクションのボタンも考慮 */
        margin-top: 8px !important; /* 見出しとの間隔を調整 */
      }

      /* 入力フィールドとボタンの調整 */
      input, select, textarea {
        font-size: 11px;
        padding: 4px;
      }

      button {
        font-size: 11px;
        padding: 4px 8px;
      }
    }

    /* タッチデバイス用のスタイル */
    @media (hover: none) {
      .accordion-toggle,
      .nav-bar a,
      .tool-buttons button {
        padding: 10px 15px;
      }

      .tool-content input[type="number"],
      .tool-content select,
      .tool-content button {
        padding: 10px;
      }

      .user-info input[type="text"],
      .user-info input[type="email"],
      .user-info input[type="password"] {
        padding: 10px;
      }

      .user-info button {
        padding: 10px 20px;
      }
    }

    .opacity-0 {
      opacity: 0;
    }
    .translate-y-4 {
      transform: translateY(1rem);
    }
    .transition-all {
      transition-property: all;
    }
    .duration-500 {
      transition-duration: 500ms;
    }

    .calculator-btn {
      @apply p-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors;
    }

    /* レスポンシブ対応 */
    @media (max-width: 768px) {
      .gsc-control-searchbox-only {
        flex-direction: column !important;
      }
      .gsc-search-button,
      .gsc-search-button-v2 {
        width: 100% !important;
        margin: 8px 0 !important;
      }
    }

    /* スマートフォン表示でのヘッダー調整 */
    @media (max-width: 768px) {
      header .flex.flex-col.items-center.mt-4.relative { /* 検索バーとボタンのコンテナ */
        flex-direction: column;
        align-items: stretch; 
        position: static; 
        margin-top: 16px; 
      }

      header .w-full.max-w-2xl { /* 検索バーラッパー */
        max-width: 100%; 
      }

      header .absolute.right-0.flex.gap-2 { /* ボタンコンテナ */
        position: static; 
        margin-top: 8px; 
        justify-content: flex-end; 
      }

      /* ヘッダー上部のリンクコンテナの調整 */
      header .flex.flex-col.items-start { /* リンクの親コンテナ */
        width: 100%; /* 親コンテナを幅いっぱいに */
        align-items: flex-start; /* align-items: flex-end; を削除または変更 */
      }

      header .flex.flex-col.items-start .flex.gap-4 { /* リンク自体のコンテナ */
         width: 100%; /* コンテナ幅を100%に */
         margin-top: 4px; 
         justify-content: flex-end; /* この要素内のリンクを右寄せ */
      }
    }

    /* ヘッダー内のリンクを右寄せ (削除) */
    /* header .flex.flex-col.items-start .flex.gap-4 {
      justify-content: flex-end; 
      width: 100%; 
    } */

    /* カレンダー用スタイル */
    .main-layout {
        display: flex;
        margin: 0 auto;
        gap: 15px;
        align-items: stretch;
    }
    
    .today-view {
        flex: 0 0 200px; /* 幅を300pxから200pxに変更 */
        display: flex;
        flex-direction: column;
    }
    
    .today-category-wrapper {
        background-color: #f3f4f6; /* 背景色をグレーに変更 (Tailwind gray-100) */
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        padding: 15px;
        box-sizing: border-box;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        border: 1px solid #d1d5db; /* 枠線を追加 (Tailwind gray-300) */
    }
    
    .today-view h2 {
        margin-top: 0;
        font-size: 0.9rem; /* 1.0remから縮小 */
        color: #4a6fa5;
        border-bottom: 1px solid #eee;
        padding-bottom: 6px; /* 少し縮小 */
        margin-bottom: 8px; /* 少し縮小 */
    }
    
    .today-view-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .today-nav-button {
        background: none;
        border: none;
        color: #4a6fa5;
        font-size: 1rem;
        cursor: pointer;
        padding: 0;
        border-radius: 50%;
        transition: background-color 0.3s;
        width: 26px;
        height: 26px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .today-nav-button:hover {
        background-color: #e6f2ff;
    }
    
    .today-date {
        font-size: 0.75rem; /* 0.9remからさらに縮小 */
        font-weight: bold;
        color: #555;
        margin: 0 3px; /* 左右マージンも少し縮小 */
        white-space: nowrap; /* 強制的に一行にする */
        overflow: hidden; /* はみ出した場合に隠す */
        text-overflow: ellipsis; /* はみ出した場合に省略記号 */
    }
    
    #today-events {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 350px;
        overflow-y: auto;
    }
    
    #today-events li {
        background-color: #f8f9fa;
        border-radius: 4px;
        padding: 6px; /* 少し縮小 */
        margin-bottom: 5px; /* 少し縮小 */
        font-size: 0.75rem; /* 0.85remから縮小 */
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    #today-events li:hover {
        background-color: #e9ecef;
    }
    
    #today-events .event-time {
        font-weight: bold;
        margin-right: 4px;
        color: #4a6fa5;
        /* font-size は親 li から継承 */
    }
    
    #today-events .event-title {
        display: inline;
        /* font-size は親 li から継承 */
    }
    
    #today-events .event-category {
        display: block;
        font-size: 0.7rem; /* 0.75remから縮小 */
        color: #777;
        margin-top: 2px; /* 少し縮小 */
    }
    
    #today-events .no-events {
        color: #888;
        font-style: italic;
        text-align: center;
        padding: 10px 0;
        background-color: transparent;
        cursor: default;
    }
    #today-events .no-events:hover {
         background-color: transparent;
    }
    
    .calendar-container {
        flex: 1 1 auto;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        background-color: white;
        border-radius: 8px;
        border: 1px solid #d0d7de;
    }
    
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background-color: white;
        color: black;
        border-radius: 0;
    }
    
    .nav-button {
        background: none;
        border: none;
        color: black;
        font-size: 1rem;
        cursor: pointer;
        padding: 5px 8px;
        border-radius: 5px;
        transition: background-color 0.3s;
    }
    
    .nav-button:hover {
        background-color: rgba(0, 0, 0, 0.1);
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: 3fr 3fr 3fr 3fr 3fr 2fr 2fr; /* Mon-Fri: 3fr, Sat-Sun: 2fr */
        padding: 5px;
        border-top: 1px solid #eee;
    }
    
    .day-header {
        text-align: left;
        font-weight: bold;
        padding: 8px 5px;
        border-bottom: 1px solid #eee;
        background-color: #f8f9fa;
        font-size: 0.8rem;
    }
    
    .saturday-header {
        color: #1976D2; /* Desaturated blue */
    }
    
    .sunday-header {
        color: #D32F2F; /* Desaturated red */
    }
    
    .day-cell {
        min-height: 110px;
        padding: 5px;
        border: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 0.8rem;
        position: relative;
        box-sizing: border-box;
        overflow: hidden;
    }
    
    .day-cell:hover {
        background-color: #f0f4f8;
    }
    
    .day-number {
        font-weight: bold;
        margin-bottom: 3px;
        display: block;
        text-align: left;
    }
    
    .day-number.sunday {
        color: #D32F2F; /* Desaturated red */
    }
    
    .day-number.saturday {
        color: #1976D2; /* Desaturated blue */
    }
    
    .today {
        background-color: #e6f2ff;
        font-weight: bold;
        border: 2px solid #003366;
    }
    
    .other-month {
        color: #aaa;
        background-color: #f9f9f9;
    }
    
    .past-day:not(.other-month):not(.today) {
        background-color: #f0f0f0;
        color: #999;
        cursor: default;
    }
    .past-day:not(.other-month):not(.today):hover { 
        background-color: #e5e5e5; 
    }
   
    .event-list {
        margin-top: 4px;
        font-size: 0.75rem;
        max-height: 80px;
        overflow: hidden;
    }
    
    .event-item {
        padding: 1px 4px;
        margin-bottom: 2px;
        background-color: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .event-count {
         position: absolute;
         bottom: 3px;
         right: 3px;
         font-size: 0.7rem;
         color: #888;
         background: rgba(255, 255, 255, 0.7);
         padding: 0 3px;
         border-radius: 2px;
    }
    
    .event-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }
    
    .event-modal-content {
        background-color: white;
        padding: 15px;
        border-radius: 8px;
        width: 90%;
        max-width: 450px;
    }

    .event-modal-content h2 {
        font-size: 1.3rem;
        margin-top: 0;
        margin-bottom: 15px;
        color: #4a6fa5;
    }
    
    .event-form {
        display: flex;
        flex-direction: column;
    }
    
    .form-group {
        margin-bottom: 10px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 4px;
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .form-group input, .form-group textarea, .form-group select {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 0.9rem;
        resize: none; /* Disable resizing for textarea */
    }
    
    .modal-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
    }
    
    .btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .btn-primary {
        background-color: #4a6fa5;
        color: white;
    }
    
    .btn-delete {
        background-color: #ff6b6b;
        color: white;
    }
    
    .btn-cancel {
        background-color: #ddd;
        color: #333;
    }
    
    .today-btn {
        margin-left: 10px;
        background-color: rgba(255, 255, 255, 0.2);
    }

    .month-year-selector { 
        display: flex;
        align-items: center;
    }
    
    .calendar-header select {
        margin: 0 5px;
        padding: 4px 6px;
        border-radius: 4px;
        border: 1px solid #ddd;
        background-color: white;
        color: black;
        font-size: 1rem;
    }
    
    .calendar-header select option {
         color: #333;
         background-color: white;
    }
    
    .todo-list-container {
        flex: 0 0 225px;
        padding: 15px;
        background-color: #f3f4f6; /* 背景色をグレーに変更 (Tailwind gray-100) */
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        border: 1px solid #d1d5db; /* 枠線を追加 (Tailwind gray-300) */
    }

    .todo-list-container h3 {
        margin-top: 0;
        color: #4a6fa5;
        border-bottom: 1px solid #eee;
        padding-bottom: 6px; /* 少し縮小 */
        margin-bottom: 8px; /* 少し縮小 */
        font-size: 0.9rem; /* 1.0remから縮小 */
    }

    .todo-input-group {
        display: flex;
        margin-bottom: 10px;
    }

    #todo-input {
        flex-grow: 1;
        padding: 4px 6px;
        border: 1px solid #ddd;
        border-radius: 4px 0 0 4px;
        margin-right: -1px;
        font-size: 0.75rem; /* 0.8remから縮小 */
        box-sizing: border-box; 
    }

    #add-todo-btn {
        padding: 4px 8px;
        background-color: #4a6fa5;
        color: white;
        border: none;
        border-radius: 0 4px 4px 0;
        cursor: pointer;
        font-weight: bold;
        font-size: 0.75rem; /* 0.8remから縮小 */
        transition: background-color 0.3s;
        box-sizing: border-box; 
    }
    #add-todo-btn:hover {
        background-color: #3b5998;
    }

    #todo-list {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 400px;
        overflow-y: auto;
    }

    #todo-list li {
        display: flex;
        align-items: center;
        padding: 6px 0; /* 少し縮小 */
        border-bottom: 1px solid #eee;
        font-size: 0.8rem; /* 0.9remから縮小 */
    }
    #todo-list li:last-child {
        border-bottom: none;
    }

    #todo-list .todo-text {
        flex-grow: 1;
        margin: 0 8px;
        cursor: pointer;
        font-size: 0.75rem; /* 0.8remから縮小 */
    }

    #todo-list .todo-text.completed {
        text-decoration: line-through;
        color: #888;
    }

    #todo-list .todo-actions button {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 0.8rem; /* 0.9remから縮小 */
        padding: 4px; /* 少し縮小 */
        margin-left: 4px; /* 少し縮小 */
        color: #aaa;
        transition: color 0.2s;
        line-height: 1;
    }
    #todo-list .todo-actions .toggle-btn {
        color: #6fbf73; 
    }
    #todo-list .todo-actions .toggle-btn.completed {
         color: #ffb347; 
    }
    #todo-list .todo-actions .delete-btn {
        color: #ff6b6b; 
    }

    #todo-list .todo-actions button:hover {
        color: #555;
    }
    #todo-list .no-events {
         justify-content: center;
         color: #888;
         font-style: italic;
         padding: 10px 0;
         cursor: default;
    }
      
    .category-1 { background-color: #fffae6; border-left: 3px solid #ffcc00; }
    .category-2 { background-color: #e6f7ff; border-left: 3px solid #1890ff; } 
    .category-3 { background-color: #f6ffed; border-left: 3px solid #52c41a; } 
    .category-4 { background-color: #fff0f6; border-left: 3px solid #eb2f96; } 

    #today-events .category-1 { background-color: #fffae6; border-left: 3px solid #ffcc00; }
    #today-events .category-2 { background-color: #e6f7ff; border-left: 3px solid #1890ff; } 
    #today-events .category-3 { background-color: #f6ffed; border-left: 3px solid #52c41a; } 
    #today-events .category-4 { background-color: #fff0f6; border-left: 3px solid #eb2f96; }
    
    .time-group {
         display: flex;
         gap: 15px;
    }
    .time-group > div {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .time-selects {
        display: flex;
        gap: 5px;
    }

    .time-selects select {
        flex: 1;
    }
    
    @media (max-width: 1200px) {
        .main-layout {
            flex-direction: column;
        }
        .today-view,
        .calendar-container,
        .todo-list-container {
            width: 100%;
            max-width: none;
            margin: 0 auto 15px auto;
        }
        .todo-list-container {
            margin-bottom: 0;
        }
    }
    
    @media (max-width: 768px) {
        .calendar-container {
            max-width: 100%;
            border-radius: 0;
        }
        
        .day-cell {
            min-height: 60px;
            padding: 4px; 
            font-size: 0.75rem;
        }
        .day-header {
             font-size: 0.7rem;
             padding: 6px 3px;
        }
        .event-list {
             max-height: 30px;
        }
    }

    /* --- ▼▼▼ カテゴリ管理スタイル ▼▼▼ --- */
#category-manager {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

.category-manager-header {
     display: flex;
     justify-content: flex-start; /* Align items to the left */
     align-items: center;
     cursor: pointer; /* Make header clickable */
     margin-bottom: 10px;
}

#category-manager h3 {
    font-size: 0.9rem;
    color: #4a6fa5;
    margin: 0; /* Removed margins */
}

.toggle-button {
     background: none;
     border: none;
     font-size: 0.8rem; /* Make icon smaller */
     cursor: pointer;
     color: #666;
     padding: 0 5px 0 0; /* Reduced right padding */
     line-height: 1;
     display: inline-flex; /* Align icon better */
     align-items: center;
}
.toggle-button::before {
     content: '\25B6'; /* Right-pointing triangle */
     display: inline-block;
     transition: transform 0.2s ease-in-out;
     transform: rotate(0deg);
 }
 #category-manager.open .toggle-button::before {
     transform: rotate(90deg); /* Down-pointing triangle */
 }

.collapsible-content { /* Initially hidden content */
     display: none;
     padding-top: 10px; /* Add some space when open */
}

#category-manager.open .collapsible-content { /* Show content when open */
     display: block;
}

#category-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 10px;
}

#category-name-input {
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.9rem;
}

#color-palette {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-bottom: 10px;
}

.color-swatch {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: border-color 0.2s;
}

.color-swatch.selected {
    border-color: #4a6fa5; /* Highlight selected color */
    box-shadow: 0 0 0 2px white, 0 0 0 4px #4a6fa5;
}

#add-category-btn {
    padding: 6px 10px;
    font-size: 0.85rem;
    background-color: #6fbf73; /* Green color for add */
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    align-self: flex-start; /* Align button left */
    transition: background-color 0.3s;
}
#add-category-btn:hover {
    background-color: #5aae61;
}

#category-list {
    list-style: none;
    padding: 0;
    margin: 10px 0 0 0;
    max-height: 150px;
    overflow-y: auto;
}

#category-list li {
    display: flex;
    align-items: center;
    font-size: 0.85rem;
    padding: 5px 0;
    border-bottom: 1px solid #f0f0f0;
    justify-content: space-between;
}
 #category-list li:last-child {
     border-bottom: none;
 }

.category-list-color {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    margin-right: 8px;
    flex-shrink: 0;
}

.category-list-name {
    flex-grow: 1;
    margin: 0 8px;
}

.category-list-actions {
    display: flex;
    align-items: center;
    gap: 5px;
    flex-shrink: 0;
}

.edit-category-btn,
.delete-category-btn {
     background: none;
     border: none;
     color: #ff6b6b; /* Default delete color */
     cursor: pointer;
     font-size: 0.9rem;
     padding: 2px 4px;
     line-height: 1;
     transition: color 0.2s;
}
/* Use a different color for edit */
 .edit-category-btn {
      color: #4a6fa5; /* Example edit color */
 }

.edit-category-btn:hover,
.delete-category-btn:hover {
     color: #555;
}
/* --- ▲▲▲ カテゴリ管理スタイル ▲▲▲ --- */
  </style>

  <!-- Add CSS to hide number input spinners -->
  <style>
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        appearance: none;
        margin: 0;
    }
    input[type="number"] {
        -moz-appearance: textfield; /* Firefox */
        appearance: textfield;
    }
  </style>
</head>
<body class="bg-white text-gray-600 text-sm" style="font-family: 'Logotype Gothic Condensed', sans-serif;">
  <header class="relative border-gray-300 mb-2"> <!-- mb-2 は後で nav に mb-4 をつけるため維持 -->
    <div class="relative bg-[#3b3b3b] pt-4 pb-4 px-4"> <!-- 背景色とパディング変更 -->
      <!-- Links Div (Absolute Positioned) -->
      <div class="absolute top-2 right-4"> <!-- 絶対配置に変更 -->
        <div class="flex gap-4 text-[11px] text-white"> <!-- 文字色白に変更 -->
          <!-- USER PAGE リンクは index.html からの遷移なのでここでは削除も検討 -->
          <!-- <a href="userpage.html" class="hover:underline">userpage</a> -->
          <a href="#" onclick="showRegister()" class="hover:underline">新規会員登録</a>
          <a href="#" onclick="showPublishForm(event)" class="hover:underline">掲載希望はコチラ</a>
          <a href="#" onclick="showFeedbackForm(event)" class="hover:underline">ご意見・ご要望</a>
          <a href="#" id="authButton" onclick="showLogin()" class="hover:underline">login</a> <!-- loginボタンをここに統合 -->
        </div>
      </div>

      <!-- Logo/Desc Div -->
      <div class="flex flex-col items-start gap-2"> <!-- items-start に変更 -->
        <div class="flex items-end gap-2">
          <a href="index.html">
            <img src="image/yaneyukaロゴ3.png" alt="yaneyuka" class="h-12"> <!-- ロゴ変更、サイズ調整 -->
          </a>
          <p class="text-[9pt] text-white">～建築土木の総合情報サイト～</p> <!-- 文字色白に変更 -->
        </div>
      </div>

      <!-- Search Div -->
      <div class="flex flex-col items-center mt-4 relative"> <!-- mt-4 は維持 -->
        <div class="w-full max-w-2xl">
          <script async src="https://cse.google.com/cse.js?cx=926ccd1b95a9649b8"></script>
          <div class="gcse-search" data-linktarget="_blank"></div>
        </div>
        <!-- 絶対配置のボタンは削除 -->
      </div>
    </div>
    
    <!-- ナビゲーションバーのスタイル変更 -->
    <nav class="flex flex-wrap md:flex-nowrap overflow-x-auto whitespace-nowrap text-gray-100 text-sm mb-4" style="background-color: #1dad95;">
      <a href="index.html?page=topix" class="nav-item px-4 py-2 hover:bg-gray-200 transition cursor-pointer md:ml-[110pt]">Toppage</a>
      <a href="index.html?page=event" class="nav-item px-4 py-2 hover:bg-gray-200 transition cursor-pointer">イベント情報</a>
      <a href="index.html?page=new" class="nav-item px-4 py-2 hover:bg-gray-200 transition cursor-pointer">新商品</a>
      <a href="index.html?page=book" class="nav-item px-4 py-2 hover:bg-gray-200 transition cursor-pointer">書籍・ソフト</a>
      <a href="index.html?page=houki" class="nav-item px-4 py-2 hover:bg-gray-200 transition cursor-pointer">法規</a>
      <a href="index.html?page=cad" class="nav-item px-4 py-2 hover:bg-gray-200 transition cursor-pointer">添景・CAD</a>
      <a href="index.html?page=project" class="nav-item px-4 py-2 hover:bg-gray-200 transition cursor-pointer">プロジェクト</a>
      <a href="index.html?page=company" class="nav-item px-4 py-2 hover:bg-gray-200 transition cursor-pointer">施工会社</a>
      <a href="index.html?page=office" class="nav-item px-4 py-2 hover:bg-gray-200 transition cursor-pointer">設計事務所</a>
      <a href="index.html?page=job" class="nav-item px-4 py-2 hover:bg-gray-200 transition cursor-pointer">求人情報</a>
    </nav>
  </header>

  <!-- メインコンテンツエリアのコンテナを修正 -->
  <div id="main-layout-container" class="flex p-4">
    <!-- 左サイドバー：Usertools -->
    <aside class="w-[150px] shrink-0 text-[14px] mr-4">
      <button class="text-lg font-semibold mb-2 cursor-pointer" onclick="showTodo()">Usertools</button> <!-- onclick を showTodo() に変更 -->
      <div class="space-y-0">
        <div>
          <button class="w-full text-left px-4 py-2 cursor-pointer accordion-toggle text-[13px] text-gray-600" onclick="showMyCalendar()">Myカレンダー</button>
        </div>
        <div>
          <button class="w-full text-left px-4 py-2 cursor-pointer accordion-toggle text-[13px] text-gray-600" onclick="showMyHouki()">My法規</button>
        </div>
        <div>
          <button class="w-full text-left px-4 py-2 cursor-pointer accordion-toggle text-[13px] text-gray-600" onclick="showTodo()">Myタスク</button>
        </div>
        <div>
          <button class="w-full text-left px-4 py-2 cursor-pointer accordion-toggle text-[13px] text-gray-600" onclick="showTeamTodo()">Teamタスク</button>
        </div>
        <!-- 「ツール」を「一般ツール」と「設計ツール」に分割 -->
        <div>
          <button class="w-full text-left px-4 py-2 cursor-pointer accordion-toggle text-[13px] text-gray-600" onclick="showGeneralTools()">一般ツール</button>
        </div>
        <div>
          <button class="w-full text-left px-4 py-2 cursor-pointer accordion-toggle text-[13px] text-gray-600" onclick="showDesignTools()">設計ツール</button>
        </div>
        <div>
          <button class="w-full text-left px-4 py-2 cursor-pointer accordion-toggle text-[13px] text-gray-600" onclick="toggleSection('contact-area')">担当連絡先</button>
        </div>
        <div>
          <button class="w-full text-left px-4 py-2 cursor-pointer accordion-toggle text-[13px] text-gray-600" onclick="showSettings()">設定</button>
        </div>
      </div>
    </aside>

    <!-- 中央カラム：メインコンテンツ -->
    <main class="flex-grow mr-4">
      <div id="content-area" class="transition-opacity duration-500 opacity-100">
        <!-- 設定パネル -->
        <section id="settings-area" class="hidden">
          <div class="flex items-center gap-4 mb-4">
            <h2 class="text-base font-semibold">設定</h2>
          </div>
          <div class="bg-white p-6 rounded-lg max-w-md">
            <!-- データ管理セクション -->
            <div class="bg-white p-6 rounded-lg max-w-md mt-4">
              <h3 class="text-sm font-semibold mb-3">データ管理</h3>
              
              <!-- 保存状況表示 -->
              <div class="bg-gray-50 p-3 rounded mb-4">
                <div class="flex justify-between items-center mb-2">
                  <span class="text-xs text-gray-600">最終保存:</span>
                  <span id="last-saved-time" class="text-xs text-gray-500">-</span>
                </div>
                <div class="save-status text-[10px] text-gray-500" id="main-save-status">準備完了</div>
              </div>
              
              <!-- 手動保存 -->
              <button onclick="manualSave()" class="w-full bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 transition mb-3">
                📁 今すぐ保存
              </button>
              
              <!-- 自動保存設定 -->
              <div class="flex items-center justify-between mb-4">
                <label class="text-sm text-gray-600">自動保存:</label>
                <div class="flex items-center gap-2">
                  <select id="auto-save-interval" onchange="updateAutoSaveInterval()" class="text-xs border rounded px-2 py-1">
                    <option value="0">無効</option>
                    <option value="1">1分</option>
                    <option value="5" selected>5分</option>
                    <option value="10">10分</option>
                    <option value="30">30分</option>
                  </select>
                </div>
              </div>
              
              <!-- エクスポート・インポート -->
              <div class="flex gap-2">
                <button onclick="exportData()" class="flex-1 bg-green-500 text-white px-3 py-2 rounded text-xs hover:bg-green-600 transition">
                  📤 エクスポート
                </button>
                <label class="flex-1 bg-purple-500 text-white px-3 py-2 rounded text-xs hover:bg-purple-600 transition cursor-pointer text-center">
                  📥 インポート
                  <input type="file" accept=".json" onchange="importData(event)" class="hidden">
                </label>
              </div>
              
              <!-- 使用方法説明 -->
              <div class="mt-4 p-3 bg-blue-50 rounded">
                <h4 class="text-xs font-medium text-blue-800 mb-1">使用方法</h4>
                <ul class="text-[10px] text-blue-700 space-y-1">
                  <li>• エクスポート: データをJSONファイルでダウンロード</li>
                  <li>• インポート: バックアップファイルからデータを復元</li>
                  <li>• 自動保存: 設定した間隔で自動的にデータを保存</li>
                </ul>
              </div>
            </div>
            <!-- ★★★ ここまで追加 ★★★ -->

          </div>
        </section>
      </div>
      <!-- 担当連絡先セクション -->
      <section id="contact-area" class="hidden">
        <div class="flex items-center gap-4">
          <h2 class="text-base font-semibold">担当連絡先</h2>
          <div class="flex gap-2 items-center">
            <input type="text" 
              placeholder="会社名や氏名で検索..." 
              oninput="searchContacts(this.value)" 
              class="border rounded px-2 py-1 text-xs w-[200px]" />
            <button onclick="clearSearch()" 
              class="text-xs bg-gray-500 text-white px-2 py-1 rounded">
              検索クリア
            </button>
          </div>
          </div>
        <div class="mt-2">
          <button onclick="addContact()" 
            class="text-xs bg-blue-500 text-white px-2 py-1 rounded w-fit">
            +連絡先追加
          </button>
          <div id="contact-list" class="flex flex-wrap gap-2 mt-2"></div>
        </div>
      </section>

      <!-- ユーザー名入力セクション -->
      <!-- <section id="user-input-section">
        <label for="username" class="block mb-1 font-semibold">ユーザー名を入力して開始：</label>
        <input id="username" placeholder="ユーザー名" class="p-2 border w-full max-w-md mb-2" />
        <button onclick="enterUser()" class="bg-blue-500 text-white px-4 py-2 rounded">開始</button>
      </section> -->

      <!-- TODOリストセクション -->
      <section id="user-area" class="hidden">
        <div class="flex items-center gap-4">
          <h2 class="text-base font-semibold">Myタスク</h2>
        </div>
        <div class="mt-2">
          <div class="flex gap-2 mb-2">
            <button onclick="showProjectForm()" class="text-xs bg-green-500 text-white px-2 py-1 rounded w-fit">+プロジェクト登録</button>
            <button onclick="toggleTodoForm()" class="text-xs bg-blue-500 text-white px-2 py-1 rounded w-fit">+タスク追加</button>
          </div>
          
          <!-- プロジェクト登録フォーム（デフォルトで非表示） -->
          <form id="projectForm" onsubmit="addProject(event)" class="hidden mb-4">
            <div class="flex items-center gap-2 bg-white p-3 rounded-lg">
              <input id="newProjectName" required placeholder="新規プロジェクト名" class="border rounded px-2 py-1 text-xs" />
              <button type="submit" class="text-xs bg-green-500 text-white px-3 py-1 rounded">登録</button>
              <button type="button" onclick="toggleProjectForm()" class="text-xs bg-gray-500 text-white px-3 py-1 rounded">キャンセル</button>
            </div>
          </form>

          <!-- タスク入力フォーム（デフォルトで非表示） -->
          <form id="todoForm" onsubmit="addTodo(event)" class="hidden mb-4">
            <div class="flex items-center gap-2 bg-white p-3 rounded-lg max-w-[800px]">
              <div class="w-[20%]">
                <select id="todoProject" required class="w-full border rounded px-2 py-1 text-xs">
                  <option value="">プロジェクトを選択</option>
                </select>
              </div>
              <div class="w-[18%]">
                <input type="date" id="dueDate" required class="w-full border rounded px-2 py-1 text-xs" />
              </div>
              <div class="w-[15%]">
                <select id="todoPriority" required class="w-full border rounded px-2 py-1 text-xs">
                  <option value="">重要度</option>
                  <option value="high">高</option>
                  <option value="medium">中</option>
                  <option value="low">低</option>
                </select>
              </div>
              <div class="flex-grow">
                <input id="todoText" required placeholder="タスクの内容" class="w-full border rounded px-2 py-1 text-xs" />
              </div>
              <div class="flex gap-1 h-[28px]">
                <button type="button" onclick="toggleTodoForm()" class="text-xs bg-gray-500 text-white px-3 py-1 rounded h-full">キャンセル</button>
                <button type="submit" class="text-xs bg-blue-500 text-white px-3 py-1 rounded h-full">保存</button>
              </div>
            </div>
          </form>

          <!-- タスクリスト -->
          <div id="projectTodoLists" class="grid grid-cols-4 gap-3"></div>
        </div>
      </section>

      <!-- チームタスクセクション -->
      <section id="team-area" class="hidden">
        <div class="flex items-center gap-4">
          <h2 class="text-base font-semibold">Teamタスク</h2>
        </div>
        <div class="mt-2">
          <div class="flex gap-2 mb-2">
            <button onclick="showTeamProjectForm()" class="text-xs bg-green-500 text-white px-2 py-1 rounded w-fit">+プロジェクト登録</button>
            <button onclick="toggleTeamTodoForm()" class="text-xs bg-blue-500 text-white px-2 py-1 rounded w-fit">+タスク追加</button>
            <button onclick="showShareProjectForm()" class="text-xs bg-purple-500 text-white px-2 py-1 rounded w-fit">プロジェクト共有設定</button>
          </div>
          
          <!-- プロジェクト共有設定フォーム（デフォルトで非表示） -->
          <form id="shareProjectForm" class="hidden mb-4">
            <div class="bg-white p-3 rounded-lg">
              <h3 class="text-sm font-semibold mb-2">プロジェクト共有設定</h3>
              <div class="space-y-3">
                <div>
                  <label class="block text-xs text-gray-600 mb-1">プロジェクトを選択</label>
                  <select id="shareProjectSelect" class="w-full border rounded px-2 py-1 text-xs">
                    <option value="">選択してください</option>
                  </select>
                </div>
                <div>
                  <label class="block text-xs text-gray-600 mb-1">共有するユーザー</label>
                  <div class="flex gap-2">
                    <input type="text" id="shareUserInput" placeholder="ユーザー名" class="flex-grow border rounded px-2 py-1 text-xs" />
                    <button type="button" onclick="addShareUser()" class="text-xs bg-blue-500 text-white px-3 py-1 rounded">追加</button>
                  </div>
                </div>
                <div id="sharedUsersList" class="space-y-1">
                  <!-- 共有ユーザーリストがここに表示されます -->
                </div>
                <div class="flex justify-end gap-2 mt-3">
                  <button type="button" onclick="toggleShareProjectForm()" class="text-xs bg-gray-500 text-white px-3 py-1 rounded">キャンセル</button>
                  <button type="button" onclick="saveShareSettings()" class="text-xs bg-blue-500 text-white px-3 py-1 rounded">保存</button>
                </div>
              </div>
            </div>
          </form>

          <!-- チームプロジェクト登録フォーム（デフォルトで非表示） -->
          <form id="teamProjectForm" onsubmit="addTeamProject(event)" class="hidden mb-4">
            <div class="flex items-center gap-2 bg-white p-3 rounded-lg">
              <input id="newTeamProjectName" required placeholder="新規プロジェクト名" class="border rounded px-2 py-1 text-xs" />
              <button type="submit" class="text-xs bg-green-500 text-white px-3 py-1 rounded">登録</button>
              <button type="button" onclick="toggleTeamProjectForm()" class="text-xs bg-gray-500 text-white px-3 py-1 rounded">キャンセル</button>
            </div>
          </form>

          <!-- チームタスク入力フォーム（デフォルトで非表示） -->
          <form id="teamTodoForm" onsubmit="addTeamTodo(event)" class="hidden mb-4">
            <div class="flex items-center gap-2 bg-white p-3 rounded-lg max-w-[800px]">
              <div class="w-[20%]">
                <select id="teamTodoProject" required class="w-full border rounded px-2 py-1 text-xs">
                  <option value="">プロジェクトを選択</option>
                </select>
              </div>
              <div class="w-[18%]">
                <input type="date" id="teamDueDate" required class="w-full border rounded px-2 py-1 text-xs" />
              </div>
              <div class="w-[15%]">
                <select id="teamTodoPriority" required class="w-full border rounded px-2 py-1 text-xs">
                  <option value="">重要度</option>
                  <option value="high">高</option>
                  <option value="medium">中</option>
                  <option value="low">低</option>
                </select>
              </div>
              <div class="flex-grow">
                <input id="teamTodoText" required placeholder="タスクの内容" class="w-full border rounded px-2 py-1 text-xs" />
              </div>
              <div class="flex gap-1 h-[28px]">
                <button type="button" onclick="toggleTeamTodoForm()" class="text-xs bg-gray-500 text-white px-3 py-1 rounded h-full">キャンセル</button>
                <button type="submit" class="text-xs bg-blue-500 text-white px-3 py-1 rounded h-full">保存</button>
              </div>
            </div>
          </form>

          <!-- チームタスクリスト -->
          <div id="teamProjectTodoLists" class="grid grid-cols-4 gap-3"></div>
        </div>
      </section>

      <!-- Myカレンダーセクション -->
      <section id="calendar-area" class="hidden">
        <div class="flex items-center gap-4">
          <h2 class="text-base font-semibold"></h2>
        </div>
        <div class="mt-4 bg-white rounded-lg shadow-sm">
          <div class="main-layout">
            <div class="today-view" id="today-view">
              <div class="today-category-wrapper">
                <h2>本日の予定</h2>
                <div class="today-view-header">
                  <button id="prev-day-view" class="today-nav-button">&#10094;</button>
                  <div class="today-date" id="today-date"></div>
                  <button id="next-day-view" class="today-nav-button">&#10095;</button>
                </div>
                <ul id="today-events">
                  <!-- Today's events will be loaded here by JavaScript -->
                </ul>
        
        <!-- --- ▼▼▼ カテゴリ管理HTML ▼▼▼ --- -->
<div id="category-manager">
  <div class="category-manager-header" id="category-manager-header">
    <button id="toggle-category-manager" class="toggle-button" title="開閉"></button>
    <h3>カテゴリー管理</h3>
  </div>
  <div id="category-manager-content" class="collapsible-content overflow-hidden">
    <div id="category-form" class="space-y-2">
      <input type="text" id="category-name-input" placeholder="新しいカテゴリ名" class="w-full border rounded px-2 py-1 text-xs focus:outline-none focus:border-gray-400">
      <div id="color-palette" class="flex flex-wrap gap-1 py-1 px-2">
        <!-- Color swatches will be added by JS -->
      </div>
      <button id="add-category-btn" class="w-full text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded transition">カテゴリ追加</button>
    </div>
    <ul id="category-list" class="mt-3 max-h-40 overflow-y-auto space-y-1 pr-1">
      <!-- Category list will be added by JS -->
    </ul>
  </div>
</div>
<!-- --- ▲▲▲ カテゴリ管理HTML ▲▲▲ --- -->
              </div>
            </div>

               

            <div class="calendar-container">
              <div class="calendar-header">
                <button id="prev-month" class="nav-button">&#10094;</button>
                <div class="month-year-selector">
                  <div id="current-month-year" class="text-base font-medium"></div>
                  <button id="today-btn" class="nav-button today-btn">今日</button>
                </div>
                <button id="next-month" class="nav-button">&#10095;</button>
              </div>
              <div class="calendar-grid" id="calendar-grid"></div>
            </div>

            <!-- Todoリストは右カラムに移動 -->

          </div>
        </div>

        <!-- イベント追加/編集モーダル -->
        <div class="event-modal" id="event-modal">
          <div class="event-modal-content">
            <h2 id="modal-title">イベントを追加</h2>
            <form id="event-form" class="event-form">
              <input type="hidden" id="event-id">
              <input type="hidden" id="event-date">
              
              <div class="form-group">
                <label for="event-title">予定</label>
                <input type="text" id="event-title" required>
              </div>
              
              <div class="form-group time-group">
                <div>
                  <label>開始時間</label>
                  <div class="time-selects">
                    <select id="event-start-hour" class="hour-select"></select>
                    <select id="event-start-minute" class="minute-select"></select>
                  </div>
                </div>
                <div>
                  <label>終了時間</label>
                  <div class="time-selects">
                    <select id="event-end-hour" class="hour-select"></select>
                    <select id="event-end-minute" class="minute-select"></select>
                  </div>
                </div>
              </div>
              
              <div class="form-group">
                <label for="event-category">カテゴリー</label>
                <select id="event-category">
                </select>
              </div>
              
              <div class="form-group">
                <label for="event-description">詳細</label>
                <textarea id="event-description" rows="3"></textarea>
              </div>
              
              <div class="modal-buttons">
                <div>
                  <button type="button" id="delete-event" class="btn btn-delete" style="display: none;">削除</button>
                </div>
                <div>
                  <button type="button" id="cancel-event" class="btn btn-cancel">キャンセル</button>
                  <button type="submit" class="btn btn-primary">保存</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- My法規セクション -->
      <section id="houki-area" class="hidden">
        <div class="flex items-center gap-4">
          <h2 class="text-base font-semibold">My法規</h2>
        </div>
        <div class="mt-2">
          <button onclick="addHouki()" class="text-xs bg-blue-500 text-white px-2 py-1 rounded w-fit">+法規追加</button>
          <div id="houki-list" class="space-y-2 mt-2"></div>
        </div>
      </section>

      <!-- 一般ツールセクション -->
      <section id="general-tools-area" class="hidden">
        <div class="flex items-center gap-4">
          <h2 class="text-base font-semibold">一般ツール</h2>
        </div>
        <div class="mt-2">
          <div class="flex gap-4 flex-wrap mb-2 tool-buttons">
            <button onclick="toggleToolDisplay('general-tools-area', 'memo-tool-content')" class="tool-button text-xs bg-gray-300 text-black px-2 py-1 rounded w-24 hover:bg-gray-700 hover:text-white transition" data-tool-category="general">メモ</button>
            <button onclick="toggleToolDisplay('general-tools-area', 'function-calculator-content')" class="tool-button text-xs bg-gray-300 text-black px-2 py-1 rounded w-24 hover:bg-gray-700 hover:text-white transition" data-tool-category="general">関数電卓</button>
            <button onclick="toggleToolDisplay('general-tools-area', 'resize-tool-content')" class="tool-button text-xs bg-gray-300 text-black px-2 py-1 rounded w-24 hover:bg-gray-700 hover:text-white transition" data-tool-category="general">画像リサイズ</button>      
            <button onclick="window.location.href='pdf.html'" class="tool-button text-xs bg-gray-300 text-black px-2 py-1 rounded w-24 hover:bg-gray-700 hover:text-white transition" data-tool-category="general">PDF圧縮</button>
          </div>

          <!-- 画像リサイズツール -->
          <div id="resize-tool-content" class="tool-content" style="display: none;">
            <div class="max-w-md bg-white rounded-lg shadow-sm border border-gray-100">
              <div class="p-4 border-b border-gray-100">
                <h3 class="text-[13px] font-medium text-gray-800">画像リサイズ</h3>
                <p class="text-[11px] text-gray-500 mt-0.5">複数の画像を一括でリサイズ</p>
              </div>
              <div class="p-4">
                <div id="drop-area" class="border border-dashed border-gray-200 rounded-lg p-4 text-center mb-4 hover:border-gray-300 transition-colors cursor-pointer" onclick="document.getElementById('upload').click()">
                  <input type="file" id="upload" multiple accept="image/*" class="hidden">
                  <div class="flex flex-col items-center justify-center gap-2">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p class="text-[11px] text-gray-600">画像をドラッグ＆ドロップ</p>
                    <p class="text-[11px] text-gray-400">または</p>
                    <button class="bg-gray-200 text-gray-700 px-4 py-1.5 rounded text-[11px] hover:bg-gray-300 transition-colors">ファイルを選択</button>
                  </div>
                  <p id="file-name" class="text-[10px] text-gray-400 mt-3"></p>
                </div>
                <div class="space-y-2">
                  <div class="flex items-center justify-between">
                    <label class="text-[11px] text-gray-600">リサイズ後のサイズ（px）</label>
                    <select id="size" class="border border-gray-200 rounded px-2 py-1 text-[11px] focus:outline-none focus:border-gray-300 w-24">
                      <option value="1280">1280px</option>
                      <option value="1024">1024px</option>
                      <option value="800">800px</option>
                      <option value="640">640px</option>
                      <option value="400">400px</option>
                      <option value="320">320px</option>
                      <option value="160">160px</option>
                    </select>
                  </div>
                  <div class="flex justify-end mt-4">
                    <button id="convert-button" onclick="resizeImages()" class="bg-gray-800 text-white px-4 py-1.5 rounded text-[11px] hover:bg-gray-700 transition-colors hidden">リサイズ開始</button>
                  </div>
                </div>
                <canvas id="canvas" class="hidden"></canvas>
              </div>
            </div>
          </div>

          <!-- 関数電卓ツール -->
          <div id="function-calculator-content" class="tool-content" style="display: none;">
            <div class="flex gap-4">
              <!-- 関数電卓本体 -->
              <div class="w-64 bg-gray-800 rounded-lg shadow-sm border border-gray-700 flex-shrink-0 h-[400px]">
                <div class="p-3 border-b border-gray-700">
                  <h3 class="text-[13px] font-medium text-gray-200">関数電卓</h3>
                </div>
                <div class="p-3">
                  <div class="space-y-4">
                    <div class="bg-gray-900 p-4 rounded h-24 flex flex-col justify-between">
                      <input type="text" id="calculator-expression" class="w-full bg-transparent text-right text-sm text-gray-400 focus:outline-none h-1/3" readonly>
                      <input type="text" id="calculator-display" class="w-full bg-transparent text-right text-2xl font-mono focus:outline-none text-gray-100 h-2/3" readonly>
                    </div>
                    <div class="grid grid-cols-5 gap-1">
                      <!-- Row 1 -->
                      <button onclick="calculatorInput('SHIFT')" class="calculator-btn text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all" id="shift-button">SHIFT</button>
                      <button onclick="calculatorInput('ALPHA')" class="calculator-btn text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">ALPHA</button>
                      <button onclick="calculatorInput('MODE')" class="calculator-btn text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">MODE</button>
                      <button onclick="calculatorInput('DEL')" class="calculator-btn text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">DEL</button>
                      <button onclick="calculatorInput('AC')" class="calculator-btn text-xs bg-gray-600 hover:bg-gray-500 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">AC</button>

                      <!-- Row 2 -->
                      <button onclick="calculatorInput('x²')" class="calculator-btn text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">x²</button>
                      <button onclick="calculatorInput('x^')" class="calculator-btn text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">x^</button>
                      <button onclick="calculatorInput('√')" class="calculator-btn text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">√</button>
                      <button onclick="calculatorInput('log')" class="calculator-btn text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">log</button>
                      <button onclick="calculatorInput('ln')" class="calculator-btn text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">ln</button>

                      <!-- Row 3 -->
                      <button onclick="calculatorInput('sin')" class="calculator-btn text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">sin</button>
                      <button onclick="calculatorInput('cos')" class="calculator-btn text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">cos</button>
                      <button onclick="calculatorInput('tan')" class="calculator-btn text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">tan</button>
                      <button onclick="calculatorInput('nCr')" class="calculator-btn text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">nCr</button>
                      <button onclick="calculatorInput('EXP')" class="calculator-btn text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">EXP</button>

                      <!-- Row 4 -->
                      <button onclick="calculatorInput('7')" class="py-[0.55rem] px-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors bg-gray-900 hover:bg-gray-800 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">7</button>
                      <button onclick="calculatorInput('8')" class="py-[0.55rem] px-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors bg-gray-900 hover:bg-gray-800 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">8</button>
                      <button onclick="calculatorInput('9')" class="py-[0.55rem] px-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors bg-gray-900 hover:bg-gray-800 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">9</button>
                      <button onclick="calculatorInput('(')" class="py-[0.55rem] px-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">(</button>
                      <button onclick="calculatorInput(')')" class="py-[0.55rem] px-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">)</button>

                      <!-- Row 5 -->
                      <button onclick="calculatorInput('4')" class="py-[0.55rem] px-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors bg-gray-900 hover:bg-gray-800 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">4</button>
                      <button onclick="calculatorInput('5')" class="py-[0.55rem] px-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors bg-gray-900 hover:bg-gray-800 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">5</button>
                      <button onclick="calculatorInput('6')" class="py-[0.55rem] px-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors bg-gray-900 hover:bg-gray-800 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">6</button>
                      <button onclick="calculatorInput('×')" class="py-[0.55rem] px-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">×</button>
                      <button onclick="calculatorInput('÷')" class="py-[0.55rem] px-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">÷</button>

                      <!-- Row 6 -->
                      <button onclick="calculatorInput('1')" class="py-[0.55rem] px-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors bg-gray-900 hover:bg-gray-800 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">1</button>
                      <button onclick="calculatorInput('2')" class="py-[0.55rem] px-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors bg-gray-900 hover:bg-gray-800 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">2</button>
                      <button onclick="calculatorInput('3')" class="py-[0.55rem] px-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors bg-gray-900 hover:bg-gray-800 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">3</button>
                      <button onclick="calculatorInput('+')" class="py-[0.55rem] px-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">+</button>
                      <button onclick="calculatorInput('-')" class="py-[0.55rem] px-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">-</button>

                      <!-- Row 7 -->
                      <button onclick="calculatorInput('0')" class="py-[0.55rem] px-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors bg-gray-900 hover:bg-gray-800 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">0</button>
                      <button onclick="calculatorInput('.')" class="py-[0.55rem] px-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors bg-gray-900 hover:bg-gray-800 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">.</button>
                      <button onclick="calculatorInput('(-)')" class="py-[0.55rem] px-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">(-)</button>
                      <button onclick="calculatorInput('Ans')" class="py-[0.55rem] px-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">Ans</button>
                      <button onclick="calculatorInput('=')" class="py-[0.55rem] px-2 text-center rounded text-sm font-mono hover:bg-gray-100 transition-colors bg-orange-500 hover:bg-orange-600 text-white shadow-sm active:shadow-inner active:translate-y-[0.5px] transition-all">=</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 計算履歴 -->
              <div class="flex-1 bg-white rounded-lg shadow-sm border border-gray-100 min-h-0 h-[400px]">
                <div class="p-3 border-b border-gray-100">
                  <h3 class="text-[13px] font-medium text-gray-800">計算履歴</h3>
                </div>
                <div class="p-3 h-[calc(400px-80px)] overflow-y-auto">
                  <div id="calculator-history" class="space-y-2">
                    <!-- 計算履歴がここに追加されます -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
         <!-- メモツール -->
         <div id="memo-tool-content" class="tool-content" style="display: none;">
          <div class="max-w-4xl bg-white rounded-lg shadow-sm border border-gray-100">
            <div class="p-4 border-b border-gray-100">
              <div class="flex justify-between items-center">
                <div>
                  <h3 class="text-[13px] font-medium text-gray-800">メモ</h3>
                  <p class="text-[11px] text-gray-500 mt-0.5">フォントや色を変更できるシンプルなメモ機能です。計算式を入れると計算も出来ます。</p>
                </div>
                <button onclick="createNewMemo()" class="flex items-center gap-1 text-[11px] bg-blue-500 text-white px-3 py-1.5 rounded hover:bg-blue-600 transition">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                  </svg>
                  新規メモ
                </button>
              </div>
            </div>
            <div class="p-4">
              <div class="flex gap-6">
                <!-- 左サイド：メモ一覧 -->
                <div class="w-1/3">
                  <div class="mb-3">
                    <div class="relative">
                      <input type="text" id="memo-search" placeholder="メモを検索..." class="w-full pl-8 pr-2 py-1.5 text-[11px] border border-gray-200 rounded focus:outline-none focus:border-gray-400">
                      <svg class="w-4 h-4 text-gray-400 absolute left-2 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                      </svg>
                    </div>
                  </div>
                  <div class="flex gap-2 mb-3">
                    <select id="memo-category-filter" class="flex-1 text-[11px] border border-gray-200 rounded px-2 py-1.5 focus:outline-none focus:border-gray-400">
                      <option value="">カテゴリ</option>
                    </select>
                    <select id="memo-tag-filter" class="flex-1 text-[11px] border border-gray-200 rounded px-2 py-1.5 focus:outline-none focus:border-gray-400">
                      <option value="">タグ</option>
                    </select>
                  </div>
                  <div id="memo-list" class="space-y-2 max-h-[500px] overflow-y-auto pr-2">
                    <!-- メモリストはJavaScriptで動的に生成 -->
                  </div>
                </div>

                <!-- 右サイド：エディタ -->
                <div class="w-2/3 relative">
                  <div class="space-y-3">
                    <!-- メモ設定 (カテゴリ・タグ) を先に表示 -->
                    <div class="flex gap-2">
                       <div class="relative flex-1">
                        <input type="text" id="memo-category" placeholder="カテゴリを入力..." class="w-full pl-7 pr-2 py-1.5 text-[11px] border border-gray-200 rounded focus:outline-none focus:border-gray-400">
                        <svg class="w-4 h-4 text-gray-400 absolute left-2 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                       </div>
                     </div>
                     <!-- ★ 追加: タグ入力フィールド -->
                     <div class="relative">
                       <input type="text" id="memo-tags" placeholder="タグをカンマ区切りで入力... (例: 重要,アイデア)" class="w-full pl-7 pr-2 py-1.5 text-[11px] border border-gray-200 rounded focus:outline-none focus:border-gray-400">
                       <svg class="w-4 h-4 text-gray-400 absolute left-2 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.53 0 1.04.21 1.41.59L15 5h3a2 2 0 012 2v10a2 2 0 01-2 2H7a2 2 0 01-2-2V5a2 2 0 012-2zm0 5h10"></path> <!-- タグアイコン -->
                       </svg>
                     </div>
                     <!-- ★ 追加ここまで -->
                    <!-- メモヘッダー (タイトル) を次に表示 -->
                    <div class="flex items-center gap-2">
                      <input type="text" id="memo-title" placeholder="タイトルを入力..." class="flex-1 text-[13px] font-medium border-b border-gray-200 px-2 py-1.5 focus:outline-none focus:border-gray-400">
                    </div>

                    <!-- エディタとステータスバー -->
                    <div class="border border-gray-200 rounded">
                      <!-- ツールバー -->
                      <div class="flex items-center gap-2 p-2 border-b border-gray-200 bg-gray-50">
                        <button onclick="formatDoc('bold')" class="p-1 hover:bg-gray-200 rounded" title="太字">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        </button>
                        <button onclick="formatDoc('italic')" class="p-1 hover:bg-gray-200 rounded" title="斜体">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 14M5 5l7 14"></path></svg>
                        </button>
                        <button onclick="formatDoc('underline')" class="p-1 hover:bg-gray-200 rounded" title="下線">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 11h14M6 15h12"></path></svg>
                        </button>
                        <input type="color" oninput="formatDoc('foreColor', this.value)" class="h-5 w-5 border-none p-0 cursor-pointer" title="文字色">
                      </div>
                      <!-- エディタ本体 (textareaからdivに変更) -->
                      <div id="memo-content"
                           contenteditable="true"
                           class="w-full h-[400px] p-3 text-[11px] focus:outline-none font-mono overflow-y-auto"
                           ></div>
                      <!-- ステータスバー -->
                      <div class="flex justify-between items-center p-1.5 border-t border-gray-200 bg-gray-50">
                          <span id="memo-char-count" class="text-[10px] text-gray-500">0 文字</span>
                          <span id="memo-save-status" class="text-[10px] text-gray-500"></span>
                      </div>
                    </div>

                    <!-- アクションボタン -->
                    <div class="flex justify-between items-center">
                      <button onclick="deleteMemo()" class="text-[11px] text-red-500 px-3 py-1.5 rounded hover:bg-red-50 transition hidden" id="delete-button">
                        <span class="flex items-center gap-1">
                          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m-6 0V5a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                          </svg>
                          削除
                        </span>
                      </button>
                      <button id="manual-save-button" class="save-memo-btn text-[11px] bg-blue-500 text-white px-4 py-1.5 rounded hover:bg-blue-600 transition flex items-center gap-1 ml-auto">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                        </svg>
                        保存
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div> 
</section>


      <!-- 設計支援ツールセクション -->
      <section id="design-tools-area" class="hidden">
        <div class="flex items-center gap-4">
          <h2 class="text-base font-semibold">設計支援ツール</h2>
        </div>
        <div class="mt-2">
          <div class="flex gap-4 flex-wrap mb-2 tool-buttons">
            <button onclick="toggleToolDisplay('design-tools-area', 'glass-thickness-tool-content')" class="tool-button text-xs bg-gray-300 text-black px-2 py-1 rounded w-24 hover:bg-gray-700 hover:text-white transition" data-tool-category="design">ガラス厚計算</button>
            <button onclick="toggleToolDisplay('design-tools-area', 'rainwater-tool-content')" class="tool-button text-xs bg-gray-300 text-black px-2 py-1 rounded w-24 hover:bg-gray-700 hover:text-white transition" data-tool-category="design">雨水計算</button>
            <a href="test_shoubousetsubi.html" class="tool-button text-xs bg-gray-300 text-black px-2 py-1 rounded w-24 hover:bg-gray-700 hover:text-white transition text-center" data-tool-category="design">消防設備</a>
            <a href="test_koutei.html" class="tool-button text-xs bg-gray-300 text-black px-2 py-1 rounded w-24 hover:bg-gray-700 hover:text-white transition text-center" data-tool-category="design">工程表</a> <!-- Corrected path -->
            <button onclick="toggleToolDisplay('design-tools-area', 'color-checker-content')" class="tool-button text-xs bg-gray-300 text-black px-2 py-1 rounded w-24 hover:bg-gray-700 hover:text-white transition" data-tool-category="design">色彩提案</button>
            <button onclick="toggleToolDisplay('design-tools-area', 'unit-volume-tool-content')" class="tool-button text-xs bg-gray-300 text-black px-2 py-1 rounded w-24 hover:bg-gray-700 hover:text-white transition" data-tool-category="design">単位体積表</button>
          </div>

          <!-- ガラス厚さ計算ツール -->
          <div id="glass-thickness-tool-content" class="tool-content" style="display: none;">
            <div class="flex flex-col md:flex-row gap-4">
              <!-- ガラス厚計算フォーム -->
              <div class="max-w-md w-full md:w-1/2 bg-white rounded-lg shadow-sm border border-gray-100">
              <div class="p-4 border-b border-gray-100">
                <h3 class="text-[13px] font-medium text-gray-800">ガラス厚さ計算</h3>
                <p class="text-[11px] text-gray-500 mt-0.5">風圧力に基づくガラス厚さの計算</p>
              </div>
              <div class="p-4">
                <div class="space-y-4">
                  <div>
                    <label class="block text-[11px] text-gray-600 mb-1">短辺（mm）</label>
                    <input type="number" id="glass-short-side" class="w-full border border-gray-200 rounded px-2 py-1 text-[11px] focus:outline-none focus:border-gray-300">
                  </div>
                  <div>
                    <label class="block text-[11px] text-gray-600 mb-1">長辺（mm）</label>
                    <input type="number" id="glass-long-side" class="w-full border border-gray-200 rounded px-2 py-1 text-[11px] focus:outline-none focus:border-gray-300">
                  </div>
                  <div>
                      <label class="block text-[11px] text-gray-600 mb-1">設計風圧力（N/m²）</label>
                      <input type="number" id="wind-pressure" class="w-full border border-gray-200 rounded px-2 py-1 text-[11px] focus:outline-none focus:border-gray-300" placeholder="風圧力計算結果が反映されます">
                  </div>
                  <div>
                    <label class="block text-[11px] text-gray-600 mb-1">ガラス種類</label>
                    <select id="glass-type" class="w-full border border-gray-200 rounded px-2 py-1 text-[11px] focus:outline-none focus:border-gray-300">
                      <option value="float">フロートガラス</option>
                      <option value="tempered">強化ガラス</option>
                      <option value="laminated">合わせガラス</option>
                    </select>
                  </div>
                    <button onclick="calculateGlassThickness()" class="w-full bg-gray-800 text-white px-4 py-1.5 rounded text-[11px] hover:bg-gray-700 transition-colors">ガラス厚計算</button>
                </div>
                <div id="glass-result" class="mt-4 hidden">
                  <div id="glass-result-content"></div>
                  </div>
                </div>
              </div>

              <!-- 風圧力計算フォーム -->
              <div class="max-w-md w-full md:w-1/2 bg-gray-50 rounded-lg shadow-sm border border-gray-100">
                <div class="p-4 border-b border-gray-100">
                     <h4 class="text-[13px] font-medium text-gray-800">風圧力計算</h4>
                     <p class="text-[11px] text-gray-500 mt-0.5">基準風速などから設計風圧力を計算</p>
                </div>
                <div class="p-4">
                  <div class="space-y-4">
                    <div>
                      <label class="block text-[11px] text-gray-600 mb-1">地域区分</label>
                      <select id="region-type" class="w-full border border-gray-200 rounded px-2 py-1 text-[11px] focus:outline-none focus:border-gray-300">
                        <option value="1">Ⅰ地域（海岸部）</option>
                        <option value="2" selected>Ⅱ地域（平地部）</option>
                        <option value="3">Ⅲ地域（丘陵部）</option>
                        <option value="4">Ⅳ地域（山岳部）</option>
                      </select>
                    </div>
                    <div>
                      <label class="block text-[11px] text-gray-600 mb-1">建物高さ（m）</label>
                      <input type="number" id="building-height" class="w-full border border-gray-200 rounded px-2 py-1 text-[11px] focus:outline-none focus:border-gray-300">
                    </div>
                    <div>
                      <label class="block text-[11px] text-gray-600 mb-1">基準風速 Vo（m/s）</label>
                      <select id="basic-wind-speed" class="w-full border border-gray-200 rounded px-2 py-1 text-[11px] focus:outline-none focus:border-gray-300">
                        <option value="30">30</option>
                        <option value="32">32</option>
                        <option value="34" selected>34</option> <!-- Default value -->
                        <option value="36">36</option>
                        <option value="38">38</option>
                        <option value="40">40</option>
                        <option value="42">42</option>
                        <option value="44">44</option>
                        <option value="46">46</option>
                      </select>
                    </div>
                    <button onclick="calculateWindPressure()" class="w-full bg-gray-700 text-white px-4 py-1.5 rounded text-[11px] hover:bg-gray-600 transition-colors">風圧力計算</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 雨水計算ツール -->
          <div id="rainwater-tool-content" class="tool-content" style="display: none;">
            <div class="bg-white rounded-lg shadow-sm border border-gray-100">
              <div class="p-4 border-b border-gray-100">
                <h3 class="text-[13px] font-medium text-gray-800">雨水計算</h3>
                <p class="text-[11px] text-gray-500 mt-0.5">軒樋・竪樋の簡易計算</p>
              </div>
              <div class="p-4">
                <div class="flex flex-col md:flex-row gap-4"> 
                  <!-- 軒樋計算フォーム (左) -->
                  <div class="w-full md:w-1/2 space-y-4 border-r md:border-r-gray-200 pr-0 md:pr-4">
                    <h4 class="text-[12px] font-medium text-gray-800 mb-2">軒樋計算</h4>
                    <div class="space-y-2">
                      <div>
                        <label class="block text-[11px] text-gray-600 mb-1">対象屋根面積 (水平投影) [m2]</label>
                        <input type="number" id="eaves-roof-area" class="w-full border border-gray-200 rounded px-2 py-1 text-[11px] focus:outline-none focus:border-gray-300">
                      </div>
                      <div>
                        <label class="block text-[11px] text-gray-600 mb-1">地域別降雨強度 [mm/h]</label>
                        <select id="rainfall-intensity" class="w-full border border-gray-200 rounded px-2 py-1 text-[11px] focus:outline-none focus:border-gray-300">
                          <option value="120">120 (標準地域)</option>
                          <option value="150">150</option>
                          <option value="180">180</option>
                          <option value="200">200</option>
                        </select>
                      </div>
                      <button onclick="calculateEavesTrough()" class="w-full bg-gray-800 text-white px-4 py-1.5 rounded text-[11px] hover:bg-gray-700 transition-colors">軒樋計算</button>
                    </div>
                  </div>
                  <!-- 竪樋計算フォーム (右) -->
                  <div class="w-full md:w-1/2 space-y-4 pt-4 md:pt-0">
                    <h4 class="text-[12px] font-medium text-gray-800 mb-2">竪樋計算</h4>
                    <div class="space-y-2">
                      <div>
                        <label class="block text-[11px] text-gray-600 mb-1">受け持ち屋根面積 [m2]</label>
                        <input type="number" id="downpipe-roof-area" class="w-full border border-gray-200 rounded px-2 py-1 text-[11px] focus:outline-none focus:border-gray-300">
                      </div>
                      <div>
                        <label class="block text-[11px] text-gray-600 mb-1">受け持ち壁面積 [m2]</label>
                        <input type="number" id="downpipe-wall-area" class="w-full border border-gray-200 rounded px-2 py-1 text-[11px] focus:outline-none focus:border-gray-300" value="0">
                      </div>
                      <button onclick="calculateDownpipe()" class="w-full bg-gray-800 text-white px-4 py-1.5 rounded text-[11px] hover:bg-gray-700 transition-colors">竪樋計算</button>
                    </div>
                  </div>
                </div>
                <div id="rainwater-result" class="mt-4 hidden">
                  <div id="rainwater-result-content"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- ★★★ 色彩チェッカーツール ★★★ -->
          <div id="color-checker-content" class="tool-content" style="display: none;">
            <div class="max-w-5xl bg-white rounded-lg shadow-sm border border-gray-100"> <!-- max-w-2xl から max-w-5xl に変更 -->
              <div class="p-4 border-b border-gray-100">
                <h3 class="text-[13px] font-medium text-gray-800">色彩チェッカー</h3>
                <p class="text-[11px] text-gray-500 mt-0.5">基準色を選択すると、調和する色の組み合わせを提案します。</p>
        </div>
              <div class="p-4">
                <div class="flex items-center gap-4 mb-6">
                  <label for="base-color-picker" class="text-[11px] text-gray-600">基準色:</label>
                  <input type="color" id="base-color-picker" value="#FFFFFF" oninput="suggestColorCombinations(this.value)" class="w-10 h-10 border border-gray-300 rounded cursor-pointer">
                  <span id="base-color-value" class="text-sm font-mono">#FFFFFF</span>
                  <!-- ▼ パレット表示切り替えボタンを追加 ▼ -->
                  <button onclick="toggleColorPalette()" class="ml-4 text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded">パレット</button>
                  <!-- ▲ パレット表示切り替えボタンを追加 ▲ -->
                </div>
                <!-- ▼ カラーパレット表示エリアをここに移動 (デフォルト非表示) ▼ -->
                <div id="color-palette" class="mb-6 hidden"></div> <!-- mt-4 を削除し mb-6 を追加 -->
                <!-- ▲ カラーパレット表示エリア ▲ -->
                <div id="color-suggestions" class="flex flex-wrap gap-4"> <!-- grid から flex flex-wrap gap-4 に変更 -->
                  <!-- 色の提案がここに表示されます -->
                </div>
                <!-- ▼ ここにあったカラーパレット表示エリアを削除 ▼ -->
                <!-- <div id="color-palette" class="mt-4 hidden"></div> --> 
                <!-- ▲ ここにあったカラーパレット表示エリアを削除 ▲ -->
              </div>
            </div>
          </div>
        </div>

        　          <!-- ▼▼▼ 単位体積表ツール ▼▼▼ -->
          <div id="unit-volume-tool-content" class="tool-content" style="display: none;">
            <div class="max-w-2xl bg-white rounded-lg shadow-sm border border-gray-100">
              <div class="p-4 border-b border-gray-100">
                <h3 class="text-[13px] font-medium text-gray-800">単位体積重量計算</h3>
                <p class="text-[11px] text-gray-500 mt-0.5">材料と寸法から重量を計算します。</p>
              </div>
              <div class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <!-- 入力フォーム -->
                  <div class="space-y-4">
                    <div>
                      <label for="material-select" class="block text-[11px] text-gray-600 mb-1">材料を選択</label>
                      <select id="material-select" class="w-full border border-gray-200 rounded px-2 py-1 text-[11px] focus:outline-none focus:border-gray-300">
                        <!-- オプションはJSで追加 -->
                      </select>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                      <div>
                        <label for="material-width" class="block text-[11px] text-gray-600 mb-1">幅 (mm)</label>
                        <input type="number" id="material-width" placeholder="0" class="w-full border border-gray-200 rounded px-2 py-1 text-[11px] focus:outline-none focus:border-gray-300">
                      </div>
                      <div>
                        <label for="material-depth" class="block text-[11px] text-gray-600 mb-1">奥行 (mm)</label>
                        <input type="number" id="material-depth" placeholder="0" class="w-full border border-gray-200 rounded px-2 py-1 text-[11px] focus:outline-none focus:border-gray-300">
                      </div>
                      <div>
                        <label for="material-height" class="block text-[11px] text-gray-600 mb-1">高さ (mm)</label>
                        <input type="number" id="material-height" placeholder="0" class="w-full border border-gray-200 rounded px-2 py-1 text-[11px] focus:outline-none focus:border-gray-300">
                      </div>
                    </div>
                    <button onclick="calculateMaterialWeight()" class="w-full bg-gray-800 text-white px-4 py-1.5 rounded text-[11px] hover:bg-gray-700 transition-colors">重量計算</button>
                  </div>
                  <!-- 計算結果表示 -->
                  <div class="bg-gray-50 p-4 rounded-lg flex flex-col justify-center items-center">
                     <p class="text-sm text-gray-600 mb-1">計算結果</p>
                     <p id="material-weight-result" class="text-2xl font-bold text-gray-800">- kg</p>
                     <p id="unit-weight-display" class="text-xs text-gray-500 mt-2"></p>
                   </div>
                </div>
                 <div class="mt-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                   <p class="text-sm text-yellow-800">
                     ※この計算結果は参考値です。材料の密度は種類や状態によって変動します。
                   </p>
                 </div>
              </div>
            </div>
          </div>
          <!-- ▲▲▲ 単位体積表ツール ▲▲▲ -->
      </section>
    </main>     
    
    <!-- ★★★ 右サイドバー：広告エリア ★★★ -->
    <aside class="w-[225px] shrink-0 text-sm hidden md:block"> <!-- space-y-4 を削除 -->
      <!-- ここに移動したTodoリストを追加 -->
      <div class="todo-list-container hidden mb-4" id="calendar-todo-list"> <!-- 代わりにここにマージンを追加 -->
        <h3>Todoリスト</h3>
        <div class="todo-input-group">
          <input type="text" id="todo-input" placeholder="新しいタスクを入力...">
          <button id="add-todo-btn">追加</button>
        </div>
        <ul id="todo-list">
        </ul>
      </div>

      <div>
        <h4 class="text-[12px] font-semibold mb-1">PR</h4>
        <img src="image/asahikasei_cm.png" class="mb-2 rounded w-[clamp(180px,22vw,320px)]" alt="広告1" />
        <img src="image/asahikasei_cm.png" class="mb-2 rounded w-[clamp(180px,22vw,320px)]" alt="広告2" />
        <img src="image/asahikasei_cm.png" class="mb-2 rounded w-[clamp(180px,22vw,320px)]" alt="広告3" />
      </div>
    </aside>

      <script>
　　　　 // ... (他の const 宣言があればその下に追加)※カテゴリー追加
        const cancelEventBtn = document.getElementById('cancel-event'); // 既存の変数宣言の例
        const prevDayViewBtn = document.getElementById('prev-day-view'); // 既存の変数宣言の例
        const nextDayViewBtn = document.getElementById('next-day-view'); // 既存の変数宣言の例
        const todoInput = document.getElementById('todo-input');       // 既存の変数宣言の例
        const addTodoBtn = document.getElementById('add-todo-btn');     // 既存の変数宣言の例
        const todoListUl = document.getElementById('todo-list');       // 既存の変数宣言の例

        // ↓↓↓ ここから追加 ↓↓↓
        const categoryManagerDiv = document.getElementById('category-manager');
        const categoryManagerHeader = document.getElementById('category-manager-header');
        const toggleCategoryButton = document.getElementById('toggle-category-manager'); // ボタンのIDも取得
        const categoryManagerContent = document.getElementById('category-manager-content');
        const categoryNameInput = document.getElementById('category-name-input');
        const colorPaletteDiv = document.getElementById('color-palette');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const categoryListUl = document.getElementById('category-list');
        const eventCategorySelect = document.getElementById('event-category'); // イベント編集モーダルのカテゴリ選択用
        // ↑↑↑ ここまで追加 ↑↑↑

                // ↑↑↑ ここまで追加 ↑↑↑

        // ↓↓↓ ここからカテゴリ関連関数を追加 ↓↓↓
        function findCategoryById(id) {
            // ID をもとに categories 配列からカテゴリを探して返す
            return categories.find(cat => cat.id === id);
        }

        function saveCategories() {
            // categories 配列の内容を localStorage に保存する
            localStorage.setItem('calendarCategories', JSON.stringify(categories));
        }

        function initializeCategories() {
            // localStorage からカテゴリを読み込む。なければデフォルト値を設定する
            const storedCategories = localStorage.getItem('calendarCategories');
            if (storedCategories) {
                categories = JSON.parse(storedCategories);
            } else {
                // 初回起動時またはデータがない場合、デフォルトを設定
                categories = [
                    { id: 'cat-1', name: '個人', color: '#fffae6', borderColor: '#ffcc00', isDeletable: true, isEditable: true },
                    { id: 'cat-2', name: '仕事', color: '#e6f7ff', borderColor: '#1890ff', isDeletable: true, isEditable: true },
                    { id: 'cat-3', name: '重要', color: '#f6ffed', borderColor: '#52c41a', isDeletable: true, isEditable: true },
                    { id: 'cat-4', name: 'その他', color: '#fff0f6', borderColor: '#eb2f96', isDeletable: false, isEditable: false } // その他は編集・削除不可
                ];
                saveCategories(); // 初期値を保存
            }
            // 念のため、古いカスタムカテゴリデータを削除 (calender.htmlから移植)
            localStorage.removeItem('customCategories');
        }

        function initializeColorPalette() {
            // カテゴリ追加用のカラーパレットを作成する
            colorPaletteDiv.innerHTML = ''; // パレットをクリア
            paletteColors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color;
                swatch.addEventListener('click', () => {
                    // クリックされた色を選択状態にする
                    const currentSelected = colorPaletteDiv.querySelector('.selected');
                    if (currentSelected) {
                        currentSelected.classList.remove('selected');
                    }
                    swatch.classList.add('selected');
                    selectedColor = color; // 選択された色を保存
                });
                colorPaletteDiv.appendChild(swatch);
            });
            // 最初は最初の色を選択状態にしておく (任意)
            if (!selectedColor && colorPaletteDiv.firstChild) {
                 colorPaletteDiv.firstChild.click();
            }
        }

        function renderCategoryList() {
            // カテゴリ管理セクションにカテゴリの一覧を表示する
            categoryListUl.innerHTML = ''; // リストをクリア
            categories.forEach(cat => {
                const li = document.createElement('li');
                li.setAttribute('data-category-id', cat.id);

                const colorDiv = document.createElement('div');
                colorDiv.className = 'category-list-color';
                colorDiv.style.backgroundColor = cat.color; // カテゴリの色を表示

                const nameSpan = document.createElement('span');
                nameSpan.className = 'category-list-name';
                nameSpan.textContent = cat.name; // カテゴリ名を表示

                li.appendChild(colorDiv);
                li.appendChild(nameSpan);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'category-list-actions';
                li.appendChild(actionsDiv);

                // 編集ボタン (編集可能フラグ isEditable が false でない場合)
                if (cat.isEditable !== false) {
                    const editBtn = document.createElement('button');
                    editBtn.className = 'edit-category-btn';
                    editBtn.innerHTML = '&#9998;'; // 鉛筆アイコン
                    editBtn.title = 'カテゴリ編集';
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); // 親要素へのイベント伝播を停止
                        startEditCategory(cat.id);
                    });
                    actionsDiv.appendChild(editBtn);
                }

                // 削除ボタン (削除可能フラグ isDeletable が false でない場合)
                if (cat.isDeletable !== false) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-category-btn';
                    deleteBtn.innerHTML = '&#x1F5D1;'; // ゴミ箱アイコン
                    deleteBtn.title = 'カテゴリ削除';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteCategory(cat.id);
                    });
                    actionsDiv.appendChild(deleteBtn);
                }

                categoryListUl.appendChild(li);
            });
        }

        function startEditCategory(id) {
            // カテゴリ編集機能（今回は未実装）
            const category = findCategoryById(id);
            if (!category) return;
            console.log("Editing category:", category); // 編集対象をコンソールに出力
            alert(`カテゴリ「${category.name}」の編集機能はまだ作られていません。`); // 未実装のメッセージ
        }

        function addCategory() {
            // 新しいカテゴリを追加する
            const name = categoryNameInput.value.trim(); // 入力された名前を取得し、前後の空白を削除
            if (!name) {
                alert('カテゴリ名を入力してください。'); // 名前が空なら警告
                return;
            }
            if (!selectedColor) {
                alert('色を選択してください。'); // 色が選択されていなければ警告
                return;
            }
            // 同じ名前のカテゴリが既に存在するかチェック (大文字小文字を区別しない)
            if (categories.some(cat => cat.name.toLowerCase() === name.toLowerCase())) {
                alert('同じ名前のカテゴリが既に存在します。');
                return;
            }

            // 新しいカテゴリのデータオブジェクトを作成
            const newCategory = {
                id: 'custom-' + Date.now().toString(), // ユニークなIDを生成
                name: name,
                color: selectedColor,
                borderColor: selectedColor, // ボーダー色も同じ色にする（イベント表示用）
                isDeletable: true,          // カスタムカテゴリは削除可能
                isEditable: true            // カスタムカテゴリは編集可能
            };

            categories.push(newCategory); // 配列に追加
            saveCategories();             // localStorage に保存
            renderCategoryList();         // カテゴリリストを再描画
            populateCategoryDropdown();   // イベント編集モーダルのドロップダウンも更新
            categoryNameInput.value = ''; // 入力欄をクリア
            // 色選択をリセット (最初の色を再度選択状態にする)
            const currentSelected = colorPaletteDiv.querySelector('.selected');
            if (currentSelected) currentSelected.classList.remove('selected');
            if (colorPaletteDiv.firstChild) colorPaletteDiv.firstChild.click();
        }

        function deleteCategory(idToDelete) {
            // カテゴリを削除する
            const categoryToDelete = findCategoryById(idToDelete);
            if (!categoryToDelete) return; // 対象が見つからなければ何もしない

            // 削除不可カテゴリは削除しない
            if (categoryToDelete.isDeletable === false) {
                alert('このカテゴリは削除できません。');
                return;
            }

            // 削除確認
            if (!confirm(`カテゴリ「${categoryToDelete.name}」を削除してもよろしいですか？\nこのカテゴリのイベントは「その他」カテゴリに変更されます。`)) {
                return; // キャンセルされたら何もしない
            }

            // categories 配列から削除対象を除外
            categories = categories.filter(cat => cat.id !== idToDelete);
            saveCategories(); // localStorage を更新

            // 削除されたカテゴリに属していたイベントを「その他」カテゴリに変更する
            const fallbackCategory = categories.find(cat => cat.name === 'その他' && cat.isDeletable === false);
            const fallbackCategoryId = fallbackCategory ? fallbackCategory.id : null;

            if (fallbackCategoryId) {
                events = events.map(event => {
                    if (event.category === idToDelete) {
                        return { ...event, category: fallbackCategoryId }; // カテゴリIDを付け替える
                    }
                    return event;
                });
                localStorage.setItem('calendarEvents', JSON.stringify(events)); // イベントデータも更新
            } else {
                // 「その他」カテゴリが見つからない場合 (通常は発生しないはず)
                console.error("デフォルトの「その他」カテゴリが見つかりません。イベントのカテゴリを変更できませんでした。");
            }

            // UIを更新
            renderCategoryList();       // カテゴリリストを再描画
            populateCategoryDropdown(); // イベント編集モーダルのドロップダウンも更新
            renderCalendar();           // カレンダー表示を更新 (イベントの色が変わる可能性があるため)
            renderTodayView(viewingDate); // 今日の予定表示も更新
        }
        // ↑↑↑ ここまでカテゴリ関連関数を追加 ↑↑↑

        // グローバル変数
        let currentUser = 'default_user'; 
        const contacts = [];
        const todos = [];
        const teamTodos = [];
        const houkis = [];
        const projects = [];
        const teamProjects = [];
        const projectShares = {}; // プロジェクトの共有設定を保存
        

        // 統合データ管理オブジェクト
        const userData = {
            calendar: {
                events: [],
                categories: []
            },
            tasks: {
                personal: [],
                team: []
            },
            projects: {
                user: [],
                team: [],
                shares: {}
            },
            houkis: [],
            memos: [],
            calculator: {
                history: []
            },
            tools: {
                imageResize: { defaultSize: '1280' },
                glassCalculator: { history: [] },
                rainwaterCalculator: { history: [] }
            },
            settings: {},
            lastSaved: null
        };        

        // 重複している関数を削除し、以下の関数に統一します
        function switchSection(sectionId) {
          // すべてのセクションを非表示にする
          const sections = ['contact-area', 'user-area', 'team-area', 'calendar-area', 'houki-area', 'settings-area', 'user-input-section', 'general-tools-area', 'design-tools-area'];
          const calendarTodoList = document.getElementById('calendar-todo-list');
          
          sections.forEach(id => {
            const section = document.getElementById(id);
            if (section) {
              section.classList.add('hidden');
            }
          });
          // カレンダー用Todoリストも非表示にする
          if (calendarTodoList) {
              calendarTodoList.classList.add('hidden');
          }
          
          // 動的に追加された可能性のあるフォームを削除
          const dynamicForms = ['register-form', 'publish-form', 'feedback-form', 'login-form'];
          dynamicForms.forEach(formId => {
            const form = document.getElementById(formId);
            if (form) {
              form.remove();
            }
          });
          
          // 指定されたセクションを表示する
          const targetSection = document.getElementById(sectionId);
          if (targetSection) {
            targetSection.classList.remove('hidden');
            // Myカレンダー表示時はTodoリストも表示
            if (sectionId === 'calendar-area' && calendarTodoList) {
              calendarTodoList.classList.remove('hidden');
            }
          } else {
            console.error(`Section with id ${sectionId} not found.`);
          }
        }

        // 以下の関数を追加
        function toggleSection(id) {
          switchSection(id);
        }

        function showTodo() {
          switchSection('user-area');
        }

        function showTeamTodo() {
          switchSection('team-area');
        }

        function showMyCalendar() {
          switchSection('calendar-area');
          // カレンダーを初期化
          initializeCalendar();
        }

        function showMyHouki() {
          switchSection('houki-area');
        }

        function showSettings() {
          switchSection('settings-area');
        }

        // function showUserInput() { // 削除
        //   switchSection('user-input-section');
        // }

        // 掲載希望フォームを表示する関数
        function showPublishForm(event) {
          if (event) event.preventDefault();
          
          // 中央カラムのすべてのセクションを非表示にする
          const sectionsToHide = ['contact-area', 'user-area', 'team-area', 'calendar-area', 'houki-area', 'settings-area', 'user-input-section', 'general-tools-area', 'design-tools-area'];
          sectionsToHide.forEach(sectionId => {
            const section = document.getElementById(sectionId);
            if (section) {
              section.classList.add('hidden');
            }
          });

          const contentArea = document.getElementById('content-area');
          // 以前のフォームがあれば削除
          const existingRegisterForm = document.getElementById('register-form');
          if (existingRegisterForm) existingRegisterForm.remove();
          const existingFeedbackForm = document.getElementById('feedback-form');
          if (existingFeedbackForm) existingFeedbackForm.remove();
          const existingPublishForm = document.getElementById('publish-form');
          if (existingPublishForm) existingPublishForm.remove();

          contentArea.innerHTML = `
            <div class="opacity-0 transition-all duration-500 ease-in-out transform translate-y-4" id="publish-form"> <!-- id を publish-form に変更 -->
              <h2 class="text-lg font-semibold mb-3">掲載希望</h2>
              <div class="bg-white rounded-lg shadow-md p-4 max-w-2xl">
                <form onsubmit="handleRegisterSubmit(event)" class="space-y-4"> <!-- 送信処理は適切な関数に変更が必要 -->
                  <!-- 会社情報 -->
                  <div class="space-y-3">
                    <h3 class="font-semibold text-sm text-gray-700 border-b pb-1">会社情報</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-xs text-gray-600 mb-1">会社名 <span class="text-red-500">*</span></label>
                        <input required type="text" name="company" class="w-full border rounded px-2 py-1 text-sm" placeholder="例：株式会社〇〇">
                      </div>
                      <div>
                        <label class="block text-xs text-gray-600 mb-1">部署名</label>
                        <input type="text" name="department" class="w-full border rounded px-2 py-1 text-sm" placeholder="例：営業部">
                      </div>
                    </div>
                  </div>

                  <!-- 担当者情報 -->
                  <div class="space-y-3">
                    <h3 class="font-semibold text-sm text-gray-700 border-b pb-1">ご担当者様 情報</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-xs text-gray-600 mb-1">ご担当者名 <span class="text-red-500">*</span></label>
                        <input required type="text" name="name" class="w-full border rounded px-2 py-1 text-sm" placeholder="例：山田太郎">
                      </div>
                      <div>
                        <label class="block text-xs text-gray-600 mb-1">メールアドレス <span class="text-red-500">*</span></label>
                        <input required type="email" name="email" class="w-full border rounded px-2 py-1 text-sm" placeholder="例：example@company.com">
                      </div>
                      <div>
                        <label class="block text-xs text-gray-600 mb-1">電話番号 <span class="text-red-500">*</span></label>
                        <input required type="tel" name="phone" class="w-full border rounded px-2 py-1 text-sm" placeholder="例：03-1234-5678">
                      </div>
                    </div>
                  </div>

                  <!-- お問い合わせ内容 -->
                  <div class="space-y-2">
                    <h3 class="font-semibold text-sm text-gray-700 border-b pb-1">お問い合わせ内容</h3>
                    <textarea name="message" rows="4" class="w-full border rounded px-2 py-1 text-sm" placeholder="掲載に関するご要望やご質問がございましたらご記入ください。"></textarea>
                  </div>

                  <!-- プライバシーポリシー -->
                  <div class="space-y-2">
                    <div class="flex items-start gap-2">
                      <input required type="checkbox" id="privacy" name="privacy" class="mt-1">
                      <label for="privacy" class="text-xs text-gray-600">
                        プライバシーポリシーに同意します。
                        <a href="#" class="text-blue-600 hover:underline">プライバシーポリシーを読む</a>
                      </label>
                    </div>
                  </div>

                  <!-- 送信ボタン -->
                  <div class="text-center">
                    <button type="submit" class="bg-blue-600 text-white px-8 py-2 rounded hover:bg-blue-700 transition-colors text-sm">
                      送信する
                    </button>
                  </div>
                </form>
              </div>
            </div>`;

          setTimeout(() => {
            const form = document.getElementById('publish-form'); // id を publish-form に変更
            form.classList.remove('opacity-0', 'translate-y-4');
          }, 100);
        }

        // ご意見・ご要望フォームを表示する関数
        function showFeedbackForm(event) {
          if (event) event.preventDefault();
          
          // 中央カラムのすべてのセクションを非表示にする
          const sectionsToHide = ['contact-area', 'user-area', 'team-area', 'calendar-area', 'houki-area', 'settings-area', 'user-input-section', 'general-tools-area', 'design-tools-area'];
          sectionsToHide.forEach(sectionId => {
            const section = document.getElementById(sectionId);
            if (section) {
              section.classList.add('hidden');
            }
          });

          const contentArea = document.getElementById('content-area');
          // 以前のフォームがあれば削除
          const existingRegisterForm = document.getElementById('register-form');
          if (existingRegisterForm) existingRegisterForm.remove();
          const existingFeedbackForm = document.getElementById('feedback-form');
          if (existingFeedbackForm) existingFeedbackForm.remove();
          const existingPublishForm = document.getElementById('publish-form');
          if (existingPublishForm) existingPublishForm.remove();

          contentArea.innerHTML = `
            <div class="opacity-0 transition-all duration-500 ease-in-out transform translate-y-4" id="feedback-form">
              <h2 class="text-lg font-semibold mb-3">ご意見・ご要望</h2>
              <div class="bg-white rounded-lg shadow-md p-4 max-w-2xl">
                <form onsubmit="handleFeedbackSubmit(event)" class="space-y-4">
                  <!-- 会社情報 -->
                  <div class="space-y-3">
                    <h3 class="font-semibold text-sm text-gray-700 border-b pb-1">会社情報</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-xs text-gray-600 mb-1">会社名 <span class="text-red-500">*</span></label>
                        <input required type="text" name="company" class="w-full border rounded px-2 py-1 text-sm" placeholder="例：株式会社〇〇">
                      </div>
                      <div>
                        <label class="block text-xs text-gray-600 mb-1">部署名</label>
                        <input type="text" name="department" class="w-full border rounded px-2 py-1 text-sm" placeholder="例：営業部">
                      </div>
                    </div>
                  </div>

                  <!-- 担当者情報 -->
                  <div class="space-y-3">
                    <h3 class="font-semibold text-sm text-gray-700 border-b pb-1">ご担当者様 情報</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-xs text-gray-600 mb-1">ご担当者名 <span class="text-red-500">*</span></label>
                        <input required type="text" name="name" class="w-full border rounded px-2 py-1 text-sm" placeholder="例：山田太郎">
                      </div>
                      <div>
                        <label class="block text-xs text-gray-600 mb-1">メールアドレス <span class="text-red-500">*</span></label>
                        <input required type="email" name="email" class="w-full border rounded px-2 py-1 text-sm" placeholder="例：example@company.com">
                      </div>
                      <div>
                        <label class="block text-xs text-gray-600 mb-1">電話番号 <span class="text-red-500">*</span></label>
                        <input required type="tel" name="phone" class="w-full border rounded px-2 py-1 text-sm" placeholder="例：03-1234-5678">
                      </div>
                    </div>
                  </div>

                  <!-- お問い合わせ内容 -->
                  <div class="space-y-2">
                    <h3 class="font-semibold text-sm text-gray-700 border-b pb-1">お問い合わせ内容</h3>
                    <textarea name="message" rows="4" class="w-full border rounded px-2 py-1 text-sm" placeholder="ご意見・ご要望の内容をご記入ください。"></textarea>
                  </div>

                  <!-- プライバシーポリシー -->
                  <div class="space-y-2">
                    <div class="flex items-start gap-2">
                      <input required type="checkbox" id="privacy" name="privacy" class="mt-1">
                      <label for="privacy" class="text-xs text-gray-600">
                        プライバシーポリシーに同意します。
                        <a href="#" class="text-blue-600 hover:underline">プライバシーポリシーを読む</a>
                      </label>
                    </div>
                  </div>

                  <!-- 送信ボタン -->
                  <div class="text-center">
                    <button type="submit" class="bg-blue-600 text-white px-8 py-2 rounded hover:bg-blue-700 transition-colors text-sm">
                      送信する
                    </button>
                  </div>
                </form>
              </div>
            </div>`;

          setTimeout(() => {
            const form = document.getElementById('feedback-form');
            form.classList.remove('opacity-0', 'translate-y-4');
          }, 100);
        }

        // 新規会員登録フォームを表示する関数
        function showRegister() {
          // まず、他の全ての静的セクションを非表示にする
          switchSection(''); // 空文字を渡すことで、全ての静的セクションを隠し、動的フォームもクリアする

          const contentArea = document.getElementById('content-area');
          // 既存のフォームが残っていれば削除 (switchSectionで処理されるが一応残す)
          const existingRegisterForm = document.getElementById('register-form');
          if (existingRegisterForm) existingRegisterForm.remove();
          const existingFeedbackForm = document.getElementById('feedback-form');
          if (existingFeedbackForm) existingFeedbackForm.remove();
          const existingPublishForm = document.getElementById('publish-form');
          if (existingPublishForm) existingPublishForm.remove();
          const existingLoginForm = document.getElementById('login-form'); // login-formも削除
          if (existingLoginForm) existingLoginForm.remove();

          contentArea.innerHTML = `
            <div class="opacity-0 transition-all duration-500 ease-in-out transform translate-y-4" id="register-form">
              <h2 class="text-lg font-semibold mb-3">新規会員登録</h2>
              <div class="bg-white rounded-lg shadow-md p-4 max-w-2xl">
                <form onsubmit="handleRegisterSubmit(event)" class="space-y-4">
                  <div class="space-y-3">
                    <div>
                      <label class="block text-xs text-gray-600 mb-1">ユーザー名 <span class="text-red-500">*</span></label>
                      <input required name="username" class="w-full border rounded px-2 py-1 text-sm" placeholder="user" />
                    </div>
                    <div>
                      <label class="block text-xs text-gray-600 mb-1">パスワード <span class="text-red-500">*</span></label>
                      <input required name="password" type="password" class="w-full border rounded px-2 py-1 text-sm" placeholder="password" />
                    </div>
                  </div>
                  <div class="text-center mt-4">
                    <button type="submit" class="bg-green-500 text-white px-8 py-2 rounded hover:bg-green-600 transition-colors text-sm">登録</button>
                  </div>
                  <p class="text-sm text-center mt-4">すでに登録済みの方は <a href="#" onclick="showLogin()" class="text-blue-600 hover:underline">ログイン</a></p>
                </form>
              </div>
            </div>`;

          setTimeout(() => {
            const form = document.getElementById('register-form');
            form.classList.remove('opacity-0', 'translate-y-4');
          }, 100);
        }

        // ユーザー名入力処理関数 - 削除
        // function enterUser() {
        //   const input = document.getElementById("username");
        //   const name = input.value.trim();
        //   if (!name) return alert("ユーザー名を入力してください");
        //   currentUser = name;
        //   document.getElementById("user-area").classList.remove("hidden");
        //   input.disabled = true;
        //   renderTodos();
        // }

        // プロジェクト関連の変数とイベントハンドラを追加
        function showProjectForm() {
          const form = document.getElementById('projectForm');
          form.classList.remove('hidden');
        }

        function toggleProjectForm() {
          const form = document.getElementById('projectForm');
          form.classList.toggle('hidden');
          if (!form.classList.contains('hidden')) {
            document.getElementById('newProjectName').focus();
          }
        }

        function addProject(event) {
          event.preventDefault();
          const projectName = document.getElementById('newProjectName').value.trim();
          
          if (!projectName) {
            alert('プロジェクト名を入力してください');
            return;
          }
          
          if (projects.includes(projectName)) {
            alert('このプロジェクト名は既に存在します');
            return;
          }
          
          projects.push(projectName);
          document.getElementById('newProjectName').value = '';
          saveAllData(); // 統合保存システムで保存
          console.log('📁 ユーザープロジェクトを追加して保存:', projectName);
          toggleProjectForm();
          updateProjectDropdown();
          renderTodos();
        }

        function updateProjectDropdown() {
          const dropdown = document.getElementById('todoProject');
          dropdown.innerHTML = '<option value="">プロジェクトを選択</option>';
          projects.forEach(project => {
            dropdown.innerHTML += `<option value="${project}">${project}</option>`;
          });
        }

        function toggleTodoForm() {
          const form = document.getElementById('todoForm');
          form.classList.toggle('hidden');
          if (!form.classList.contains('hidden')) {
            document.getElementById('todoProject').focus();
          } else {
            // フォームをリセット
            document.getElementById('todoProject').value = '';
            document.getElementById('dueDate').value = '';
            document.getElementById('todoPriority').value = '';
            document.getElementById('todoText').value = '';
          }
        }

        function addTodo(event) {
          event.preventDefault();
          
          const project = document.getElementById("todoProject").value.trim();
          const dueDate = document.getElementById("dueDate").value;
          const priority = document.getElementById("todoPriority").value;
          const todoText = document.getElementById("todoText").value.trim();
          
          if (!project || !dueDate || !priority || !todoText) {
            alert("全ての項目を入力してください");
            return;
          }
          
          todos.push({
            project: project,
            text: todoText,
            dueDate: dueDate,
            priority: priority,
            completed: false,
            createdAt: new Date()
          });
          
          // フォームをリセットして非表示に
          document.getElementById("todoProject").value = "";
          document.getElementById("dueDate").value = "";
          document.getElementById("todoPriority").value = "";
          document.getElementById("todoText").value = "";
          saveAllData(); // 統合保存システムで保存
          console.log('✅ ユーザータスクを追加して保存:', todoText, 'in', project);
          toggleTodoForm();
          
          renderTodos();
        }

        function toggleTodo(index) {
          todos[index].completed = !todos[index].completed;
          if (todos[index].completed) {
            // 完了したタスクを削除
            setTimeout(() => {
              todos.splice(index, 1);
              renderTodos();
            }, 500);
          } else {
            saveAllData(); // 統合保存システムで保存
            console.log('🔄 ユーザータスクを未完了に戻して保存');
            renderTodos();
          }
        }

        // プロジェクト別タスクリストからの削除関数
        function deleteTodoFromProject(projectName, localIndex) {
          // プロジェクト毎にフィルタリングされた配列から実際のインデックスを取得
          const projectTodos = todos.filter(todo => !todo.completed && todo.project === projectName);
          const todoToDelete = projectTodos[localIndex];
          
          if (todoToDelete) {
            const actualIndex = todos.indexOf(todoToDelete);
            if (actualIndex !== -1) {
              // スマート確認UIを表示
              showDeleteConfirmation(projectName, localIndex, actualIndex, todoToDelete.text);
            }
          }
        }

        // スマート削除確認UI
        function showDeleteConfirmation(projectName, localIndex, actualIndex, todoText) {
          // 既存の確認UIがあれば削除
          const existingConfirm = document.querySelector('.delete-confirmation');
          if (existingConfirm) {
            existingConfirm.remove();
          }

          // 確認UIを作成
          const confirmDiv = document.createElement('div');
          confirmDiv.className = 'delete-confirmation fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white border-2 border-red-200 rounded-lg shadow-lg p-4 z-50 max-w-md';
          confirmDiv.innerHTML = `
            <div class="text-center">
              <div class="mb-3">
                <svg class="mx-auto h-12 w-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m-6 0V5a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </div>
              <h3 class="text-lg font-medium text-gray-900 mb-2">タスクを削除しますか？</h3>
              <p class="text-sm text-gray-500 mb-4 break-words">"${todoText}"</p>
              <div class="flex gap-3 justify-center">
                <button onclick="cancelDeleteConfirmation()" 
                  class="px-4 py-2 text-sm bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition-colors">
                  キャンセル
                </button>
                <button onclick="confirmDeleteTodo(${actualIndex})" 
                  class="px-4 py-2 text-sm bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                  削除する
                </button>
              </div>
            </div>
          `;

          // オーバーレイを作成
          const overlay = document.createElement('div');
          overlay.className = 'delete-overlay fixed inset-0 bg-black bg-opacity-50 z-40';
          overlay.onclick = cancelDeleteConfirmation;

          // 中央カラムに追加
          document.body.appendChild(overlay);
          document.body.appendChild(confirmDiv);

          // アニメーション効果
          setTimeout(() => {
            confirmDiv.style.opacity = '0';
            confirmDiv.style.transform = 'translate(-50%, -50%) scale(0.95)';
            confirmDiv.style.transition = 'all 0.2s ease-out';
            setTimeout(() => {
              confirmDiv.style.opacity = '1';
              confirmDiv.style.transform = 'translate(-50%, -50%) scale(1)';
            }, 10);
          }, 0);
        }

        // 削除確認をキャンセル
        function cancelDeleteConfirmation() {
          const confirmDiv = document.querySelector('.delete-confirmation');
          const overlay = document.querySelector('.delete-overlay');
          
          if (confirmDiv) {
            confirmDiv.style.opacity = '0';
            confirmDiv.style.transform = 'translate(-50%, -50%) scale(0.95)';
            setTimeout(() => {
              confirmDiv.remove();
              if (overlay) overlay.remove();
            }, 200);
          }
        }

        // 削除を実行
        function confirmDeleteTodo(actualIndex) {
          // 確認UIを削除
          cancelDeleteConfirmation();
          
          // タスクを削除
          todos.splice(actualIndex, 1);
          saveAllData(); // 統合保存システムで保存
          console.log('🗑️ ユーザータスクを削除して保存');
          renderTodos(); // renderTodos関数を呼び出し
          
          // 削除完了メッセージを表示
          showSuccessMessage('タスクを削除しました');
        }

        // 成功メッセージ表示
        function showSuccessMessage(message) {
          const successDiv = document.createElement('div');
          successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
          successDiv.textContent = message;
          
          document.body.appendChild(successDiv);
          
          // アニメーション
          setTimeout(() => {
            successDiv.style.transform = 'translateX(0)';
          }, 100);
          
          // 3秒後に自動削除
          setTimeout(() => {
            successDiv.style.transform = 'translateX(full)';
            setTimeout(() => {
              if (successDiv.parentNode) {
                successDiv.remove();
              }
            }, 300);
          }, 300);
        }
 
        function renderTodos() {
          const container = document.getElementById("projectTodoLists");
          container.innerHTML = "";
          
          // プロジェクト毎にタスクをグループ化
          const groupedTodos = {};
          todos.filter(todo => !todo.completed).forEach(todo => {
            if (!groupedTodos[todo.project]) {
              groupedTodos[todo.project] = [];
            }
            groupedTodos[todo.project].push(todo);
          });
          
          // プロジェクト毎にタスクを表示
          Object.keys(groupedTodos).forEach(projectName => {
            const projectDiv = document.createElement('div');
            projectDiv.className = 'bg-white p-2 rounded shadow-sm text-xs';
            
            // 期限でソート
            const sortedTodos = groupedTodos[projectName].sort((a, b) => {
              return new Date(a.dueDate) - new Date(b.dueDate);
            });
            
            projectDiv.innerHTML = `
              <div class="flex items-center justify-between mb-1.5 pb-1.5 border-b">
                <h3 class="font-semibold">${projectName}</h3>
                <span class="text-gray-500">${sortedTodos.length}件</span>
              </div>
              <div class="space-y-1">
                ${sortedTodos.map((todo, index) => {
                  const isOverdue = new Date(todo.dueDate) < new Date();
                  const priorityColors = {
                    high: 'bg-red-100 text-red-800',
                    medium: 'bg-yellow-100 text-yellow-800',
                    low: 'bg-green-100 text-green-800'
                  };
                  
                  return `
                    <div class="flex items-center gap-1.5 py-0.5 ${isOverdue ? 'text-red-600' : ''}">
                      <input type="checkbox" 
                        onclick="toggleTodo(${todos.indexOf(todo)})" 
                        class="w-3 h-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                      <div class="w-[70px] flex-shrink-0 text-[10px]">
                        ${todo.dueDate}
                      </div>
                      <div class="flex-grow truncate text-[11px]">
                        ${todo.text}
                      </div>
                      <span class="flex-shrink-0 text-[10px] ${priorityColors[todo.priority]} px-1 rounded-sm">
                        ${todo.priority === 'high' ? '高' : todo.priority === 'medium' ? '中' : '低'}
                      </span>
                      <button onclick="deleteTodoFromProject('${projectName}', ${index})" 
                        class="flex-shrink-0 text-red-500 hover:text-red-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m-6 0V5a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                      </button>
                    </div>
                  `;
                }).join('')}
              </div>
            `;
            
            container.appendChild(projectDiv);
          });
        }

        // 連絡先関連の関数群
        function addContact() {
          const obj = {
            company: "",
            dept: "",
            name: "",
            role: "",
            phone: "",
            email: "",
            memo: "",
            locked: false  // 必ずロック解除状態で作成
          };
          contacts.push(obj);
          renderContacts();
          saveAllData(); // ★統合保存追加★
          console.log('👤 連絡先を追加して保存');
          
          // 新しく追加されたカードまでスクロール
          const container = document.getElementById("contact-list");
          container.lastElementChild?.scrollIntoView({ behavior: 'smooth' });
        }

        // 検索クリア関数
        function clearSearch() {
          const searchInput = document.querySelector('input[placeholder="会社名や氏名で検索..."]');
          searchInput.value = '';
          const list = document.querySelectorAll('#contact-list > div');
          list.forEach(card => {
            card.style.display = 'block';
          });
          renderContacts();
        }

        function deleteContact(index) {
          contacts.splice(index, 1);
          renderContacts();
          saveAllData(); // ★統合保存追加★
          console.log('🗑️ 連絡先を削除して保存');
        }

        function toggleLock(index) {
          if (contacts[index]) {
            contacts[index].locked = !contacts[index].locked;
            renderContacts();
            saveAllData(); // ★統合保存追加★
            console.log('🔒 連絡先のロック状態を変更して保存');
          }
        }

        function searchContacts(keyword) {
          const list = document.querySelectorAll('#contact-list > div');
          const searchText = keyword.toLowerCase();
          list.forEach(card => {
            const company = card.querySelector('input[placeholder="会社名"]').value.toLowerCase();
            const name = card.querySelector('input[placeholder="氏名"]').value.toLowerCase();
            const dept = card.querySelector('input[placeholder="部署名"]').value.toLowerCase();
            const role = card.querySelector('input[placeholder="役職"]').value.toLowerCase();
            
            if (company.includes(searchText) || 
                name.includes(searchText) || 
                dept.includes(searchText) || 
                role.includes(searchText)) {
              card.style.display = 'block';
            } else {
              card.style.display = 'none';
            }
          });
        }

        // 連絡先リスト表示関数
        function renderContacts() {
          contacts.sort((a, b) => {
          const aCompany = a.company || '';
          const bCompany = b.company || '';
          return aCompany.localeCompare(bCompany);
　　　　　});
          const container = document.getElementById("contact-list");
          container.innerHTML = "";
          contacts.forEach((c, idx) => {
            const div = document.createElement("div");
            div.className = "bg-white border rounded text-xs w-[240px] p-2";
            const cardContent = `
             <div class="bg-gray-600 text-white px-2 py-1 flex justify-between items-center">
             <input type="text" value="${c.company || ''}" placeholder="会社名" onchange="contacts[${idx}].company = this.value; saveAllData();" class="bg-transparent focus:outline-none w-full" ${c.locked ? 'disabled' : ''} />
             <div class="flex gap-1 items-center ml-2">
             <button onclick="toggleLock(${idx})" class="w-6 h-6 rounded-full bg-white flex items-center justify-center">
                    ${c.locked
                      ? `<svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4' fill='none' viewBox='0 0 24 24' stroke='black'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M16 11V7a4 4 0 00-8 0v4M5 11h14v10H5V11z'/></svg>`
                      : `<svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4' fill='none' viewBox='0 0 24 24' stroke='black'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 11V7a4 4 0 00-8 0v4M5 11h14v10H5V11z'/></svg>`}
             </button>
             <button onclick="deleteContact(${idx})" class="w-6 h-6 rounded-full bg-white flex items-center justify-center">
             <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4' fill='none' viewBox='0 0 24 24' stroke='black'>
             <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m-6 0V5a1 1 0 00-1-1h-4a1 1 0 00-1 1v2' />
             </svg>
             </button>
             </div>
             </div>
             <div class="px-2 py-1 space-y-1">
             <input type="text" value="${c.dept || ''}" placeholder="部署名" onchange="contacts[${idx}].dept = this.value; saveAllData();" class="p-1 border w-full" ${c.locked ? 'disabled' : ''} />
             <input type="text" value="${c.name || ''}" placeholder="氏名" onchange="contacts[${idx}].name = this.value; saveAllData();" class="p-1 border w-full" ${c.locked ? 'disabled' : ''} />
             <input type="text" value="${c.role || ''}" placeholder="役職" onchange="contacts[${idx}].role = this.value; saveAllData();" class="p-1 border w-full" ${c.locked ? 'disabled' : ''} />
             <input type="text" value="${c.phone || ''}" placeholder="携帯番号" onchange="contacts[${idx}].phone = this.value; saveAllData();" class="p-1 border w-full" ${c.locked ? 'disabled' : ''} />
             <input type="email" value="${c.email || ''}" placeholder="mail" onchange="contacts[${idx}].email = this.value; saveAllData();" class="p-1 border w-full" ${c.locked ? 'disabled' : ''} />
             <textarea placeholder="memo" onchange="contacts[${idx}].memo = this.value; saveAllData();" class="p-1 border w-full resize-none" ${c.locked ? 'disabled' : ''}>${c.memo || ''}</textarea>
             </div>
             `;
            div.innerHTML = cardContent;
            container.appendChild(div);
          });
        }

        function addHouki() {
          // 法規追加フォームを作成
          const formDiv = document.createElement('div');
          formDiv.className = 'bg-white p-4 rounded mb-2'; // shadow を削除
          formDiv.innerHTML = `
            <div class="flex items-center gap-2">
              <input type="text" 
                id="newHoukiName" 
                placeholder="法律名を入力" 
                class="p-2 border rounded flex-grow">
              <button onclick="createNewHouki(this.parentElement)" 
                class="px-4 py-2 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">
                追加
              </button>
              <button onclick="this.parentElement.remove()" 
                class="px-4 py-2 text-sm bg-gray-500 text-white rounded hover:bg-gray-600">
                キャンセル
              </button>
            </div>
          `;
          
          // 法規リストの前にフォームを挿入
          const houkiList = document.getElementById('houki-list');
          houkiList.parentNode.insertBefore(formDiv, houkiList);
        }

        function createNewHouki(formDiv) {
          const nameInput = document.getElementById('newHoukiName');
          const name = nameInput.value.trim();
          
          if (!name) {
            alert('法律名を入力してください');
            return;
          }

          // 既存の法規と名前が重複していないかチェック
          if (houkis.some(h => h.name === name)) {
            alert('この法律名は既に存在します');
            return;
          }

          // 新しい法規を追加（デフォルトで1つの空の条項を含める）
          const houki = {
            name: name,
            articles: [{
              number: '',
              text: '',
              locked: false
            }],
            locked: false
          };
          houkis.push(houki);

          saveAllData(); // 統合保存システムで保存
          console.log('📚 法規を追加して保存:', name);
          
          // フォームを削除
          formDiv.remove();
          
          // 法規リストを再描画
          renderHoukis();
          
          // 新しく追加した法規のアコーディオンを開く
          setTimeout(() => {
            const accordion = document.getElementById(`accordion-${name}`);
            if (accordion) {
              accordion.classList.remove('hidden');
            }
          }, 0);
        }

        function renderHoukis() {
          const houkiList = document.getElementById('houki-list');
          houkiList.innerHTML = '';

          // 法律名でグループ化
          const groupedHoukis = houkis.reduce((acc, houki) => {
            if (!acc[houki.name]) {
              acc[houki.name] = [];
            }
            acc[houki.name].push(houki);
            return acc;
          }, {});

          Object.keys(groupedHoukis).forEach(houkiName => {
            const houki = groupedHoukis[houkiName][0];
            const houkiDiv = document.createElement('div');
            houkiDiv.className = 'bg-white p-4 rounded shadow mb-2';
            houkiDiv.setAttribute('data-houki-name', houkiName);

            houkiDiv.innerHTML = `
              <div class="flex items-center gap-2 mb-2">
                <input type="text" 
                  placeholder="法律名" 
                  value="${houkiName}" 
                  onchange="updateHoukiName('${houkiName}', this.value)" 
                  class="p-2 border" 
                  style="width: 60%;"
                  ${houki.locked ? 'disabled' : ''} />
                <button onclick="toggleAccordion('${houkiName}')" 
                  class="text-xs bg-blue-500 text-white px-2 py-1 rounded">
                  ▼
                </button>
                <button onclick="lockHouki('${houkiName}')" 
                  class="text-xs ${houki.locked ? 'bg-yellow-500' : 'bg-gray-500'} text-white px-2 py-1 rounded">
                  ${houki.locked ? 'Unlock' : 'Lock'}
                </button>
                ${!houki.locked ? `
                  <button onclick="deleteHouki('${houkiName}')" 
                    class="text-xs bg-red-500 text-white px-2 py-1 rounded">
                  削除
                  </button>
                ` : ''}
              </div>
              <div id="accordion-${houkiName}" class="space-y-2 hidden">
                ${houki.articles.map((article, articleIndex) => `
                  <div class="flex items-center gap-2 mb-2">
                    <input type="text" 
                      placeholder="条項" 
                      value="${article.number}" 
                      onchange="updateArticle('${houkiName}', ${articleIndex}, 'number', this.value)"
                      class="p-2 border h-[42px]" 
                      style="width: 20%;" 
                      ${houki.locked ? 'disabled' : ''} />
                    <textarea 
                      placeholder="法文" 
                      onchange="updateArticle('${houkiName}', ${articleIndex}, 'text', this.value)"
                      class="p-2 border flex-grow h-[42px] resize-none"
                      ${houki.locked ? 'disabled' : ''}>${article.text}</textarea>
                  </div>
                `).join('')}
                ${!houki.locked ? `
                  <button onclick="addArticle('${houkiName}')" 
                    class="text-xs bg-green-500 text-white px-2 py-1 rounded">
                  +条項追加
                  </button>
                ` : ''}
              </div>
            `;

            houkiList.appendChild(houkiDiv);
          });
        }

        // === 統合保存システム ===
        // 統合保存関数
        function saveAllData() {
            try {
                updateUserData(); // 最新データを統合オブジェクトに反映
                userData.lastSaved = new Date().toISOString();
                localStorage.setItem('yaneyuka_userData', JSON.stringify(userData));
                console.log('✅ 全データ保存完了:', userData.lastSaved);
                showSaveStatus('保存完了', 'success');
                updateLastSavedDisplay();
                return true;
            } catch (error) {
                console.error('❌ 保存エラー:', error);
                showSaveStatus('保存失敗', 'error');
                return false;
            }
        }

        // 統合読み込み関数
        function loadAllData() {
            try {
                const saved = localStorage.getItem('yaneyuka_userData');
                if (saved) {
                    const loaded = JSON.parse(saved);
                    // 既存のデータ構造とマージ
                    Object.assign(userData, loaded);
                    
                    // 各機能に反映
                    if (typeof events !== 'undefined') events = userData.calendar.events || [];
                    if (typeof categories !== 'undefined') categories = userData.calendar.categories || [];
                    if (typeof todos !== 'undefined') todos.splice(0, todos.length, ...(userData.tasks.personal || []));
                    if (typeof teamTodos !== 'undefined') teamTodos.splice(0, teamTodos.length, ...(userData.tasks.team || []));
                    if (typeof houkis !== 'undefined') houkis.splice(0, houkis.length, ...(userData.houkis || []));
                    if (typeof memos !== 'undefined') memos.splice(0, memos.length, ...(userData.memos || []));
                    if (typeof calculatorHistory !== 'undefined') calculatorHistory = userData.calculator.history || [];
                    if (typeof contacts !== 'undefined') contacts.splice(0, contacts.length, ...(userData.contacts || []));
                    if (typeof projects !== 'undefined') projects.splice(0, projects.length, ...(userData.projects.user || []));
                    if (typeof teamProjects !== 'undefined') teamProjects.splice(0, teamProjects.length, ...(userData.projects.team || []));
                    if (typeof projectShares !== 'undefined') Object.assign(projectShares, userData.projects.shares || {});                   
                    console.log('✅ 全データ読み込み完了:', userData.lastSaved);
                    return true;
                }
            } catch (error) {
                console.error('❌ 読み込みエラー:', error);
                return false;
            }
            return false;
        }

        // データ更新関数
        function updateUserData() {
            if (typeof events !== 'undefined') userData.calendar.events = events;
            if (typeof categories !== 'undefined') userData.calendar.categories = categories;
            if (typeof todos !== 'undefined') userData.tasks.personal = todos;
            if (typeof teamTodos !== 'undefined') userData.tasks.team = teamTodos;
            if (typeof houkis !== 'undefined') userData.houkis = houkis;
            if (typeof memos !== 'undefined') userData.memos = memos;
            if (typeof calculatorHistory !== 'undefined') userData.calculator.history = calculatorHistory;
            if (typeof contacts !== 'undefined') userData.contacts = contacts;
            if (typeof projects !== 'undefined') userData.projects.user = projects;
            if (typeof teamProjects !== 'undefined') userData.projects.team = teamProjects;
            if (typeof projectShares !== 'undefined') userData.projects.shares = projectShares;
        }

        // 保存状況表示
        function showSaveStatus(message, type = 'info') {
            const statusElements = document.querySelectorAll('#memo-save-status, .save-status, #main-save-status');
            statusElements.forEach(el => {
                if (el) {
                    el.textContent = message;
                    el.className = `save-status text-[10px] ${
                        type === 'success' ? 'text-green-600' : 
                        type === 'error' ? 'text-red-600' : 'text-gray-500'
                    }`;
                }
            });
        }

        // 自動保存機能
        let autoSaveInterval;
        function startAutoSave(intervalMinutes = 5) {
            stopAutoSave();
            autoSaveInterval = setInterval(() => {
                saveAllData();
            }, intervalMinutes * 60 * 1000);
            console.log(`🔄 自動保存開始: ${intervalMinutes}分間隔`);
        }

        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
        }

        // 手動保存
        function manualSave() {
            saveAllData();
        }

        // 最終保存時刻表示更新
        function updateLastSavedDisplay() {
            const element = document.getElementById('last-saved-time');
            if (element && userData.lastSaved) {
                const date = new Date(userData.lastSaved);
                element.textContent = date.toLocaleString('ja-JP');
            }
        }

        // 自動保存間隔変更
        function updateAutoSaveInterval() {
            const interval = parseInt(document.getElementById('auto-save-interval').value);
            if (interval > 0) {
                startAutoSave(interval);
            } else {
                stopAutoSave();
            }
        }

        // データエクスポート
        function exportData() {
            updateUserData();
            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `yaneyuka_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showSaveStatus('エクスポート完了', 'success');
        }

        // データインポート
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    if (confirm('現在のデータを上書きしますか？（元に戻せません）')) {
                        Object.assign(userData, imported);
                        loadAllData(); // データを各機能に反映
                        
                        // 画面を更新
                        if (typeof renderCalendar === 'function') renderCalendar();
                        if (typeof renderTodoList === 'function') renderTodoList();
                        if (typeof renderHoukis === 'function') renderHoukis();
                        if (typeof renderMemoList === 'function') renderMemoList();
                        
                        showSaveStatus('インポート完了', 'success');
                    }
                } catch (error) {
                    alert('ファイル形式が正しくありません');
                    showSaveStatus('インポート失敗', 'error');
                }
            };
            reader.readAsText(file);
        }

        // ページ離脱前の自動保存
        window.addEventListener('beforeunload', function() {
            updateUserData();
            saveAllData();
        });

        document.addEventListener('DOMContentLoaded', () => {
          loadSettings(); // 設定読み込み関数を呼び出す

          // 設定変更時のイベントリスナーを追加
        });

        function toggleAccordion(houkiName) {
          const accordion = document.getElementById(`accordion-${houkiName}`);
          if (accordion) {
            accordion.classList.toggle('hidden');
          }
        }

        function addArticle(houkiName) {
          const houki = houkis.find(h => h.name === houkiName);
          if (houki) {
            houki.articles.push({
              number: '',
              text: '',
              locked: false
            });
            renderHoukis();
            saveAllData(); // 統合保存システムで保存
            console.log('📚 条項を追加して保存:', houkiName);
            // 追加後にアコーディオンを開いた状態にする
            setTimeout(() => {
            const accordion = document.getElementById(`accordion-${houkiName}`);
              if (accordion) {
            accordion.classList.remove('hidden');
              }
            }, 0);
          }
        }

        function updateHoukiName(oldName, newName) {
          const houki = houkis.find(h => h.name === oldName);
          if (houki) {
            houki.name = newName;
            renderHoukis();
            saveAllData(); // 統合保存システムで保存
            console.log('📚 法規名を変更して保存:', oldName, '→', newName);
          }
        }

        function deleteHouki(houkiName) {
          const index = houkis.findIndex(h => h.name === houkiName);
          if (index !== -1) {
            houkis.splice(index, 1);
            renderHoukis();
            saveAllData(); // 統合保存システムで保存
            console.log('📚 条項を追加して保存:', houkiName);
          }
        }

        function lockHouki(houkiName) {
          const houki = houkis.find(h => h.name === houkiName);
          if (houki) {
            houki.locked = !houki.locked;
            renderHoukis();
          }
        }

        function updateArticle(houkiName, articleIndex, field, value) {
          const houki = houkis.find(h => h.name === houkiName);
          if (houki && houki.articles[articleIndex]) {
            houki.articles[articleIndex][field] = value;
            saveAllData(); // 統合保存システムで保存
            console.log('📝 法規を更新して保存:', houkiName, field, value);
          }
        }

        function showTeamProjectForm() {
          const form = document.getElementById('teamProjectForm');
          form.classList.remove('hidden');
        }

        function toggleTeamProjectForm() {
          const form = document.getElementById('teamProjectForm');
          form.classList.toggle('hidden');
          if (!form.classList.contains('hidden')) {
            document.getElementById('newTeamProjectName').focus();
          }
        }

        function addTeamProject(event) {
          event.preventDefault();
          const projectName = document.getElementById('newTeamProjectName').value.trim();
          
          if (!projectName) {
            alert('プロジェクト名を入力してください');
            return;
          }
          
          if (teamProjects.includes(projectName)) {
            alert('このプロジェクト名は既に存在します');
            return;
          }
          
          teamProjects.push(projectName);
          projectShares[projectName] = {
            owner: currentUser,
            sharedUsers: []
          };
          
          document.getElementById('newTeamProjectName').value = '';
          saveAllData(); // 統合保存システムで保存
          console.log('👥 チームプロジェクトを追加して保存:', projectName);
          toggleTeamProjectForm();
          updateTeamProjectDropdown();
          renderTeamTodos();
        }

        function updateTeamProjectDropdown() {
          const dropdown = document.getElementById('teamTodoProject');
          const shareDropdown = document.getElementById('shareProjectSelect');
          const options = '<option value="">プロジェクトを選択</option>' + 
            teamProjects.map(project => `<option value="${project}">${project}</option>`).join('');
          
          dropdown.innerHTML = options;
          if (shareDropdown) {
            shareDropdown.innerHTML = options;
          }
        }

        function showShareProjectForm() {
          const form = document.getElementById('shareProjectForm');
          form.classList.remove('hidden');
          updateTeamProjectDropdown();
          renderSharedUsers();
        }

        function toggleShareProjectForm() {
          const form = document.getElementById('shareProjectForm');
          form.classList.toggle('hidden');
        }

        function addShareUser() {
          const projectName = document.getElementById('shareProjectSelect').value;
          const userName = document.getElementById('shareUserInput').value.trim();
          
          if (!projectName || !userName) {
            alert('プロジェクトとユーザー名を入力してください');
            return;
          }
          
          if (!projectShares[projectName]) {
            projectShares[projectName] = {
              owner: currentUser,
              sharedUsers: []
            };
          }
          
          if (projectShares[projectName].sharedUsers.includes(userName)) {
            alert('このユーザーは既に追加されています');
            return;
          }
          
          projectShares[projectName].sharedUsers.push(userName);
          document.getElementById('shareUserInput').value = '';
          saveAllData(); // 統合保存システムで保存
          console.log('👤 プロジェクト共有ユーザーを追加して保存:', userName, 'to', projectName);
          renderSharedUsers();
        }

        function removeShareUser(projectName, userName) {
          if (projectShares[projectName]) {
            projectShares[projectName].sharedUsers = projectShares[projectName].sharedUsers.filter(u => u !== userName);
            saveAllData(); // 統合保存システムで保存
            console.log('🗑️ プロジェクト共有ユーザーを削除して保存:', userName, 'from', projectName);
            renderSharedUsers();
          }
        }

        function renderSharedUsers() {
          const projectName = document.getElementById('shareProjectSelect').value;
          const container = document.getElementById('sharedUsersList');
          container.innerHTML = '';
          
          if (projectName && projectShares[projectName]) {
            projectShares[projectName].sharedUsers.forEach(user => {
              const div = document.createElement('div');
              div.className = 'flex items-center justify-between bg-gray-50 p-2 rounded';
              div.innerHTML = `
                <span class="text-xs">${user}</span>
                <button type="button" onclick="removeShareUser('${projectName}', '${user}')" 
                  class="text-xs text-red-500 hover:text-red-700">削除</button>
              `;
              container.appendChild(div);
            });
          }
        }

        function saveShareSettings() {
          // ここで共有設定を保存します（実際のアプリケーションではサーバーに送信）
          alert('共有設定を保存しました');
          toggleShareProjectForm();
        }

        function toggleTeamTodoForm() {
          const form = document.getElementById('teamTodoForm');
          form.classList.toggle('hidden');
          if (!form.classList.contains('hidden')) {
            document.getElementById('teamTodoProject').focus();
          } else {
            // フォームをリセット
            document.getElementById('teamTodoProject').value = '';
            document.getElementById('teamDueDate').value = '';
            document.getElementById('teamTodoPriority').value = '';
            document.getElementById('teamTodoText').value = '';
          }
        }

        function addTeamTodo(event) {
          event.preventDefault();
          
          const project = document.getElementById("teamTodoProject").value.trim();
          const dueDate = document.getElementById("teamDueDate").value;
          const priority = document.getElementById("teamTodoPriority").value;
          const todoText = document.getElementById("teamTodoText").value.trim();
          
          if (!project || !dueDate || !priority || !todoText) {
            alert("全ての項目を入力してください");
            return;
          }
          
          teamTodos.push({
            project: project,
            text: todoText,
            dueDate: dueDate,
            priority: priority,
            completed: false,
            createdAt: new Date(),
            createdBy: currentUser
          });
          
          // フォームをリセットして非表示に
          document.getElementById("teamTodoProject").value = "";
          document.getElementById("teamDueDate").value = "";
          document.getElementById("teamTodoPriority").value = "";
          document.getElementById("teamTodoText").value = "";
          toggleTeamTodoForm();
          
          renderTeamTodos();
        }

        function toggleTeamTodo(index) {
          teamTodos[index].completed = !teamTodos[index].completed;
          if (teamTodos[index].completed) {
            // 完了したタスクを削除
            setTimeout(() => {
              teamTodos.splice(index, 1);
              renderTeamTodos();
            }, 500);
          } else {
            renderTeamTodos();
          }
        }

        function renderTeamTodos() {
          const container = document.getElementById("teamProjectTodoLists");
          container.innerHTML = "";
          
          // プロジェクト毎にタスクをグループ化
          const groupedTodos = {};
          teamTodos.filter(todo => !todo.completed).forEach(todo => {
            if (!groupedTodos[todo.project]) {
              groupedTodos[todo.project] = [];
            }
            groupedTodos[todo.project].push(todo);
          });
          
          // プロジェクト毎にタスクを表示
          Object.keys(groupedTodos).forEach(projectName => {
            // プロジェクトへのアクセス権をチェック
            if (!hasProjectAccess(projectName)) return;

            const projectDiv = document.createElement('div');
            projectDiv.className = 'bg-white p-2 rounded shadow-sm text-xs';
            
            // 期限でソート
            const sortedTodos = groupedTodos[projectName].sort((a, b) => {
              return new Date(a.dueDate) - new Date(b.dueDate);
            });
            
            projectDiv.innerHTML = `
              <div class="flex items-center justify-between mb-1.5 pb-1.5 border-b">
                <h3 class="font-semibold">${projectName}</h3>
                <span class="text-gray-500">${sortedTodos.length}件</span>
              </div>
              <div class="space-y-1">
                ${sortedTodos.map((todo, index) => {
                  const isOverdue = new Date(todo.dueDate) < new Date();
                  const priorityColors = {
                    high: 'bg-red-100 text-red-800',
                    medium: 'bg-yellow-100 text-yellow-800',
                    low: 'bg-green-100 text-green-800'
                  };
                  
                  return `
                    <div class="flex items-center gap-1.5 py-0.5 ${isOverdue ? 'text-red-600' : ''}">
                      <input type="checkbox" 
                        onclick="toggleTeamTodo(${teamTodos.indexOf(todo)})" 
                        class="w-3 h-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                      <div class="w-[70px] flex-shrink-0 text-[10px]">
                        ${todo.dueDate}
                      </div>
                      <div class="flex-grow truncate text-[11px]">
                        ${todo.text}
                        <span class="text-[10px] text-gray-500 ml-1">(${todo.createdBy})</span>
                      </div>
                      <span class="flex-shrink-0 text-[10px] ${priorityColors[todo.priority]} px-1 rounded-sm">
                        ${todo.priority === 'high' ? '高' : todo.priority === 'medium' ? '中' : '低'}
                      </span>
                      ${canEditProject(projectName) ? `
                        <button onclick="deleteTeamTodo(${teamTodos.indexOf(todo)})" 
                          class="flex-shrink-0 text-red-500 hover:text-red-700">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m-6 0V5a1 1 0 00-1-1h-4a1 1 0 00-1 1v2" />
                          </svg>
                        </button>
                      ` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            `;
            
            container.appendChild(projectDiv);
          });
        }

        function hasProjectAccess(projectName) {
          // currentUser チェックを削除し、常に true を返すか、別のアクセス制御ロジックを実装
          return true; // currentUser がないので、一旦すべてのプロジェクトにアクセス可能とする
          // if (!projectShares[projectName]) return false;
          // return projectShares[projectName].owner === currentUser || 
          //        projectShares[projectName].sharedUsers.includes(currentUser);
        }

        function canEditProject(projectName) {
          // currentUser チェックを削除し、常に true を返すか、別の編集権限制御ロジックを実装
          return true; // currentUser がないので、一旦すべてのプロジェクトを編集可能とする
          // return projectShares[projectName] && projectShares[projectName].owner === currentUser;
        }

        function deleteTeamTodo(index) {
          const todo = teamTodos[index];
          if (!canEditProject(todo.project)) {
            return;
          }

          // スマート確認UIを作成
          const confirmDiv = document.createElement('div');
          confirmDiv.id = 'delete-team-todo-confirm';
          confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
          confirmDiv.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl">
              <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                  <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">タスクを削除しますか？</h3>
                <div class="bg-gray-50 p-3 rounded mb-4">
                  <p class="text-sm text-gray-700">${todo.text}</p>
                  <p class="text-xs text-blue-600 mt-1">チーム: ${todo.teamName}</p>
                </div>
                <div class="flex justify-center gap-3">
                  <button onclick="confirmDeleteTeamTodo(${index})" 
                    class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors">
                    削除する
                  </button>
                  <button onclick="cancelDeleteTeamTodo()" 
                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">
                    キャンセル
                  </button>
                </div>
              </div>
            </div>
          `;
          
          document.body.appendChild(confirmDiv);
        }

        function confirmDeleteTeamTodo(index) {
          teamTodos.splice(index, 1);
          renderTeamTodos();
          saveAllData();
          cancelDeleteTeamTodo();
        }

        function cancelDeleteTeamTodo() {
          const confirmDiv = document.getElementById('delete-team-todo-confirm');
          if (confirmDiv) {
            confirmDiv.remove();
          }
        }

        // ツール関連の関数
        function hideAllTools() {
          const tools = [
            'resize-tool-content',
            'glass-thickness-tool-content',
            'rainwater-tool-content',
            'function-calculator-content',
            'memo-tool-content'
          ];
          
          tools.forEach(toolId => {
            const element = document.getElementById(toolId);
            if (element) {
              element.style.display = 'none';
            }
          });
        }

        // 修正後の toggle 関数は、まずセクション内の他のツールを隠してから対象を表示/非表示します
        function hideToolContentsInSection(sectionId) {
          const section = document.getElementById(sectionId);
          if (!section) return;
          const toolContents = section.querySelectorAll('.tool-content');
          toolContents.forEach(content => content.style.display = 'none');
        }

        function toggleResizeTool() {
          const sectionId = 'general-tools-area';
          const toolId = 'resize-tool-content';
          const tool = document.getElementById(toolId);
          if (!tool) return;
          const isCurrentlyVisible = tool.style.display === 'block';
          hideToolContentsInSection(sectionId);
          if (!isCurrentlyVisible) {
            tool.style.display = 'block';
            setupDragAndDrop(); // 表示されたときだけ実行
          }
        }

        function toggleGlassThicknessTool() {
          const sectionId = 'design-tools-area';
          const toolId = 'glass-thickness-tool-content';
          const tool = document.getElementById(toolId);
          if (!tool) return;
          const isCurrentlyVisible = tool.style.display === 'block';
          hideToolContentsInSection(sectionId);
          if (!isCurrentlyVisible) {
            tool.style.display = 'block';
          }
        }

        function toggleRainwaterTool() {
          const sectionId = 'design-tools-area';
          const toolId = 'rainwater-tool-content';
          const tool = document.getElementById(toolId);
          if (!tool) return;
          const isCurrentlyVisible = tool.style.display === 'block';
          hideToolContentsInSection(sectionId);
          if (!isCurrentlyVisible) {
            tool.style.display = 'block';
          }
        }

        function toggleFunctionCalculator() {
          const sectionId = 'general-tools-area';
          const toolId = 'function-calculator-content';
          const tool = document.getElementById(toolId);
          if (!tool) return;
          const isCurrentlyVisible = tool.style.display === 'block';
          hideToolContentsInSection(sectionId);
          if (!isCurrentlyVisible) {
            tool.style.display = 'block';
          }
        }

        function toggleMemoTool() {
          const sectionId = 'general-tools-area';
          const toolId = 'memo-tool-content';
          const tool = document.getElementById(toolId);
          if (!tool) return;
          const isCurrentlyVisible = tool.style.display === 'block';
          hideToolContentsInSection(sectionId);
          if (!isCurrentlyVisible) {
            tool.style.display = 'block';
            initializeMemoApp(); // 正しい初期化関数を呼び出す
          }
        }

        function setupDragAndDrop() {
          const dropArea = document.getElementById('drop-area');
          const uploadInput = document.getElementById('upload');
          const fileNameDisplay = document.getElementById('file-name');
          const convertButton = document.getElementById('convert-button');

          dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.style.borderColor = '#000';
          });

          dropArea.addEventListener('dragleave', () => {
            dropArea.style.borderColor = '#ccc';
          });

          dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.style.borderColor = '#ccc';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
              uploadInput.files = files;
              fileNameDisplay.innerHTML = `<div class="mt-3 p-2 bg-gray-100 rounded text-left">
                <p class="text-[11px] text-gray-600 font-medium mb-1">アップロードファイル:</p>
                <div class="text-[12px] text-gray-700">${Array.from(files).map(f => f.name).join('<br>')}</div>
              </div>`;
              convertButton.style.display = 'inline-block';
            }
          });

          uploadInput.addEventListener('change', () => {
            if (uploadInput.files.length > 0) {
              fileNameDisplay.innerHTML = `<div class="mt-3 p-2 bg-gray-100 rounded text-left">
                <p class="text-[11px] text-gray-600 font-medium mb-1">アップロードファイル:</p>
                <div class="text-[12px] text-gray-700">${Array.from(uploadInput.files).map(f => f.name).join('<br>')}</div>
              </div>`;
              convertButton.style.display = 'inline-block';
            }
          });
        }

        function resizeImages() {
          const files = document.getElementById('upload').files;
          const size = parseInt(document.getElementById('size').value);
          const canvas = document.getElementById('canvas');
          const ctx = canvas.getContext('2d');

          if (files.length === 0) return alert('画像を選んでください');

          Array.from(files).forEach((file, index) => {
            const img = new Image();
            const reader = new FileReader();
            reader.onload = function(e) {
              img.onload = function() {
                const aspectRatio = img.width / img.height;
                let newWidth, newHeight;

                if (img.width > img.height) {
                  newWidth = size;
                  newHeight = size / aspectRatio;
                } else {
                  newHeight = size;
                  newWidth = size * aspectRatio;
                }

                canvas.width = newWidth;
                canvas.height = newHeight;
                ctx.drawImage(img, 0, 0, newWidth, newHeight);

                const link = document.createElement('a');
                link.download = `resized_${file.name}`;
                link.href = canvas.toDataURL('image/jpeg');
                link.click();
              };
              img.src = e.target.result;
            };
            reader.readAsDataURL(file);
          });
        }

        // --- END 色彩チェッカー関連 ---

        // --- ガラス厚計算関連の関数 ---
        function calculateGlassThickness() {
          const shortSide = parseFloat(document.getElementById('glass-short-side').value);
          const longSide = parseFloat(document.getElementById('glass-long-side').value);
            const windPressureNm2 = parseFloat(document.getElementById('wind-pressure').value); // N/m^2
          const glassType = document.getElementById('glass-type').value;

            if (isNaN(shortSide) || shortSide <= 0 || isNaN(longSide) || longSide <= 0 || isNaN(windPressureNm2) || windPressureNm2 < 0) {
                alert('有効な寸法と風圧力を入力してください。');
            return;
          }

            // 単位をNとmmに統一
            const windPressureNmm2 = windPressureNm2 / 1000000; // N/mm^2

          // アスペクト比の計算
          const aspectRatio = longSide / shortSide;
          
          // 係数βの決定（JIS R 3109による）
            let beta = 0.75; // デフォルト値 (アスペクト比1)
          if (aspectRatio >= 2) {
            beta = 0.5;
          } else if (aspectRatio > 1) {
                beta = 0.75 - 0.25 * (aspectRatio - 1); // 線形補間
          }

            // 許容応力度の設定 (N/mm^2)
          let allowableStress;
          switch (glassType) {
                case 'float':       allowableStress = 12.0; break;
                case 'tempered':    allowableStress = 35.0; break;
                case 'laminated':   allowableStress = 12.0; break;
                default:            allowableStress = 12.0; // デフォルト
            }

            // ガラス厚さの計算（単位をN, mmで統一）
            // t [mm] = sqrt( (beta * P_Nmm2 * a_mm^2) / sigma_Nmm2 )
            const calculatedThickness = Math.sqrt(
                (beta * windPressureNmm2 * Math.pow(shortSide, 2)) / allowableStress
            );

          // 推奨厚さの決定（規格厚さに切り上げ）
          const standardThicknesses = [3, 4, 5, 6, 8, 10, 12, 15, 19];
            let recommendedThickness = standardThicknesses[standardThicknesses.length - 1]; // Initialize with max
            for (let t of standardThicknesses) {
                if (t >= calculatedThickness) {
                    recommendedThickness = t;
              break;
            }
          }

            // 結果の表示を更新
            const resultDiv = document.getElementById('glass-result');
          const resultContent = document.getElementById('glass-result-content');
            resultDiv.classList.remove('hidden');
            
          resultContent.innerHTML = `
              <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                  <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">計算厚さ</p>
                    <p class="text-2xl font-bold text-gray-800">${calculatedThickness.toFixed(1)} <span class="text-sm">mm</span></p>
            </div>
                  <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">推奨厚さ</p>
                    <p class="text-2xl font-bold text-blue-800">${recommendedThickness} <span class="text-sm">mm</span></p>
                  </div>
                </div>
                <div class="mt-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                  <p class="text-sm text-yellow-800">
                    ※この計算結果は参考値です。実際の設計には、建築基準法や関連法規、その他の要件を考慮してください。
                  </p>
                </div>
            </div>
          `;
        }

        function calculateWindPressure() {
            // Note: Wind pressure calculation elements might not exist in userpage.html
            const regionTypeInput = document.getElementById('region-type');
            const buildingHeightInput = document.getElementById('building-height');
            const basicWindSpeedInput = document.getElementById('basic-wind-speed');
            const windPressureOutput = document.getElementById('wind-pressure'); // Target for output

            if (!regionTypeInput || !buildingHeightInput || !basicWindSpeedInput || !windPressureOutput) {
                console.warn("Wind pressure calculation elements not found. Cannot calculate.");
                return; // 要素がなければ計算しない
            }

            const regionType = parseFloat(regionTypeInput.value);
            const buildingHeight = parseFloat(buildingHeightInput.value);
            const basicWindSpeed = parseFloat(basicWindSpeedInput.value);

            if (isNaN(regionType) || isNaN(buildingHeight) || buildingHeight < 0 || isNaN(basicWindSpeed) || basicWindSpeed < 0) {
                alert('有効な地域区分、建物高さ、基準風速を入力してください。');
                return;
            }

            // 地域区分による粗度係数を設定 (建築基準法施行令 第87条)
            // (簡易的な区分。実際はもっと複雑)
            let Er;
            switch(parseInt(regionType)) { // Ensure integer comparison
                case 1: Er = 1.0; break; // Ⅰ地域 (海岸部)
                case 2: Er = 0.8; break; // Ⅱ地域 (平地部)
                case 3: Er = 0.6; break; // Ⅲ地域 (丘陵部)
                case 4: Er = 0.4; break; // Ⅳ地域 (山岳部) - 簡易的に設定
                default: Er = 0.8; // デフォルトはⅡ地域
            }

            // ガスト影響係数 Gf (一般的な値として1.5を使用 - 告示1454号など参照)
            // 実際は高さや地域区分で変動するが簡易的に固定値とする
            const Gf = 1.5; 

            // 設計用速度圧の計算 q (N/m²) = 0.6 * Er^2 * V0^2 * Gf
            // ※ 厳密には高さ方向分布係数 Ep も考慮するがここでは省略
            const pressure = 0.6 * Math.pow(Er, 2) * Math.pow(basicWindSpeed, 2) * Gf;

            // 計算結果を設計風圧力の入力欄に設定 (N/m^2)
            windPressureOutput.value = Math.round(pressure);
            
            // 計算パネルを閉じる
            toggleWindPressureCalc();
        }
        // --- END ガラス厚計算関連 ---

        // --- 雨水計算関連の関数 ---
        function calculateEavesTrough() {
            const roofArea = parseFloat(document.getElementById('eaves-roof-area').value);
            const rainfallIntensity = parseFloat(document.getElementById('rainfall-intensity').value);

            if (isNaN(roofArea) || roofArea <= 0 || isNaN(rainfallIntensity) || rainfallIntensity <= 0) {
                alert('有効な屋根面積と降雨強度を入力してください。');
                return;
            }

            // 必要排水量 Q (L/min) = 屋根面積 (m^2) * 降雨強度 (mm/h) / 60 
            // 降雨強度 mm/h を L/(min*m^2) に換算 (1 mm/h = 1 L/h/m^2 = 1/60 L/min/m^2)
            const requiredFlowRate = roofArea * rainfallIntensity / 60;

            showRainwaterResult({ eavesFlowRate: requiredFlowRate });
        }

        function calculateDownpipe() {
            const roofArea = parseFloat(document.getElementById('downpipe-roof-area').value);
            const wallArea = parseFloat(document.getElementById('downpipe-wall-area').value) || 0;

            if (isNaN(roofArea) || roofArea < 0 || isNaN(wallArea) || wallArea < 0) {
                alert('有効な受け持ち面積を入力してください。');
                return;
            }

            // 集水面積 A (m^2) = 受け持ち屋根面積 + (受け持ち壁面積 * 0.5)
            const catchmentArea = roofArea + (wallArea * 0.5);

            // 必要断面積 (cm^2) = 集水面積 (m^2) * 1 (cm^2/m^2)
            const requiredCrossSectionArea = catchmentArea; // 1 m^2 あたり 1 cm^2 の簡易計算

            showRainwaterResult({
                verticalArea: requiredCrossSectionArea,
                verticalCatchment: catchmentArea,
                verticalRoof: roofArea,
                verticalWall: wallArea
            });
        }

        function showRainwaterResult(results) {
            const resultDiv = document.getElementById('rainwater-result');
            const resultContent = document.getElementById('rainwater-result-content');
            if (!resultDiv || !resultContent) return;

            resultDiv.classList.remove('hidden');
            let html = '<div class="space-y-4">';

            if (results.eavesFlowRate !== undefined) {
                html += `
                  <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">軒樋計算結果</p>
                    <p class="text-lg font-semibold text-blue-800">必要排水量: ${results.eavesFlowRate.toFixed(1)} L/min</p>
                    <p class="text-xs text-gray-500 mt-1">推奨軒樋サイズ: ${recommendGutterSize(results.eavesFlowRate)}</p>
                  </div>
                `;
            }

            if (results.verticalArea !== undefined) {
                html += `
                  <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">竪樋計算結果 (簡易計算)</p>
                    <p class="text-lg font-semibold text-green-800">必要断面積目安: ${results.verticalArea.toFixed(1)} cm²</p>
                    <p class="text-xs text-gray-500 mt-1">推奨竪樋サイズ: ${recommendDownpipeSize(results.verticalArea)}</p>
                    <div class="text-xs text-gray-500 mt-2">
                      <p>計算根拠:</p>
                      <p>・集水面積: ${results.verticalCatchment.toFixed(1)}㎡</p>
                      <p>  (屋根 ${results.verticalRoof.toFixed(1)}㎡ + 壁 ${results.verticalWall.toFixed(1)}㎡ × 0.5)</p>
                      <p>※1m²あたり1cm²として計算</p>
                  </div>
                </div>
              `;
            }

            html += `
              <div class="mt-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                <p class="text-sm text-yellow-800">
                  ※この計算結果は参考値です。実際の設計には、メーカーの仕様や地域の条例、設置条件等を考慮してください。
                </p>
              </div>
            </div>`;

            resultContent.innerHTML = html;
        }

        // 軒樋の推奨サイズを返す関数 (排水量 L/min に基づく例)
        function recommendGutterSize(flowRate) {
            // これは一般的な目安です。メーカーの製品仕様を確認してください。
            if (flowRate <= 30) return '呼び径 100 (例: 半丸105, 角100)';
            if (flowRate <= 50) return '呼び径 120 (例: 半丸120, 角120)';
            if (flowRate <= 80) return '呼び径 150 (例: 半丸150, 角140)';
            if (flowRate <= 120) return '呼び径 180 (例: 半丸180)';
            return '呼び径 180以上 (要詳細検討)';
        }

        // 竪樋の推奨サイズを返す関数 (必要断面積 cm² に基づく例)
        function recommendDownpipeSize(area) {
            // これは一般的な目安です。メーカーの製品仕様を確認してください。
            if (area <= 28) return '呼び径 60 (φ60)';   // 断面積 約28cm2
            if (area <= 44) return '呼び径 75 (φ75)';   // 断面積 約44cm2
            if (area <= 78) return '呼び径 100 (φ100)'; // 断面積 約78cm2
            if (area <= 113) return '呼び径 120 (φ120)'; // 断面積 約113cm2
            if (area <= 177) return '呼び径 150 (φ150)'; // 断面積 約177cm2
            return '呼び径 150以上 (要詳細検討)';
        }
        // --- END 雨水計算関連 ---

        // --- ここから他のJS関数 (設定、認証など) ---

        // 設定の保存
        function saveSettings() {
        }

        // 設定の読み込み
        function loadSettings() {
        }

        // ページ読み込み時に設定を復元 & イベントリスナー設定
        document.addEventListener('DOMContentLoaded', () => {
          loadSettings();

          // URLパラメータを取得
          const params = new URLSearchParams(window.location.search);
          const sectionParam = params.get('section');

          // パラメータに基づいて表示するセクションを決定
          if (sectionParam) {
              switch (sectionParam) {
                  case 'myhouki':
                      showMyHouki();
                      break;
                  case 'todo':
                      showTodo();
                      break;
                  case 'teamtodo':
                      showTeamTodo();
                      break;
                  case 'generaltools':
                      showGeneralTools();
                      break;
                  case 'designtools':
                      showDesignTools();
                      break;
                  case 'contact':
                      switchSection('contact-area');
                      break;
                  case 'settings':
                      showSettings();
                      break;
                  default:
                      // 不明なパラメータの場合はデフォルト表示
                      showMyCalendar();
              }
          } else {
              // パラメータがない場合はデフォルト表示
              showMyCalendar();
          }
        });

        // ツールカテゴリ表示切り替え関数
        function filterToolButtons(category) {
          const toolButtonsContainer = document.querySelector('#tools-area .tool-buttons');
          if (!toolButtonsContainer) return;

          const allButtons = toolButtonsContainer.querySelectorAll('.tool-button');
          allButtons.forEach(button => {
            if (button.dataset.toolCategory === category) {
              button.style.display = 'inline-block'; // または block
            } else {
              button.style.display = 'none';
            }
          });
        }

        // 一般ツール表示関数
        function showGeneralTools() {
          switchSection('general-tools-area');
          // デフォルトでメモ機能を表示
          setTimeout(() => {
            toggleToolDisplay('general-tools-area', 'memo-tool-content');
          }, 100);
        }

        // 設計ツール表示関数
        function showDesignTools() {
          switchSection('design-tools-area');
          // 必要に応じて、最初に表示するツールをここで指定できます
          // 例: toggleGlassThicknessTool();
        }

        // ツールコンテンツ表示切り替え関数 (toggle***)
        // 各ツールセクション表示時に、その中のツールコンテンツを一旦非表示にする必要がある場合に使用します
        // （現状、各 toggle*** 関数内で個別に display を操作しているため、この関数は必須ではないかもしれません）
        // function hideToolContents(sectionId) {
        //   const section = document.getElementById(sectionId);
        //   if (!section) return;
        //   const toolContents = section.querySelectorAll('.tool-content');
        //   toolContents.forEach(content => content.style.display = 'none');
        // }

        function toggleResizeTool() {
          // 同じセクション内の他のツールを隠す (必要であれば)
          // hideToolContents('general-tools-area'); 
          const tool = document.getElementById('resize-tool-content');
          if (tool) {
            tool.style.display = tool.style.display === 'none' ? 'block' : 'none';
            if (tool.style.display === 'block') {
              setupDragAndDrop(); // 表示されたときだけ実行
            }
          }
        }

        function toggleGlassThicknessTool() {
          // hideToolContents('design-tools-area');
          const tool = document.getElementById('glass-thickness-tool-content');
          if (tool) {
            tool.style.display = tool.style.display === 'none' ? 'block' : 'none';
          }
        }

        function toggleRainwaterTool() {
          // hideToolContents('design-tools-area');
          const tool = document.getElementById('rainwater-tool-content');
          if (tool) {
            tool.style.display = tool.style.display === 'none' ? 'block' : 'none';
          }
        }

        function toggleFunctionCalculator() {
          // hideToolContents('general-tools-area');
          const tool = document.getElementById('function-calculator-content');
          if (tool) {
            tool.style.display = tool.style.display === 'none' ? 'block' : 'none';
          }
        }

        function toggleMemoTool() {
          // hideToolContents('general-tools-area');
          const tool = document.getElementById('memo-tool-content');
          if (tool) {
            tool.style.display = tool.style.display === 'none' ? 'block' : 'none';
            if (tool.style.display === 'block') { // メモツールが表示されたときのみ初期化
              initializeMemoApp(); // 正しい初期化関数を呼び出す
            }
          }
        }

        // --- ツール表示切り替えロジック --- 
        function hideToolContentsInSection(sectionId) {
          const section = document.getElementById(sectionId);
          if (!section) {
            console.error("Section not found for hiding tools:", sectionId);
            return;
          }
          const toolContents = section.querySelectorAll('.tool-content');
          toolContents.forEach(content => {
            content.style.display = 'none'; 
          });
        }

        function toggleToolDisplay(sectionId, toolId) {
          const tool = document.getElementById(toolId);
          if (!tool) {
            console.error("Tool content not found:", toolId);
            return;
          }

          const isCurrentlyVisible = tool.style.display === 'block';

          // まず、指定されたセクション内のすべてのツールコンテンツを非表示にする
          hideToolContentsInSection(sectionId);

          // もしクリックされたツールが元々非表示だった場合のみ、表示する
          if (!isCurrentlyVisible) {
            tool.style.display = 'block';
            // ツールごとの初期化処理
            if (toolId === 'resize-tool-content') {
              setupDragAndDrop();
            } else if (toolId === 'function-calculator-content') {
              initializeCalculator();
            } else if (toolId === 'memo-tool-content') {
              initializeMemoApp();
            } else if (toolId === 'color-checker-content') { 
              initializeColorChecker(); 
            } else if (toolId === 'unit-volume-tool-content') {
              initializeUnitVolumeTool();
            }
          }
          // 元々表示されていた場合は、hideToolContentsInSection で隠されたままになる
        }
        // --- 既存の toggle***Tool 関数群は削除 --- 

      // --- ここから色彩提案ツールの関数 ---
      function hexToRgb(hex) {
        let r = 0, g = 0, b = 0;
        if (hex.length == 4) {
          r = parseInt(hex[1] + hex[1], 16);
          g = parseInt(hex[2] + hex[2], 16);
          b = parseInt(hex[3] + hex[3], 16);
        } else if (hex.length == 7) {
          r = parseInt(hex[1] + hex[2], 16);
          g = parseInt(hex[3] + hex[4], 16);
          b = parseInt(hex[5] + hex[6], 16);
        }
        return { r, g, b };
      }

      function rgbToHsl(r, g, b) {
        r /= 255; g /= 255; b /= 255;
        const max = Math.max(r, g, b), min = Math.min(r, g, b);
        let h, s, l = (max + min) / 2;

        if (max == min) {
          h = s = 0; // achromatic
        } else {
          const d = max - min;
          s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
          switch (max) {
            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
            case g: h = (b - r) / d + 2; break;
            case b: h = (r - g) / d + 4; break;
          }
          h /= 6;
        }
        return { h: h * 360, s: s * 100, l: l * 100 };
      }

      function hslToRgb(h, s, l) {
        h /= 360; s /= 100; l /= 100;
        let r, g, b;

        if (s == 0) {
          r = g = b = l; // achromatic
        } else {
          const hue2rgb = (p, q, t) => {
            if (t < 0) t += 1;
            if (t > 1) t -= 1;
            if (t < 1 / 6) return p + (q - p) * 6 * t;
            if (t < 1 / 2) return q;
            if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
            return p;
          };
          const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
          const p = 2 * l - q;
          r = hue2rgb(p, q, h + 1 / 3);
          g = hue2rgb(p, q, h);
          b = hue2rgb(p, q, h - 1 / 3);
        }
        return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) };
      }

      function rgbToHex(r, g, b) {
        return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
      }

      function getLuminance(r, g, b) {
        const a = [r, g, b].map(v => {
          v /= 255;
          return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
        });
        return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
      }

      function getContrastRatio(rgb1, rgb2) {
        const lum1 = getLuminance(rgb1.r, rgb1.g, rgb1.b);
        const lum2 = getLuminance(rgb2.r, rgb2.g, rgb2.b);
        const brightest = Math.max(lum1, lum2);
        const darkest = Math.min(lum1, lum2);
        return (brightest + 0.05) / (darkest + 0.05);
      }

      function suggestColorCombinations(baseHex) {
        document.getElementById('base-color-value').textContent = baseHex.toUpperCase();
        const baseRgb = hexToRgb(baseHex);
        const baseHsl = rgbToHsl(baseRgb.r, baseRgb.g, baseRgb.b);
        const suggestionsDiv = document.getElementById('color-suggestions');
        suggestionsDiv.innerHTML = ''; // Clear previous suggestions

        const schemes = [
          { name: '補色 (Complementary)', angle: 180 },
          { name: '類似色 (Analogous)', angle: 30 },
          { name: 'トライアド (Triadic)', angle: 120 },
          { name: '分割補色 (Split Complementary)', angle: 150 },
          { name: 'テトラード (Tetradic/Rectangular)', angle: 60 } // Tetradic usually involves multiple steps
        ];

        schemes.forEach(scheme => {
          const card = document.createElement('div');
          card.className = 'bg-gray-50 p-2 rounded-lg border border-gray-200 flex-grow'; // p-4 を p-2 に変更, flex-grow追加
          let colorsHtml = `<h4 class="text-sm font-semibold text-gray-700 mb-2">${scheme.name}</h4>`; // mb-3 を mb-2 に変更
          colorsHtml += '<div class="flex flex-col gap-1 mb-2">'; // flex-wrap gap-2 mb-3 から flex flex-col gap-1 mb-2 に変更

          let suggestedColors = []; // ★ 基準色を含めずに空で初期化

          if (scheme.name === '類似色 (Analogous)') {
            const hsl1 = { ...baseHsl, h: (baseHsl.h - scheme.angle + 360) % 360 };
            const hsl2 = { ...baseHsl, h: (baseHsl.h + scheme.angle) % 360 };
            const rgb1 = hslToRgb(hsl1.h, hsl1.s, hsl1.l);
            const rgb2 = hslToRgb(hsl2.h, hsl2.s, hsl2.l);
            suggestedColors.push(rgbToHex(rgb1.r, rgb1.g, rgb1.b));
            suggestedColors.push(rgbToHex(rgb2.r, rgb2.g, rgb2.b));
          } else if (scheme.name === 'トライアド (Triadic)') {
            const hsl1 = { ...baseHsl, h: (baseHsl.h + scheme.angle) % 360 };
            const hsl2 = { ...baseHsl, h: (baseHsl.h + 2 * scheme.angle) % 360 };
            const rgb1 = hslToRgb(hsl1.h, hsl1.s, hsl1.l);
            const rgb2 = hslToRgb(hsl2.h, hsl2.s, hsl2.l);
            suggestedColors.push(rgbToHex(rgb1.r, rgb1.g, rgb1.b));
            suggestedColors.push(rgbToHex(rgb2.r, rgb2.g, rgb2.b));
          } else if (scheme.name === '分割補色 (Split Complementary)') {
            const complementHsl = { ...baseHsl, h: (baseHsl.h + 180) % 360 };
            const hsl1 = { ...complementHsl, h: (complementHsl.h - 30 + 360) % 360 };
            const hsl2 = { ...complementHsl, h: (complementHsl.h + 30) % 360 };
            const rgb1 = hslToRgb(hsl1.h, hsl1.s, hsl1.l);
            const rgb2 = hslToRgb(hsl2.h, hsl2.s, hsl2.l);
            suggestedColors.push(rgbToHex(rgb1.r, rgb1.g, rgb1.b));
            suggestedColors.push(rgbToHex(rgb2.r, rgb2.g, rgb2.b));
          } else if (scheme.name === 'テトラード (Tetradic/Rectangular)') {
             const hsl1 = { ...baseHsl, h: (baseHsl.h + scheme.angle) % 360 };
             const hsl2 = { ...baseHsl, h: (baseHsl.h + 180) % 360 };
             const hsl3 = { ...baseHsl, h: (baseHsl.h + 180 + scheme.angle) % 360 };
             const rgb1 = hslToRgb(hsl1.h, hsl1.s, hsl1.l);
             const rgb2 = hslToRgb(hsl2.h, hsl2.s, hsl2.l);
             const rgb3 = hslToRgb(hsl3.h, hsl3.s, hsl3.l);
             suggestedColors.push(rgbToHex(rgb1.r, rgb1.g, rgb1.b));
             suggestedColors.push(rgbToHex(rgb2.r, rgb2.g, rgb2.b));
             suggestedColors.push(rgbToHex(rgb3.r, rgb3.g, rgb3.b));
          } else { // Complementary and others with a single angle shift
            const hsl1 = { ...baseHsl, h: (baseHsl.h + scheme.angle) % 360 };
            const rgb1 = hslToRgb(hsl1.h, hsl1.s, hsl1.l);
            suggestedColors.push(rgbToHex(rgb1.r, rgb1.g, rgb1.b));
          }


          suggestedColors.forEach(hex => {
            const rgb = hexToRgb(hex); // HEXからRGBに変換
            colorsHtml += `<div class="flex items-center gap-2">
                           <div class="w-12 h-6 rounded border border-gray-300 flex-shrink-0" style="background-color: ${hex};"></div>
                           <span class="text-[10px] font-mono text-gray-600">${hex}</span>
                           <span class="text-[10px] text-gray-500 ml-1">R${rgb.r} G${rgb.g} B${rgb.b}</span>
                         </div>`;
          });
          colorsHtml += '</div>';

          card.innerHTML = colorsHtml;
          suggestionsDiv.appendChild(card);
        });
      }

      // --- カラーパレット生成・処理関数 ---
      function generateColorPalette() {
        const paletteContainer = document.getElementById('color-palette');
        if (!paletteContainer) return;

        // Tailwind CSS v3 Default Colors (参考)
        const tailwindColors = {
          gray: { 50: "#F9FAFB", 100: "#F3F4F6", 200: "#E5E7EB", 300: "#D1D5DB", 400: "#9CA3AF", 500: "#6B7280", 600: "#4B5563", 700: "#374151", 800: "#1F2937", 900: "#111827" },
          red: { 50: "#FEF2F2", 100: "#FEE2E2", 200: "#FECACA", 300: "#FCA5A5", 400: "#F87171", 500: "#EF4444", 600: "#DC2626", 700: "#B91C1C", 800: "#991B1B", 900: "#7F1D1D" },
          orange: { 50: "#FFF7ED", 100: "#FFEDD5", 200: "#FED7AA", 300: "#FDBA74", 400: "#FB923C", 500: "#F97316", 600: "#EA580C", 700: "#C2410C", 800: "#9A3412", 900: "#7C2D12" },
          amber: { 50: "#FFFBEB", 100: "#FEF3C7", 200: "#FDE68A", 300: "#FCD34D", 400: "#FBBF24", 500: "#F59E0B", 600: "#D97706", 700: "#B45309", 800: "#92400E", 900: "#78350F" },
          yellow: { 50: "#FEFCE8", 100: "#FEF9C3", 200: "#FEF08A", 300: "#FDE047", 400: "#FACC15", 500: "#EAB308", 600: "#CA8A04", 700: "#A16207", 800: "#854D0E", 900: "#713F12" },
          lime: { 50: "#F7FEE7", 100: "#ECFCCB", 200: "#D9F99D", 300: "#BEF264", 400: "#A3E635", 500: "#84CC16", 600: "#65A30D", 700: "#4D7C0F", 800: "#3F6212", 900: "#365314" },
          green: { 50: "#F0FDF4", 100: "#DCFCE7", 200: "#BBF7D0", 300: "#86EFAC", 400: "#4ADE80", 500: "#22C55E", 600: "#16A34A", 700: "#15803D", 800: "#166534", 900: "#14532D" },
          emerald: { 50: "#ECFDF5", 100: "#D1FAE5", 200: "#A7F3D0", 300: "#6EE7B7", 400: "#34D399", 500: "#10B981", 600: "#059669", 700: "#047857", 800: "#065F46", 900: "#064E3B" },
          teal: { 50: "#F0FDFA", 100: "#CCFBF1", 200: "#99F6E4", 300: "#5EEAD4", 400: "#2DD4BF", 500: "#14B8A6", 600: "#0D9488", 700: "#0F766E", 800: "#115E59", 900: "#134E4A" },
          cyan: { 50: "#ECFEFF", 100: "#CFFAFE", 200: "#A5F3FC", 300: "#67E8F9", 400: "#22D3EE", 500: "#06B6D4", 600: "#0891B2", 700: "#0E7490", 800: "#155E75", 900: "#164E63" },
          sky: { 50: "#F0F9FF", 100: "#E0F2FE", 200: "#BAE6FD", 300: "#7DD3FC", 400: "#38BDF8", 500: "#0EA5E9", 600: "#0284C7", 700: "#0369A1", 800: "#075985", 900: "#0C4A6E" },
          blue: { 50: "#EFF6FF", 100: "#DBEAFE", 200: "#BFDBFE", 300: "#93C5FD", 400: "#60A5FA", 500: "#3B82F6", 600: "#2563EB", 700: "#1D4ED8", 800: "#1E40AF", 900: "#1E3A8A" },
          indigo: { 50: "#EEF2FF", 100: "#E0E7FF", 200: "#C7D2FE", 300: "#A5B4FC", 400: "#818CF8", 500: "#6366F1", 600: "#4F46E5", 700: "#4338CA", 800: "#3730A3", 900: "#312E81" },
          violet: { 50: "#F5F3FF", 100: "#EDE9FE", 200: "#DDD6FE", 300: "#C4B5FD", 400: "#A78BFA", 500: "#8B5CF6", 600: "#7C3AED", 700: "#6D28D9", 800: "#5B21B6", 900: "#4C1D95" },
          purple: { 50: "#FAF5FF", 100: "#F3E8FF", 200: "#E9D5FF", 300: "#D8B4FE", 400: "#C084FC", 500: "#A855F7", 600: "#9333EA", 700: "#7E22CE", 800: "#6B21A8", 900: "#581C87" },
          fuchsia: { 50: "#FDF4FF", 100: "#FAE8FF", 200: "#F5D0FE", 300: "#F0ABFC", 400: "#E879F9", 500: "#D946EF", 600: "#C026D3", 700: "#A21CAF", 800: "#86198F", 900: "#701A75" },
          pink: { 50: "#FDF2F8", 100: "#FCE7F3", 200: "#FBCFE8", 300: "#F9A8D4", 400: "#F472B6", 500: "#EC4899", 600: "#DB2777", 700: "#BE185D", 800: "#9D174D", 900: "#831843" },
          rose: { 50: "#FFF1F2", 100: "#FFE4E6", 200: "#FECDD3", 300: "#FDA4AF", 400: "#FB7185", 500: "#F43F5E", 600: "#E11D48", 700: "#BE123C", 800: "#9F1239", 900: "#881337" }
        };

        // パレットのHTMLを生成
        let paletteHTML = '<div class="grid gap-0.5" style="grid-template-columns: repeat(' + Object.keys(tailwindColors).length + ', minmax(0, 1fr));">'; // 列数は色の種類の数

        const shades = [50, 100, 200, 300, 400, 500, 600, 700, 800, 900]; // 表示する明度

        // 色の行
        shades.forEach(shade => {
          Object.keys(tailwindColors).forEach(colorName => {
            const hex = tailwindColors[colorName][shade];
            if (hex) {
              paletteHTML += `<div class="w-full h-5 rounded-sm border border-gray-100 cursor-pointer hover:scale-110 hover:shadow transition-transform" 
                               style="background-color: ${hex};" 
                               data-color="${hex}" 
                               title="${colorName}-${shade}: ${hex}">
                           </div>`;
            } else {
              paletteHTML += '<div></div>'; // 色が存在しない場合は空のセル
            }
          });
        });

        paletteHTML += '</div>';
        paletteContainer.innerHTML = paletteHTML;

        // パレットへのクリックイベントリスナーを追加 (イベント委任)
        paletteContainer.addEventListener('click', function(event) {
          const target = event.target;
          if (target.dataset.color) { // クリックされたのが色見本か確認
            const selectedColor = target.dataset.color;
            const colorPicker = document.getElementById('base-color-picker');
            const colorValueSpan = document.getElementById('base-color-value');
            
            if(colorPicker) colorPicker.value = selectedColor;
            if(colorValueSpan) colorValueSpan.textContent = selectedColor.toUpperCase();
            suggestColorCombinations(selectedColor);
          }
        });
      }

      // ツール表示時にパレットを生成
      function initializeColorChecker() {
         generateColorPalette();
         const initialColor = document.getElementById('base-color-picker').value;
         suggestColorCombinations(initialColor);
      }
      // --- 色彩提案ツールの関数ここまで ---

      // --- カラーパレット表示切り替え関数 ---
      function toggleColorPalette() {
        const palette = document.getElementById('color-palette');
        if (palette) {
          palette.classList.toggle('hidden');
        }
      }
      // --- 単位体積重量計算ツールの関数 ---
      const materials = [
        { name: "水", weight: 1000 },
        { name: "コンクリート（普通）", weight: 2300 },
        { name: "コンクリート（軽量）", weight: 1800 },
        { name: "鉄", weight: 7850 },
        { name: "アルミニウム", weight: 2700 },
        { name: "ステンレス鋼", weight: 7930 },
        { name: "ガラス", weight: 2500 },
        { name: "木材（杉）", weight: 400 },
        { name: "木材（檜）", weight: 450 },
        { name: "木材（松）", weight: 550 },
        { name: "アスファルト", weight: 2200 },
        { name: "土（乾燥）", weight: 1600 },
        { name: "土（湿潤）", weight: 1800 },
        { name: "砂利", weight: 1700 },
        { name: "砂", weight: 1600 },
        { name: "レンガ", weight: 1800 },
        { name: "石膏ボード (12.5mm)", weight: 9.5 }, // これは面積あたりの重量 (kg/m2) の例
        { name: "合板 (12mm)", weight: 7 }, // これも面積あたりの重量 (kg/m2) の例
        // 必要に応じて他の材料を追加
      ];

      function initializeUnitVolumeTool() {
        const selectElement = document.getElementById('material-select');
        if (!selectElement) return;

        selectElement.innerHTML = '<option value="">材料を選択してください</option>'; // デフォルトオプションを追加

        materials.forEach((material, index) => {
          const option = document.createElement('option');
          option.value = index; // インデックスを値として使用
          // 面積あたりの重量を持つ材料には注記を追加
          const displayName = material.weight < 100 ? `${material.name} (kg/m²)` : material.name;
          option.textContent = displayName;
          selectElement.appendChild(option);
        });

        // 選択肢が変更されたときに単位重量表示を更新するリスナーを追加
        selectElement.addEventListener('change', displaySelectedUnitWeight);
        // 初期表示のために呼び出し
        displaySelectedUnitWeight(); 
      }

      function displaySelectedUnitWeight() {
        const selectElement = document.getElementById('material-select');
        const unitWeightDisplay = document.getElementById('unit-weight-display');
        if (!selectElement || !unitWeightDisplay) return;

        const selectedIndex = selectElement.value;
        if (selectedIndex !== "") {
          const selectedMaterial = materials[parseInt(selectedIndex)];
          // 面積あたりの重量か体積あたりの重量かで表示を分ける
          if (selectedMaterial.weight < 100) {
            unitWeightDisplay.textContent = `単位重量: ${selectedMaterial.weight} kg/m²`;
          } else {
            unitWeightDisplay.textContent = `単位体積重量: ${selectedMaterial.weight} kg/m³`;
          }
        } else {
          unitWeightDisplay.textContent = ''; // 何も選択されていない場合はクリア
        }
         // 結果表示もリセット
         const resultElement = document.getElementById('material-weight-result');
         if (resultElement) resultElement.textContent = '- kg';
      }

      function calculateMaterialWeight() {
        const selectElement = document.getElementById('material-select');
        const widthInput = document.getElementById('material-width');
        const depthInput = document.getElementById('material-depth');
        const heightInput = document.getElementById('material-height');
        const resultElement = document.getElementById('material-weight-result');

        if (!selectElement || !widthInput || !depthInput || !heightInput || !resultElement) {
            console.error("単位体積計算に必要な要素が見つかりません。");
            return;
        }

        const selectedIndex = selectElement.value;
        const width = parseFloat(widthInput.value) || 0;
        const depth = parseFloat(depthInput.value) || 0;
        const height = parseFloat(heightInput.value) || 0;

        if (selectedIndex === "") {
          alert('材料を選択してください。');
          resultElement.textContent = '- kg';
          return;
        }

        if (width <= 0 || depth <= 0 || height <= 0) {
          alert('有効な寸法（幅、奥行、高さ）をmm単位で入力してください。');
          resultElement.textContent = '- kg';
          return;
        }

        const selectedMaterial = materials[parseInt(selectedIndex)];
        const unitWeight = selectedMaterial.weight;

        let calculatedWeight;

        // 単位重量が小さい値（例: 100未満）の場合は面積計算と仮定
        if (unitWeight < 100) {
           // 面積 (m^2) = 幅 (m) * 奥行 (m) --- 高さは無視
           const areaM2 = (width / 1000) * (depth / 1000);
           calculatedWeight = areaM2 * unitWeight;
           resultElement.textContent = `${calculatedWeight.toFixed(2)} kg (面積計算)`;
        } else {
          // 体積 (m^3) = 幅 (m) * 奥行 (m) * 高さ (m)
          const volumeM3 = (width / 1000) * (depth / 1000) * (height / 1000);
          // 重量 (kg) = 体積 (m^3) * 単位体積重量 (kg/m^3)
          calculatedWeight = volumeM3 * unitWeight;
          resultElement.textContent = `${calculatedWeight.toFixed(2)} kg`;
        }
         // 単位重量表示も更新しておく
         // displaySelectedUnitWeight(); // ← この行をコメントアウト
      }

      // ページ読み込み時、またはツールが表示されるタイミングで材料リストを初期化
      // toggleToolDisplay 関数内で unit-volume-tool-content が表示される際に呼ぶように変更済みなので、
      // ここでの DOMContentLoaded 内の呼び出しは不要な場合もあります。
      // document.addEventListener('DOMContentLoaded', initializeUnitVolumeTool); 
      // --- 単位体積重量計算ツールの関数ここまで ---

      // --- ▼▼▼ 関数電卓の関数 ▼▼▼ ---
      let calculatorCurrentInput = '';
      let calculatorExpressionValue = '';
      let calculatorHistory = []; // 計算履歴用配列
      let lastAns = 0; // Store the last answer
      let justCalculated = false; // Flag to check if the last action was '='

      // Helper function to convert degrees to radians
      function degToRad(degrees) {
        return degrees * (Math.PI / 180);
      }

      // ★★★ 新しい三角関数処理オブジェクトを追加 ★★★
      const trigFunctions = {
        sin: (x) => Math.sin(degToRad(x)),
        cos: (x) => Math.cos(degToRad(x)),
        tan: (x) => Math.tan(degToRad(x)),
        // 必要に応じて他の関数 (例: log10, ln, sqrt) もここに追加可能
        log: (x) => Math.log10(x), // log は log10 とする
        ln: (x) => Math.log(x),    // ln は自然対数
        '√': (x) => Math.sqrt(x)   // √ は sqrt
      };

      // ★★★ 新しい安全な評価関数を追加 ★★★
      function safeEvaluate(expression) {
        try {
          // 0. Clean up expression: remove extra spaces, handle consecutive operators (e.g., 5 * - 2 -> 5 * -2)
          expression = expression.replace(/\s+/g, ''); // Remove all spaces
          // Be careful with replacing operators, might need more sophisticated logic for order of operations
          // Example: handle `--` -> `+`? `+-` -> `-`?
          // For now, focus on function evaluation and basic security.

          // 1. 関数呼び出し (例: sin(30), log(100)) を先に評価 (再帰的に)
          //    正規表現を改善し、ネストされた括弧にも対応できるように試みる (限定的)
          const evaluateFunctions = (expr) => {
             return expr.replace(/(sin|cos|tan|log|ln|√)\s*\(([^()]*|\([^()]*\))*\)/g, (match, func, arg) => {
                 try {
                     // 引数部分を再帰的に評価
                     const argValue = evaluateFunctions(arg); // Use evaluateFunctions recursively
                     const numArg = safeEvaluateBasicOpsOnly(argValue); // Evaluate argument using basic ops only

                     if (trigFunctions[func]) {
                         if (func === 'tan' && Math.abs(numArg % 180) === 90) {
                             throw new Error('Math Error: tan(90)');
                         }
                         const funcResult = trigFunctions[func](numArg);
                         if (isNaN(funcResult)) throw new Error(`Math Error: ${func}(${numArg})`);
                         return funcResult;
                     } else {
                          throw new Error(`Unknown function: ${func}`);
                     }
                 } catch(e) {
                     // If function evaluation fails, re-throw or return an error indicator
                     console.error(`Error evaluating function ${func}(${arg}):`, e);
                     throw e; // Re-throw the error
                 }
             });
          };
          expression = evaluateFunctions(expression);


          // 2. 累乗 (^) を Math.pow に置換 (右結合性を考慮したループ)
          // 注意: 複雑な式や演算子の優先順位は完全には考慮できない
          while (expression.includes('^')) {
               // Find the rightmost exponentiation
               let lastIndex = expression.lastIndexOf('^');
               // Find the base (number before ^)
               let baseMatch = expression.substring(0, lastIndex).match(/([\d\.\+\-eE]+)$/);
               // Find the exponent (number after ^)
               let expMatch = expression.substring(lastIndex + 1).match(/^([\d\.\+\-eE]+)/);

               if (baseMatch && expMatch) {
                   let base = baseMatch[1];
                   let exponent = expMatch[1];
                   let baseStart = lastIndex - base.length;
                   let expEnd = lastIndex + 1 + exponent.length;

                   // Ensure base and exponent are numbers
                   const baseNum = parseFloat(base);
                   const expNum = parseFloat(exponent);
                   if (isNaN(baseNum) || isNaN(expNum)) {
                       throw new Error(`Invalid base or exponent: ${base}^${exponent}`);
                   }

                   let powResult = Math.pow(baseNum, expNum);
                   if (isNaN(powResult)) throw new Error('Math Error: Exponentiation resulted in NaN');

                   // Replace the section with the result
                   expression = expression.substring(0, baseStart) + powResult.toString() + expression.substring(expEnd);
               } else {
                    throw new Error('Invalid exponentiation syntax'); // Could not parse base or exponent
               }
           }


          // 3. 残った基本的な四則演算を評価 (安全な文字のみ許可)
          return safeEvaluateBasicOpsOnly(expression);

        } catch (err) {
          console.error("safeEvaluate Error:", err, "Original expression:", expression);
          // エラーメッセージをスローして calculatorInput で捕捉
          throw err; 
        }
      }

      // ★★★ 基本的な四則演算のみを評価する補助関数 ★★★
      function safeEvaluateBasicOpsOnly(expression) {
           try {
                // 安全な文字のみ許可 (数字, ., +, -, *, /, (, ), e, E)
                // Math.pow や他の関数はここでは許可しない
                 if (!/^[\d\s\.\+\-\*\/\(\)!%eE]*$/.test(expression)) {
                   // 簡易的なチェック。より厳密なパーサーが望ましい。
                   // 意図しない文字が含まれている場合はエラー
                   console.warn("safeEvaluateBasicOpsOnly blocked potentially unsafe characters in:", expression);
                   throw new Error('Invalid characters for basic calculation');
                }

                // Functionコンストラクタで最終評価
                const calculate = new Function(`return ${expression}`);
                const result = calculate();

                if (isNaN(result)) {
                     throw new Error('Calculation resulted in NaN');
                 }
                 // Infinity はそのまま返すか、エラーにするか選択
                 if (!isFinite(result)) {
                     // throw new Error('Result is Infinity');
                     return result; // Infinity を返す場合
                 }

                return result;
           } catch (basicErr) {
                console.error("safeEvaluateBasicOpsOnly Error:", basicErr, "Expression:", expression);
                // エラーを再スローして safeEvaluate で捕捉されるようにする
                throw basicErr;
           }
      }


      function calculatorInput(value) {
        const display = document.getElementById('calculator-display');
        const expressionDisplay = document.getElementById('calculator-expression');
        if (!display || !expressionDisplay) return;

        // AC (All Clear)
        if (value === 'AC') {
          calculatorCurrentInput = '';
          calculatorExpressionValue = '';
          display.value = '0'; // Show 0 instead of empty
          expressionDisplay.value = '';
          justCalculated = false; // Reset flag
        }
        // DEL (Delete)
        else if (value === 'DEL') {
          if (justCalculated) { // If deleting from a result, start fresh
              calculatorCurrentInput = '';
          }
          calculatorCurrentInput = calculatorCurrentInput.slice(0, -1);
          display.value = calculatorCurrentInput || '0'; // Show 0 if empty
          justCalculated = false; // Reset flag
        }
        // (-) Toggle Sign
        else if (value === '(-)') {
          if (justCalculated) { // If toggling sign after result, start fresh
             calculatorCurrentInput = '';
             justCalculated = false;
          }
          if (calculatorCurrentInput !== '') {
            // Toggle sign of the current number input
            if (calculatorCurrentInput.startsWith('-')) {
                calculatorCurrentInput = calculatorCurrentInput.substring(1);
            } else {
                calculatorCurrentInput = '-' + calculatorCurrentInput;
            }
            display.value = calculatorCurrentInput;
          } else {
             // Allow starting with minus sign if expression is empty or ends with operator/paren
             if (calculatorExpressionValue === '' || /[\\+\\-\\*\\/\\(\\^]$/.test(calculatorExpressionValue.trim())) {
                 calculatorCurrentInput = '-';
                 display.value = calculatorCurrentInput;
             }
          }
        }
        // Ans
        else if (value === 'Ans') {
           if (justCalculated) { // Start new input if after =
               calculatorCurrentInput = '';
               justCalculated = false;
           }
           calculatorCurrentInput += lastAns.toString();
           display.value = calculatorCurrentInput;
        }
        // Numbers and decimal point
        else if (!isNaN(value) || value === '.') {
           if (justCalculated) {
               calculatorCurrentInput = ''; // Clear previous result
               expressionDisplay.value = ''; // Also clear expression display
               calculatorExpressionValue = '';
               justCalculated = false;
           }
           // Prevent multiple decimal points in the current input segment
           if (value === '.' && calculatorCurrentInput.includes('.')) return;
          calculatorCurrentInput += value;
          display.value = calculatorCurrentInput;
        }
        // Operators (+, -, ×, ÷, ^)
        else if (['+', '-', '×', '÷', '^'].includes(value)) {
          // Append current input to expression if it exists
          if (calculatorCurrentInput !== '') {
            calculatorExpressionValue += calculatorCurrentInput;
            calculatorCurrentInput = '';
          }

          // Replace display operators with calculation operators
          let operator = value;
          if (value === '×') operator = '*';
          if (value === '÷') operator = '/';

          // Add operator to expression (avoid double operators, allow negative sign)
          if (calculatorExpressionValue !== '' && !/[\\+\\-\\*\\/\\^]$/.test(calculatorExpressionValue.trim())) {
              calculatorExpressionValue += operator;
          } else if (value === '-' && calculatorExpressionValue === '') {
              // Allow starting expression with negative
              calculatorExpressionValue += operator;
          } else if (calculatorExpressionValue !== '' && /[\\+\\-\\*\\/\\^]$/.test(calculatorExpressionValue.trim()) && value === '-') {
              // Allow changing operator to negative e.g., 5 * - 2
              calculatorExpressionValue += operator;
          } else if (calculatorExpressionValue !== '' && /[\\+\\-\\*\\/\\^]$/.test(calculatorExpressionValue.trim())) {
              // Replace last operator if not adding a negative sign
              calculatorExpressionValue = calculatorExpressionValue.trim().slice(0,-1) + operator;
          } else if (calculatorExpressionValue === '') {
               // Handle case where only Ans was pressed then an operator
               calculatorExpressionValue = lastAns.toString() + operator;
          }


          expressionDisplay.value = calculatorExpressionValue; // Update expression display
          display.value = ''; // Clear current number display
          justCalculated = false; // Reset flag
        }
        // Square (x²)
        else if (value === 'x²') {
             if (calculatorCurrentInput !== '') {
                  // Append as ^2 to the expression
                  calculatorExpressionValue += calculatorCurrentInput + '^2';
                  expressionDisplay.value = calculatorExpressionValue;
                  calculatorCurrentInput = ''; // Clear current input
                  display.value = '';
                  justCalculated = false;
              } else if (calculatorExpressionValue !== '') {
                   // Or apply to the last number/result in the expression (more complex logic needed)
                   // Simplified: Apply ^2 to the whole expression (may not be mathematically correct)
                   // calculatorExpressionValue = `(${calculatorExpressionValue})^2`;
                   // Better: just append ^2, evaluate later
                   calculatorExpressionValue += '^2';
                   expressionDisplay.value = calculatorExpressionValue;
                   justCalculated = false;
              }
        }
        // Functions requiring parenthesis (√, log, ln, sin, cos, tan)
        else if (['√', 'log', 'ln', 'sin', 'cos', 'tan'].includes(value)) {
             if (justCalculated) { // Start new expression if after =
                 calculatorExpressionValue = ''; // Clear expression
                 expressionDisplay.value = '';
                 justCalculated = false;
             }
             // Append function name and opening parenthesis
            if (calculatorCurrentInput !== '') {
                calculatorExpressionValue += calculatorCurrentInput; // Add current input before function
                calculatorCurrentInput = '';
            }
            calculatorExpressionValue += value + '(';
            expressionDisplay.value = calculatorExpressionValue;
            display.value = ''; // Clear current input display
            justCalculated = false;
        }
        // Parentheses
         else if (value === '(' || value === ')') {
             if (justCalculated) { // Start new expression if after =
                 calculatorCurrentInput = '';
                 calculatorExpressionValue = '';
                 expressionDisplay.value = '';
                 justCalculated = false;
             }
             if (calculatorCurrentInput !== '') {
                 calculatorExpressionValue += calculatorCurrentInput; // Add current input before parenthesis
                 calculatorCurrentInput = '';
             }
             calculatorExpressionValue += value;
             expressionDisplay.value = calculatorExpressionValue;
             display.value = ''; // Clear current input display
             justCalculated = false;
         }
        // Equals (=)
        else if (value === '=') {
          if (calculatorExpressionValue === '' && calculatorCurrentInput === '') return; // Nothing to calculate

          // Append the final number input to the expression
          if (calculatorCurrentInput !== '') {
               calculatorExpressionValue += calculatorCurrentInput;
               calculatorCurrentInput = ''; // Clear current input after appending
          }

          // Replace display operators with calculation operators for evaluation
          let expressionToEvaluate = calculatorExpressionValue
              .replace(/×/g, '*')
              .replace(/÷/g, '/');
              // Power (^) and functions (sin, cos, etc.) handled by safeEvaluate

          try {
              // Use the refined safeEvaluate function
              console.log("Calling safeEvaluate with:", expressionToEvaluate); // Debugging
              const result = safeEvaluate(expressionToEvaluate);
              const displayResult = Number.isFinite(result) ? result : result.toString(); // Handle Infinity display

              display.value = displayResult;
              lastAns = Number.isFinite(result) ? result : 0; // Store finite results for Ans
              // Add to history
              calculatorHistory.push({ expression: calculatorExpressionValue.trim(), result: displayResult, note: '' }); // Store original-looking expression and add note property
              renderCalculatorHistory();
              saveAllData(); // 統合保存システムで保存
              console.log('🧮 計算結果を履歴に保存:', calculatorExpressionValue.trim(), '=', displayResult);

              // Reset for next calculation
              calculatorExpressionValue = ''; // Clear the expression used for calculation
              calculatorCurrentInput = Number.isFinite(result) ? result.toString() : ''; // Result becomes start of next input display (if finite)
              expressionDisplay.value = ''; // Clear the top expression display
              justCalculated = true; // Set flag indicating calculation was just performed

          } catch (error) {
            // Display specific math errors or a general error
            display.value = error.message.startsWith('Math Error') || error.message.startsWith('Syntax Error') || error.message.includes('Invalid characters') ? error.message : 'Error';
            console.error('Calculator Error:', error); // Log detailed error
            expressionDisplay.value = calculatorExpressionValue; // Show the expression that caused error
            calculatorExpressionValue = ''; // Clear internal expression value
            calculatorCurrentInput = '';
            justCalculated = false; // Reset flag on error
          }
        }
        // Other buttons (EXP, nCr, SHIFT, ALPHA, MODE) - Not implemented
        else {
            console.warn('Functionality not implemented for:', value);
        }
      }

      function renderCalculatorHistory() {
          const historyDiv = document.getElementById('calculator-history');
          if (!historyDiv) return;
          historyDiv.innerHTML = ''; // Clear existing history
          const historyLength = calculatorHistory.length; // Get total length before slicing
          calculatorHistory.slice(-10).reverse().forEach((entry, loopIndex) => { // Show last 10 entries, newest first
              const originalIndex = historyLength - 1 - loopIndex; // Calculate the index in the original array
              const entryDiv = document.createElement('div');
              // Use flex layout for one line display
              entryDiv.className = 'p-2 border-b border-gray-200 flex items-center gap-2 text-xs';
              entryDiv.innerHTML = `
                  <input type="text"
                         placeholder="メモ..."
                         value="${entry.note || ''}"
                         oninput="updateCalculatorHistoryNote(${originalIndex}, this.value)"
                         class="flex-grow border border-gray-200 rounded px-1 py-0.5 focus:outline-none focus:border-gray-400 min-w-0" 
                         style="flex-basis: 30%;"> <!-- Adjust basis as needed -->
                  <div class="text-gray-500 text-right truncate min-w-0" style="flex-basis: 40%;">
                      ${entry.expression} =
                  </div>
                  <div class="font-semibold text-right truncate min-w-0" style="flex-basis: 30%;">
                      ${entry.result}
                  </div>
              `;
              historyDiv.appendChild(entryDiv);
          });
      }

      // ★★★ 新しい関数: 計算履歴のメモを更新 ★★★
      function updateCalculatorHistoryNote(index, note) {
          if (index >= 0 && index < calculatorHistory.length) {
              calculatorHistory[index].note = note;
              saveAllData(); // 統合保存システムで保存
              console.log('🧮 計算履歴メモを保存:', index, note);
              // ここで localStorage などに永続化することも可能
              // localStorage.setItem('calculatorHistory', JSON.stringify(calculatorHistory));
          }
      }
        // --- ▲▲▲ 関数電卓の関数 ▲▲▲ ---

        // 関数電卓初期化関数
        function initializeCalculator() {
          const display = document.getElementById('calculator-display');
          const expressionDisplay = document.getElementById('calculator-expression');
          
          if (display && expressionDisplay) {
            display.value = '0';
            expressionDisplay.value = '';
            calculatorCurrentInput = '';
            calculatorExpressionValue = '';
            justCalculated = false;
            renderCalculatorHistory();
          }
        }

      // --- ▼▼▼ カレンダー機能の関数 ▼▼▼ ---
      let currentMonth = new Date();

      // カレンダーを初期化する関数
      function initializeCalendar() {
          renderCalendar(currentMonth);
          
          // 前月ボタンのイベントリスナー
          document.getElementById('prev-month').addEventListener('click', function() {
              currentMonth.setMonth(currentMonth.getMonth() - 1);
              renderCalendar(currentMonth);
          });
          
          // 翌月ボタンのイベントリスナー
          document.getElementById('next-month').addEventListener('click', function() {
              currentMonth.setMonth(currentMonth.getMonth() + 1);
              renderCalendar(currentMonth);
          });
      }

      // カレンダーを描画する関数
      function renderCalendar(date) {
          const year = date.getFullYear();
          const month = date.getMonth();
          
          // 月の表示を更新
          const monthNames = ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"];
          document.getElementById('current-month-display').textContent = `${year}年 ${monthNames[month]}`;
          
          // カレンダーグリッドをクリア
          const calendarGrid = document.getElementById('calendar-grid');
          calendarGrid.innerHTML = '';
          
          // 月の最初の日と最後の日を取得
          const firstDay = new Date(year, month, 1);
          const lastDay = new Date(year, month + 1, 0);
          
          // 月の最初の日の曜日（0: 日曜日, 1: 月曜日, ..., 6: 土曜日）
          const firstDayOfWeek = firstDay.getDay();
          
          // 前月の日を追加
          for (let i = 0; i < firstDayOfWeek; i++) {
              const prevMonthDay = new Date(year, month, -i);
              const dayElement = document.createElement('div');
              dayElement.className = 'text-center text-xs text-gray-300 p-2 border border-gray-100 rounded';
              dayElement.textContent = prevMonthDay.getDate();
              calendarGrid.prepend(dayElement);
          }
          
          // 当月の日を追加
          for (let i = 1; i <= lastDay.getDate(); i++) {
              const dayElement = document.createElement('div');
              const currentDate = new Date(year, month, i);
              const isToday = isSameDay(currentDate, new Date());
              
              // スタイルの適用
              let className = 'text-center text-xs p-2 border border-gray-100 rounded cursor-pointer';
              if (isToday) {
                  className += ' bg-blue-100 border-blue-300';
              } else {
                  className += ' hover:bg-gray-100';
              }
              
              // 土日のスタイル
              const dayOfWeek = new Date(year, month, i).getDay();
              if (dayOfWeek === 0) { // 日曜日
                  className += ' text-red-500';
              } else if (dayOfWeek === 6) { // 土曜日
                  className += ' text-blue-500';
              } else {
                  className += ' text-gray-700';
              }
              
              dayElement.className = className;
              dayElement.textContent = i;
              calendarGrid.appendChild(dayElement);
          }
          
          // グリッドを7の倍数にするために必要な翌月の日を追加
          const totalDaysAdded = firstDayOfWeek + lastDay.getDate();
          const remainingCells = 7 - (totalDaysAdded % 7);
          if (remainingCells < 7) {
              for (let i = 1; i <= remainingCells; i++) {
                  const dayElement = document.createElement('div');
                  dayElement.className = 'text-center text-xs text-gray-300 p-2 border border-gray-100 rounded';
                  dayElement.textContent = i;
                  calendarGrid.appendChild(dayElement);
              }
          }
      }

      // 同じ日付かどうかをチェックする関数
      function isSameDay(date1, date2) {
          return date1.getFullYear() === date2.getFullYear() &&
                 date1.getMonth() === date2.getMonth() &&
                 date1.getDate() === date2.getDate();
      }
      // --- ▲▲▲ カレンダー機能の関数 ▲▲▲ ---

      // --- ▼▼▼ カレンダー機能拡張 ▼▼▼ ---
      document.addEventListener('DOMContentLoaded', function() {
        // ★★★ ここに統合保存システム初期化を追加 ★★★
        // 統合保存システム初期化（カレンダー用）
        loadAllData(); // データ読み込み
        const calendarSection = document.getElementById('calendar-area');
        if (!calendarSection) return;

        const calendarGrid = document.getElementById('calendar-grid');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const todayBtn = document.getElementById('today-btn');
        const eventModal = document.getElementById('event-modal');
        const eventForm = document.getElementById('event-form');
        const modalTitle = document.getElementById('modal-title');
        const eventIdInput = document.getElementById('event-id');
        const eventDateInput = document.getElementById('event-date');
        const eventTitleInput = document.getElementById('event-title');
        const eventCategoryInput = document.getElementById('event-category');
        const eventDescriptionInput = document.getElementById('event-description');
        const deleteEventBtn = document.getElementById('delete-event');
        const eventStartHourSelect = document.getElementById('event-start-hour');
        const eventStartMinuteSelect = document.getElementById('event-start-minute');
        const eventEndHourSelect = document.getElementById('event-end-hour');
        const eventEndMinuteSelect = document.getElementById('event-end-minute');
        const cancelEventBtn = document.getElementById('cancel-event');
        const prevDayViewBtn = document.getElementById('prev-day-view');
        const nextDayViewBtn = document.getElementById('next-day-view');
        const todoInput = document.getElementById('todo-input');
        const addTodoBtn = document.getElementById('add-todo-btn');
        const todoListUl = document.getElementById('todo-list');
        
        let currentDate = new Date();
        let viewingDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        let events = JSON.parse(localStorage.getItem('calendarEvents')) || [];
        let todos = JSON.parse(localStorage.getItem('todos')) || [];
        let categories = [];

        // カテゴリ初期化
        function initializeCategories() {
          const storedCategories = localStorage.getItem('calendarCategories');
          if (storedCategories) {
            categories = JSON.parse(storedCategories);
          } else {
            categories = [
              { id: 'cat-1', name: '個人', color: '#fffae6', borderColor: '#ffcc00', isDeletable: true },
              { id: 'cat-2', name: '仕事', color: '#e6f7ff', borderColor: '#1890ff', isDeletable: true },
              { id: 'cat-3', name: '重要', color: '#f6ffed', borderColor: '#52c41a', isDeletable: true },
              { id: 'cat-4', name: 'その他', color: '#fff0f6', borderColor: '#eb2f96', isDeletable: false }
            ];
            saveCategories();
          }
        }

        function saveCategories() {
          localStorage.setItem('calendarCategories', JSON.stringify(categories));
        }

        function findCategoryById(id) {
          return categories.find(cat => cat.id === id);
        }
        
        const dayNames = ['月', '火', '水', '木', '金', '土', '日'];
        const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
        
        function renderCalendar() {
          const firstDay = new Date(currentYear, currentMonth, 1);
          const lastDay = new Date(currentYear, currentMonth + 1, 0);
          calendarGrid.innerHTML = '';
          
          // 曜日ヘッダーを追加
          dayNames.forEach((day, index) => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'day-header';
            // 土曜日と日曜日のスタイルを適用
            if (index === 5) {
              dayHeader.classList.add('saturday-header');
            } else if (index === 6) {
              dayHeader.classList.add('sunday-header');
            }
            dayHeader.textContent = day;
            calendarGrid.appendChild(dayHeader);
          });
          
          // 月の最初の日の曜日を取得（0: 日曜日, 1: 月曜日, ...）
          // 月曜始まりのため調整
          let startingDay = firstDay.getDay() - 1;
          if (startingDay === -1) startingDay = 6; // 日曜日の場合
          
          // 前月の日を追加
          const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();
          for (let i = 0; i < startingDay; i++) {
            const date = new Date(currentYear, currentMonth - 1, prevMonthLastDay - startingDay + i + 1);
            const dayCell = createDayCell(prevMonthLastDay - startingDay + i + 1, true, date);
            calendarGrid.appendChild(dayCell);
          }
          
          // 当月の日を追加
          for (let day = 1; day <= lastDay.getDate(); day++) {
            const date = new Date(currentYear, currentMonth, day);
            const dayCell = createDayCell(day, false, date);
            calendarGrid.appendChild(dayCell);
          }
          
          // 翌月の日を追加
          const totalCells = startingDay + lastDay.getDate();
          const remainingCells = 7 - (totalCells % 7);
          if (remainingCells < 7) {
            for (let day = 1; day <= remainingCells; day++) {
              const date = new Date(currentYear, currentMonth + 1, day);
              const dayCell = createDayCell(day, true, date);
              calendarGrid.appendChild(dayCell);
            }
          }
          
          document.getElementById('current-month-year').textContent = `${currentYear}年${currentMonth + 1}月`;
        }
        
        function createDayCell(day, isOtherMonth, date) {
          const dayCell = document.createElement('div');
          dayCell.className = 'day-cell';
          if (isOtherMonth) {
            dayCell.classList.add('other-month');
          }
          
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const cellDate = new Date(date);
          cellDate.setHours(0, 0, 0, 0);
          
          if (cellDate.getTime() === today.getTime()) {
            dayCell.classList.add('today');
          } else if (!isOtherMonth && cellDate < today) {
            dayCell.classList.add('past-day');
          }
          
          const dayNumber = document.createElement('div');
          dayNumber.className = 'day-number';
          dayNumber.textContent = day;
          
          // 曜日に応じたスタイルを適用
          const dayOfWeek = cellDate.getDay();
          if (dayOfWeek === 0) { // 日曜日
            dayNumber.classList.add('sunday');
          } else if (dayOfWeek === 6) { // 土曜日
            dayNumber.classList.add('saturday');
          }
          
          dayCell.appendChild(dayNumber);
          
          // イベントを追加
          const eventList = document.createElement('div');
          eventList.className = 'event-list';
          const dateStr = formatDate(date);
          const dayEvents = events.filter(event => event.date === dateStr);
          
          if (dayEvents.length > 0) {
            const eventsToShow = dayEvents.slice(0, 2);
            eventsToShow.forEach(event => {
              const category = findCategoryById(event.category) || { name: '未分類', color: '#eee', borderColor: '#ccc' };
              const eventItem = document.createElement('div');
              eventItem.className = 'event-item';
              eventItem.style.backgroundColor = category.color;
              eventItem.style.borderLeft = `3px solid ${category.borderColor}`;
              
              let eventText = '';
              if (event.startTime) {
                eventText += event.startTime + ' ';
              }
              eventText += event.title;
              eventItem.textContent = eventText;
              eventItem.setAttribute('data-event-id', event.id);
              
              eventItem.addEventListener('click', function(e) {
                e.stopPropagation();
                openEditEventModal(event);
              });
              
              eventList.appendChild(eventItem);
            });
            
            if (dayEvents.length > 2) {
              const eventCount = document.createElement('div');
              eventCount.className = 'event-count';
              eventCount.textContent = `+${dayEvents.length - 2}`;
              dayCell.appendChild(eventCount);
            }
          }
          
          dayCell.appendChild(eventList);
          
          dayCell.addEventListener('dblclick', function() {
            viewingDate = new Date(date);
            renderTodayView(viewingDate);
            openAddEventModal(date);
          });
          
          return dayCell;
        }
        
        function formatDate(date) {
          return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }
        
        function generateHourOptions() {
          const options = [];
          for (let h = 0; h < 24; h++) {
            options.push(String(h).padStart(2, '0'));
          }
          return options;
        }
        
        function generateMinuteOptions() {
          return ['00', '15', '30', '45'];
        }
        
        function populateSelectWithOptions(selectElement, options) {
          selectElement.innerHTML = '';
          const emptyOption = document.createElement('option');
          emptyOption.value = '';
          emptyOption.textContent = '--';
          selectElement.appendChild(emptyOption);
          
          options.forEach(value => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            selectElement.appendChild(option);
          });
        }
        
        function populateCategoryDropdown() {
          eventCategoryInput.innerHTML = '';
          categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.name;
            option.style.backgroundColor = cat.color;
            eventCategoryInput.appendChild(option);
          });
        }
        
        function openAddEventModal(date) {
          modalTitle.textContent = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日 イベントを追加`;
          eventIdInput.value = '';
          eventDateInput.value = formatDate(date);
          eventTitleInput.value = '';
          
          const hourOptions = generateHourOptions();
          const minuteOptions = generateMinuteOptions();
          
          populateSelectWithOptions(eventStartHourSelect, hourOptions);
          populateSelectWithOptions(eventStartMinuteSelect, minuteOptions);
          populateSelectWithOptions(eventEndHourSelect, hourOptions);
          populateSelectWithOptions(eventEndMinuteSelect, minuteOptions);
          
          populateCategoryDropdown();
          eventCategoryInput.value = categories[0]?.id || '';
          eventDescriptionInput.value = '';
          
          deleteEventBtn.style.display = 'none';
          eventModal.style.display = 'flex';
        }
        
        function openEditEventModal(event) {
          modalTitle.textContent = 'イベントを編集';
          eventIdInput.value = event.id;
          eventDateInput.value = event.date;
          eventTitleInput.value = event.title;
          
          const hourOptions = generateHourOptions();
          const minuteOptions = generateMinuteOptions();
          
          populateSelectWithOptions(eventStartHourSelect, hourOptions);
          populateSelectWithOptions(eventStartMinuteSelect, minuteOptions);
          populateSelectWithOptions(eventEndHourSelect, hourOptions);
          populateSelectWithOptions(eventEndMinuteSelect, minuteOptions);
          
          if (event.startTime && event.startTime.includes(':')) {
            const [startH, startM] = event.startTime.split(':');
            eventStartHourSelect.value = startH;
            eventStartMinuteSelect.value = startM;
          }
          
          if (event.endTime && event.endTime.includes(':')) {
            const [endH, endM] = event.endTime.split(':');
            eventEndHourSelect.value = endH;
            eventEndMinuteSelect.value = endM;
          }
          
          populateCategoryDropdown();
          eventCategoryInput.value = event.category || '';
          eventDescriptionInput.value = event.description || '';
          
          deleteEventBtn.style.display = 'block';
          eventModal.style.display = 'flex';
        }
        
        function saveEvent(e) {
          e.preventDefault();
          
          const eventData = {
            id: eventIdInput.value || Date.now().toString(),
            date: eventDateInput.value,
            title: eventTitleInput.value,
            startTime: (eventStartHourSelect.value && eventStartMinuteSelect.value)
                        ? `${eventStartHourSelect.value}:${eventStartMinuteSelect.value}`
                        : '',
            endTime: (eventEndHourSelect.value && eventEndMinuteSelect.value)
                        ? `${eventEndHourSelect.value}:${eventEndMinuteSelect.value}`
                        : '',
            category: eventCategoryInput.value,
            description: eventDescriptionInput.value
          };
          
          if (!eventData.title) {
            alert('タイトルを入力してください。');
            return;
          }
          
          if (eventIdInput.value) {
            events = events.map(event => event.id === eventData.id ? eventData : event);
          } else {
            events.push(eventData);
          }
          
          localStorage.setItem('calendarEvents', JSON.stringify(events));
          closeModal();
          renderCalendar();
          renderTodayView(viewingDate);
        }
        
        function deleteEvent() {
          const eventId = eventIdInput.value;
          if (eventId && confirm('このイベントを削除してもよろしいですか？')) {
            events = events.filter(event => event.id !== eventId);
            localStorage.setItem('calendarEvents', JSON.stringify(events));
            closeModal();
            renderCalendar();
            renderTodayView(viewingDate);
          }
        }
        
        function closeModal() {
          eventModal.style.display = 'none';
        }
        
        function goToPrevMonth() {
          currentMonth--;
          if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
          }
          renderCalendar();
        }
        
        function goToNextMonth() {
          currentMonth++;
          if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
          }
          renderCalendar();
        }
        
        function goToToday() {
          const today = new Date();
          currentMonth = today.getMonth();
          currentYear = today.getFullYear();
          viewingDate = new Date();
          renderCalendar();
          renderTodayView(viewingDate);
        }
        
        function renderTodayView(dateToRender) {
          const todayDateElem = document.getElementById('today-date');
          const todayEventsElem = document.getElementById('today-events');
          
          const dateStr = formatDate(dateToRender);
          const dayOfWeek = dayNames[dateToRender.getDay() === 0 ? 6 : dateToRender.getDay() - 1];
          todayDateElem.textContent = `${dateToRender.getFullYear()}年${dateToRender.getMonth() + 1}月${dateToRender.getDate()}日(${dayOfWeek})`;
          
          const eventsForDay = events
            .filter(event => event.date === dateStr)
            .sort((a, b) => {
              if (a.startTime && b.startTime) return a.startTime.localeCompare(b.startTime);
              if (a.startTime) return -1;
              if (b.startTime) return 1;
              return 0;
            });
          
          todayEventsElem.innerHTML = '';
          
          if (eventsForDay.length === 0) {
            todayEventsElem.innerHTML = '<li class="no-events">本日の予定はありません</li>';
            return;
          }
          
          eventsForDay.forEach(event => {
            const category = findCategoryById(event.category) || { name: '未分類', color: '#eee', borderColor: '#ccc' };
            const li = document.createElement('li');
            li.style.backgroundColor = category.color; // 背景色はカテゴリ依存のまま
            li.style.borderLeft = `3px solid ${category.borderColor}`; // 左ボーダーもカテゴリ依存
            li.setAttribute('data-event-id', event.id);
            li.style.display = 'block'; // 表示形式をブロックに変更
            li.style.padding = '4px 8px'; // 適度なパディングを追加
            li.style.marginBottom = '4px'; // リスト間のマージン
            li.style.cursor = 'pointer'; // クリック可能を示す
            li.style.borderRadius = '3px'; // 角を少し丸める

            // 時間表示用 Div
            const timeDiv = document.createElement('div');
            timeDiv.style.whiteSpace = 'nowrap';
            timeDiv.style.overflow = 'hidden';
            timeDiv.style.textOverflow = 'ellipsis';
            let timeText = '';
            if (event.startTime) {
              timeText += event.startTime;
              if (event.endTime) {
                timeText += ` - ${event.endTime}`;
              }
            }
            timeDiv.textContent = timeText || '終日'; // 時間がない場合は「終日」
            timeDiv.style.fontSize = '11px';
            timeDiv.style.color = 'rgba(0, 0, 0, 0.7)'; // 少し濃いグレー

            // タイトル表示用 Div
            const titleDiv = document.createElement('div');
            titleDiv.style.whiteSpace = 'nowrap';
            titleDiv.style.overflow = 'hidden';
            titleDiv.style.textOverflow = 'ellipsis';
            titleDiv.textContent = event.title;
            titleDiv.style.fontWeight = 'bold';
            titleDiv.style.fontSize = '13px'; // 少し大きく
            titleDiv.style.margin = '2px 0';

            // 詳細表示用 Div
            const descriptionDiv = document.createElement('div');
            descriptionDiv.style.whiteSpace = 'nowrap';
            descriptionDiv.style.overflow = 'hidden';
            descriptionDiv.style.textOverflow = 'ellipsis';
            descriptionDiv.textContent = event.description || '\u00A0'; // 詳細がない場合はノーブレークスペース
            descriptionDiv.style.fontSize = '11px';
            descriptionDiv.style.color = 'rgba(0, 0, 0, 0.6)'; // 少し薄いグレー

            // li 要素に各 Div を追加
            li.appendChild(timeDiv);
            li.appendChild(titleDiv);
            li.appendChild(descriptionDiv);

            li.addEventListener('click', () => {
              openEditEventModal(event);
            });

            todayEventsElem.appendChild(li);
          });
          
        }
        
        function goToPrevDayView() {
          viewingDate.setDate(viewingDate.getDate() - 1);
          renderTodayView(viewingDate);
        }
        
        function goToNextDayView() {
          viewingDate.setDate(viewingDate.getDate() + 1);
          renderTodayView(viewingDate);
        }
        
        function renderTodoList() {
          todoListUl.innerHTML = '';
          
          if (todos.length === 0) {
            todoListUl.innerHTML = '<li class="no-events">タスクはありません</li>';
            return;
          }
          
          todos.forEach((todo, index) => {
            const li = document.createElement('li');
            li.setAttribute('data-index', index);
            
            const textSpan = document.createElement('span');
            textSpan.className = 'todo-text';
            textSpan.textContent = todo.text;
            if (todo.completed) {
              textSpan.classList.add('completed');
            }
            textSpan.addEventListener('click', () => toggleTodoComplete(index));
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'todo-actions';
            
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'toggle-btn';
            toggleBtn.innerHTML = todo.completed ? '&#x21B6;' : '&#x2714;';
            toggleBtn.title = todo.completed ? '未完了に戻す' : '完了にする';
            if (todo.completed) toggleBtn.classList.add('completed');
            toggleBtn.addEventListener('click', () => toggleTodoComplete(index));
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = '&#x1F5D1;';
            deleteBtn.title = '削除';
            deleteBtn.addEventListener('click', () => deleteTodo(index));
            
            actionsDiv.appendChild(toggleBtn);
            actionsDiv.appendChild(deleteBtn);
            
            li.appendChild(textSpan);
            li.appendChild(actionsDiv);
            
            todoListUl.appendChild(li);
          });
          
          saveTodos();
        }
        
        function addTodo() {
          const text = todoInput.value.trim();
          if (text === '') return;
          
          todos.push({ text: text, completed: false });
          todoInput.value = '';
          renderTodoList();
        }
        
        function toggleTodoComplete(index) {
          if (todos[index]) {
            todos[index].completed = !todos[index].completed;
            renderTodoList();
          }
        }
        
        function deleteTodo(index) {
          if (confirm('このTodoを削除しますか？')) {
            todos.splice(index, 1);
            saveAllData(); // 統合保存システムで保存
            console.log('🗑️ ユーザータスクを削除して保存');
            renderTodoList();
          }
        }
        
        function saveTodos() {
          localStorage.setItem('todos', JSON.stringify(todos));
        }
        
        // イベントリスナーの設定
        if (prevMonthBtn) prevMonthBtn.addEventListener('click', goToPrevMonth);
        if (nextMonthBtn) nextMonthBtn.addEventListener('click', goToNextMonth);
        if (todayBtn) todayBtn.addEventListener('click', goToToday);
        if (eventForm) eventForm.addEventListener('submit', saveEvent);
        if (deleteEventBtn) deleteEventBtn.addEventListener('click', deleteEvent);
        if (cancelEventBtn) cancelEventBtn.addEventListener('click', closeModal);
        if (prevDayViewBtn) prevDayViewBtn.addEventListener('click', goToPrevDayView);
        if (nextDayViewBtn) nextDayViewBtn.addEventListener('click', goToNextDayView);
        if (eventModal) eventModal.addEventListener('click', function(e) {
          if (e.target === eventModal) {
            closeModal();
          }
        });
        if (addTodoBtn) addTodoBtn.addEventListener('click', addTodo);
        if (todoInput) todoInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            addTodo();
          }
        });

        // ↓↓↓ ここからカテゴリ管理のイベントリスナーを追加 ↓↓↓
        if (addCategoryBtn) {
            addCategoryBtn.addEventListener('click', addCategory);
        }
        if (categoryManagerHeader) { // ヘッダー全体をクリック可能にする場合
            categoryManagerHeader.addEventListener('click', () => {
            categoryManagerDiv.classList.toggle('open'); // openクラスを付け外しして表示/非表示を切り替える
      　});
        }
        // ↑↑↑ ここまでカテゴリ管理のイベントリスナーを追加 ↑↑↑
        
        // 初期化 (このブロック全体を置き換える)
        initializeCategories();     // 1. カテゴリデータを読み込む (localStorage or デフォルト)
        // initializeSelectors();      // 2. 年月セレクタ初期化 (userpage.html には不要かも？あれば残す)
        populateCategoryDropdown(); // 3. イベント編集モーダルのカテゴリ選択肢を設定 (カテゴリデータが必要)
        initializeColorPalette();   // 4. カテゴリ追加用のカラーパレットを作成
        renderCategoryList();       // 5. カテゴリ管理セクションにリストを表示 (カテゴリデータが必要)
        renderCalendar();           // 6. カレンダー本体を描画
        renderTodayView(viewingDate); // 7. 「本日の予定」欄を描画 (カテゴリデータが必要)
        renderTodoList();           // 8. Todoリストを描画
        initializeMemoTool(); // メモツール初期化を呼び出す
      }); 

      // --- ▼▼▼ カレンダー機能拡張 ▼▼▼ ---
      // ↓↓↓ ここに追加 ↓↓↓
      const paletteColors = [
          '#ffadad', '#ffd6a5', '#fdffb6', '#caffbf', '#9bf6ff', '#a0c4ff', '#bdb2ff', '#ffc6ff',
          '#ff8a80', '#ffb480', '#ffff80', '#bfff80', '#80ffea', '#80b3ff', '#9f80ff', '#ff80ed'
      ];
      let categories = []; // 全カテゴリを格納
      let selectedColor = null; // カテゴリ追加時に選択された色
      // ↑↑↑ ここまで追加 ↑↑↑

      document.addEventListener('DOMContentLoaded', function() {

      // 統合保存システム初期化
      console.log('🚀 統合保存システム初期化開始');
      loadAllData(); // 統合データ読み込み
      updateLastSavedDisplay(); // 最終保存時刻表示
      startAutoSave(5); // 5分間隔で自動保存開始
            // 各機能の画面を更新（保存されたデータを表示）
            if (typeof renderHoukis === 'function') {
          renderHoukis();
          console.log('📚 My法規を再表示');
      }
      if (typeof renderContacts === 'function') {
          renderContacts();
          console.log('👤 連絡先を再表示');
      }
      if (typeof renderTodos === 'function') {
          renderTodos();
          console.log('✅ ユーザータスクを再表示');
      }
      if (typeof renderTeamTodos === 'function') {
          renderTeamTodos();
          console.log('👥 チームタスクを再表示');
      }
      if (typeof updateTeamProjectDropdown === 'function') {
          updateTeamProjectDropdown();
          console.log('🔄 チームプロジェクトドロップダウンを更新');
      }
      if (typeof updateProjectDropdown === 'function') {
          updateProjectDropdown();
          console.log('🔄 ユーザープロジェクトドロップダウンを更新');
      }
      if (typeof renderMemoList === 'function') {
          renderMemoList();
          console.log('📝 メモリストを再表示');
      }
      if (typeof renderCalendar === 'function') {
          renderCalendar();
          console.log('📅 カレンダーを再表示');
      }

      console.log('✅ 統合保存システム初期化完了');
      });

      // --- ▲▲▲ カレンダー機能拡張 ▲▲▲ ---
      // --- ▼▼▼ メモ機能 JavaScript ▼▼▼ ---

// --- Helper Functions ---
function generateMemoId() {
  return Date.now().toString() + Math.random().toString(36).substring(2, 9);
}

// --- Core Memo Data Management ---
let memos = [];
let currentMemoId = null;

function loadMemos() {
  const storedMemos = localStorage.getItem('userMemos');
  if (storedMemos) {
    try {
      memos = JSON.parse(storedMemos);
      if (!Array.isArray(memos)) {
        console.warn("Invalid memo data in localStorage, resetting.");
        memos = [];
      }
      memos = memos.map(m => ({
          id: m.id || generateMemoId(),
          title: m.title || '',
          content: m.content || '',
          category: m.category || '',
          tags: Array.isArray(m.tags) ? m.tags : [],
          createdAt: m.createdAt || Date.now(),
          updatedAt: m.updatedAt || Date.now()
      }));
    } catch (e) {
      console.error("Error loading or parsing memos from localStorage:", e);
      memos = [];
    }
  } else {
    memos = [];
  }
  memos.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
}

function saveMemos() {
  try {
    localStorage.setItem('userMemos', JSON.stringify(memos));
    console.log("Memos saved to localStorage.");
  } catch (e) {
    console.error("Error saving memos to localStorage:", e);
    updateSaveStatus('メモの保存に失敗しました。', 5000);
  }
}

// --- DOM Element References ---
let memoListContainer, memoTitleInput, memoContentEditor, memoCategoryInput, memoTagsInput;
let deleteMemoButton, manualSaveButton, createNewMemoButton, memoSearchInput;
let memoCategoryFilter, memoTagFilter, memoCharCountSpan, memoSaveStatusSpan;

// --- UI Rendering Functions ---
function renderMemoList() {
  if (!memoListContainer) return;
  memoListContainer.innerHTML = '';

  const searchTerm = memoSearchInput ? memoSearchInput.value.toLowerCase() : '';
  const categoryFilterValue = memoCategoryFilter ? memoCategoryFilter.value : '';
  const tagFilterValue = memoTagFilter ? memoTagFilter.value : '';

  const filteredMemos = memos.filter(memo => {
      const searchContent = `${memo.title || ''} ${memo.content ? memo.content.replace(/<[^>]*>/g, ' ') : ''} ${memo.category || ''} ${(memo.tags || []).join(' ')}`.toLowerCase();
      const matchesSearch = !searchTerm || searchContent.includes(searchTerm);
      const matchesCategory = !categoryFilterValue || (memo.category === categoryFilterValue);
      const matchesTag = !tagFilterValue || (memo.tags && memo.tags.includes(tagFilterValue));
      return matchesSearch && matchesCategory && matchesTag;
  });

  if (filteredMemos.length === 0) {
    memoListContainer.innerHTML = '<p class="text-xs text-gray-500 px-2 py-4 text-center">該当するメモはありません。</p>';
  } else {
    filteredMemos.forEach(memo => {
      const listItem = document.createElement('div');
      listItem.classList.add('p-2', 'border-b', 'border-gray-100', 'cursor-pointer', 'hover:bg-gray-100', 'rounded', 'transition');
      listItem.dataset.memoId = memo.id;
      listItem.innerHTML = `
          <h4 class="text-xs font-medium truncate mb-1">${memo.title || '無題のメモ'}</h4>
          <p class="text-[10px] text-gray-500 truncate mb-1">${new Date(memo.updatedAt || memo.createdAt).toLocaleString('ja-JP', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
          <div class="flex flex-wrap gap-1">
              ${memo.category ? `<span class="text-[9px] bg-gray-200 text-gray-700 px-1.5 py-0.5 rounded">${memo.category}</span>` : ''}
              ${memo.tags && memo.tags.length > 0 ? memo.tags.map(tag => `<span class="text-[9px] bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded">${tag}</span>`).join(' ') : ''}
          </div>
      `;
      if (memo.id === currentMemoId) {
        listItem.classList.add('bg-blue-50');
      }
      memoListContainer.appendChild(listItem);
    });
  }
  updateFilters();
}

function displayMemo(memoId) {
  const memo = memos.find(m => m.id === memoId);
  if (!memo || !memoTitleInput || !memoContentEditor || !memoCategoryInput || !memoTagsInput) return;

  currentMemoId = memo.id;
  memoTitleInput.value = memo.title || '';
  memoContentEditor.innerHTML = memo.content || '';
  memoCategoryInput.value = memo.category || '';
  memoTagsInput.value = memo.tags ? memo.tags.join(', ') : '';

  updateCharCount();
  updateSaveStatus(`最終更新: ${new Date(memo.updatedAt || memo.createdAt).toLocaleString('ja-JP')}`, 0);
  if (deleteMemoButton) deleteMemoButton.style.display = 'inline-flex';
  renderMemoList(); // Re-render list to update highlight
  
  // タイトルにフォーカスを当てて即時編集可能に
  if (memoTitleInput) memoTitleInput.focus();


}

function clearEditor() {
    currentMemoId = null;
    if (memoTitleInput) memoTitleInput.value = '';
    if (memoContentEditor) memoContentEditor.innerHTML = '';
    if (memoCategoryInput) memoCategoryInput.value = '';
    if (memoTagsInput) memoTagsInput.value = '';
    if (deleteMemoButton) deleteMemoButton.style.display = 'none';
    if (memoSaveStatusSpan) memoSaveStatusSpan.textContent = '新しいメモ';
    updateCharCount();
    renderMemoList(); // Re-render list to remove highlight
}

function updateFilters() {
    if (!memoCategoryFilter || !memoTagFilter) return;
    const categories = [...new Set(memos.map(m => m.category).filter(Boolean))].sort();
    const tags = [...new Set(memos.flatMap(m => m.tags || []).filter(Boolean))].sort();
    const currentCategory = memoCategoryFilter.value;
    const currentTag = memoTagFilter.value;
    memoCategoryFilter.innerHTML = '<option value="">すべてのカテゴリ</option>';
    categories.forEach(cat => {
        const option = document.createElement('option'); option.value = cat; option.textContent = cat; memoCategoryFilter.appendChild(option);
    });
    if (categories.includes(currentCategory)) { memoCategoryFilter.value = currentCategory; } else { memoCategoryFilter.value = ""; }
    memoTagFilter.innerHTML = '<option value="">すべてのタグ</option>';
    tags.forEach(tag => {
        const option = document.createElement('option'); option.value = tag; option.textContent = tag; memoTagFilter.appendChild(option);
    });
    if (tags.includes(currentTag)) { memoTagFilter.value = currentTag; } else { memoTagFilter.value = ""; }
}

function updateCharCount() {
    if (memoContentEditor && memoCharCountSpan) {
        const text = memoContentEditor.innerText || '';
        memoCharCountSpan.textContent = `${text.length} 文字`;
    }
}

function updateSaveStatus(message, duration = 2000) {
    if (memoSaveStatusSpan) {
        memoSaveStatusSpan.textContent = message;
        if (duration > 0) {
            const messageToClear = message;
          setTimeout(() => {
                if (memoSaveStatusSpan.textContent === messageToClear) {
                   const currentMemo = memos.find(m => m.id === currentMemoId);
                   if (currentMemo) {
                       updateSaveStatus(`最終更新: ${new Date(currentMemo.updatedAt || currentMemo.createdAt).toLocaleString('ja-JP')}`, 0);
                   } else {
                       updateSaveStatus('新しいメモ', 0);
                   }
                }
            }, duration);
        }
    }
}

// --- Action Functions ---
function createNewMemo() {
  clearEditor();
  if (memoTitleInput) memoTitleInput.focus();
  updateSaveStatus('新規メモ作成中...', 0);
}

function saveMemo() {
  if (!memoTitleInput || !memoContentEditor || !memoCategoryInput || !memoTagsInput) return;

  const title = memoTitleInput.value.trim();
  const content = memoContentEditor.innerHTML;
  const category = memoCategoryInput.value.trim();
  const tags = memoTagsInput.value.split(',').map(tag => tag.trim()).filter(Boolean);
  const now = Date.now();

  if (!currentMemoId && !title && memoContentEditor.innerText.trim() === '') {
      updateSaveStatus('内容が入力されていないため保存しません。', 3000);
      return;
  }

  let memo;
  if (currentMemoId) {
      memo = memos.find(m => m.id === currentMemoId);
  }

  if (memo) {
      memo.title = title;
      memo.content = content;
      memo.category = category;
      memo.tags = tags;
      memo.updatedAt = now;
  } else {
      memo = {
          id: generateMemoId(),
          title: title,
          content: content,
          category: category,
          tags: tags,
          createdAt: now,
          updatedAt: now
      };
      memos.push(memo);
      currentMemoId = memo.id;
  }

  memos.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
  saveMemos();
  renderMemoList();
  displayMemo(currentMemoId);
  updateSaveStatus('保存しました！', 2000);
}

function deleteMemo() {
  if (!currentMemoId) return;
  const memoToDelete = memos.find(m => m.id === currentMemoId);
  if (!memoToDelete) return;

  const titleToDelete = memoToDelete.title || 'このメモ';
  if (confirm(`「${titleToDelete}」を削除してもよろしいですか？`)) {
    memos = memos.filter(m => m.id !== currentMemoId);
    saveMemos();
    currentMemoId = null;
    clearEditor();
    updateSaveStatus('メモを削除しました。', 3000);
  }
}

function formatDoc(command, value = null) {
  if (!memoContentEditor) return;
  memoContentEditor.focus();
  try {
      document.execCommand(command, false, value);
  } catch (e) {
      console.error("Error executing format command:", command, e);
  }
  memoContentEditor.focus();
  updateSaveStatus('編集中...', 0);
}
// --- Initialization Function ---
function initializeMemoTool() {
  console.log("メモツールを初期化中...");
  
  // Get element references
  memoListContainer = document.getElementById('memo-list');
  memoTitleInput = document.getElementById('memo-title');
  memoContentEditor = document.getElementById('memo-content');
  memoCategoryInput = document.getElementById('memo-category');
  memoTagsInput = document.getElementById('memo-tags');
  deleteMemoButton = document.getElementById('delete-button');
  manualSaveButton = document.getElementById('manual-save-button');
  const memoToolContentDiv = document.getElementById('memo-tool-content');
  if (memoToolContentDiv) {
      const buttonsInHeader = memoToolContentDiv.querySelector('.p-4.border-b');
      if(buttonsInHeader) {
         createNewMemoButton = buttonsInHeader.querySelector('button');
      }
  }
  memoSearchInput = document.getElementById('memo-search');
  memoCategoryFilter = document.getElementById('memo-category-filter');
  memoTagFilter = document.getElementById('memo-tag-filter');
  memoCharCountSpan = document.getElementById('memo-char-count');
  memoSaveStatusSpan = document.getElementById('memo-save-status');

  // Critical elements check
  if (!memoListContainer || !memoTitleInput || !memoContentEditor) {
      console.error("メモツールの重要な要素が見つかりません。初期化を中止します。");
      return;
  }

  // Load initial data
  loadMemos();
  renderMemoList();
  clearEditor();

  // Add event listeners
  if (memoListContainer) {
      memoListContainer.addEventListener('click', (event) => {
          const listItem = event.target.closest('div[data-memo-id]');
          if (listItem && listItem.dataset.memoId) {
              displayMemo(listItem.dataset.memoId);
          }
      });
  }
  
  if (memoSearchInput) {
      memoSearchInput.addEventListener('input', renderMemoList);
  }
  if (memoCategoryFilter) {
      memoCategoryFilter.addEventListener('change', renderMemoList);
  }
  if (memoTagFilter) {
      memoTagFilter.addEventListener('change', renderMemoList);
  }
  if (memoContentEditor) {
      memoContentEditor.addEventListener('input', () => {
          updateCharCount();
          updateSaveStatus('編集中...', 0);
      });
  // ★★★ 計算機能のためのイベントリスナーを追加（重複登録を防ぐ）★★★
     if (memoContentEditor && !memoContentEditor.hasAttribute('data-calc-listener-added')) {
        memoContentEditor.addEventListener('input', handleMemoInput);
        memoContentEditor.setAttribute('data-calc-listener-added', 'true');
  }
}
  // Buttons should already have onclick handlers in HTML
  // but ensure they're connected to our functions
  if (createNewMemoButton && !createNewMemoButton.onclick) {
      createNewMemoButton.onclick = createNewMemo;
  }
  if (manualSaveButton && !manualSaveButton.onclick) {
      manualSaveButton.onclick = saveMemo;
  }
  if (deleteMemoButton && !deleteMemoButton.onclick) {
      deleteMemoButton.onclick = deleteMemo;
  }
  
  console.log("メモツールの初期化が完了しました。");
}

// ★★★ 計算処理を行う関数を追加 ★★★
function handleMemoInput() {
  if (!memoContentEditor) return; // Ensure editor exists
  const lines = memoContentEditor.innerText.split('\n');
  let changed = false;
  const newLines = lines.map(line => {
    // 行末が '=' で、その前に計算可能な文字がある場合
    if (line.trim().endsWith('=') && line.trim().length > 1) {
      const expression = line.substring(0, line.lastIndexOf('=')).trim();
      try {
        // eval() を使って式を評価（セキュリティリスクに注意）
        const result = eval(expression);
        // 不正な値でなければ結果を追記
        if (result !== undefined && result !== null && !isNaN(result)) {
          changed = true;
          return expression + ' = ' + result;
        }
      } catch (e) {
        // 計算エラーの場合は何もしない（またはエラー表示）
        console.error("Calculation error:", e);
        return line; // 元の行を維持
      }
    }
    return line;
  });

  // 変更があった場合のみテキストエリアを更新
  if (changed) {
    const selection = window.getSelection();
    const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
    const startOffset = range ? range.startOffset : 0;
    const startContainer = range ? range.startContainer : null;

    memoContentEditor.innerText = newLines.join('\n');

    // カーソル位置の復元を試みる (簡易的な方法)
    if (startContainer && memoContentEditor.contains(startContainer)) {
        try {
          const newRange = document.createRange();
          newRange.setStart(startContainer, Math.min(startOffset, startContainer.length || 0));
          newRange.collapse(true);
          selection.removeAllRanges();
          selection.addRange(newRange);
        } catch (e) {
            console.error("Error restoring cursor position:", e);
            memoContentEditor.focus(); // Fallback to focusing the editor
        }
    } else {
        memoContentEditor.focus();
    }
  }
}

// --- ▲▲▲ メモ機能 JavaScript ▲▲▲ ---


      

      

      </script>

    <script>

</script>
</body>
  </html>